<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Skill/ASM/RISC-V/RISC-V总线和流水线">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">RISC-V 总线和流水线 | Doongz&#x27;s Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doongz.github.io/docs/Skill/ASM/RISC-V/RISC-V总线和流水线"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="RISC-V 总线和流水线 | Doongz&#x27;s Site"><meta data-rh="true" name="description" content="来源：https://www.icfedu.cn/?s=RISC-V+%E6%80%BB%E7%BA%BF%E5%92%8C%E6%B5%81%E6%B0%B4"><meta data-rh="true" property="og:description" content="来源：https://www.icfedu.cn/?s=RISC-V+%E6%80%BB%E7%BA%BF%E5%92%8C%E6%B5%81%E6%B0%B4"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://doongz.github.io/docs/Skill/ASM/RISC-V/RISC-V总线和流水线"><link data-rh="true" rel="alternate" href="https://doongz.github.io/docs/Skill/ASM/RISC-V/RISC-V总线和流水线" hreflang="en"><link data-rh="true" rel="alternate" href="https://doongz.github.io/docs/Skill/ASM/RISC-V/RISC-V总线和流水线" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Doongz&#39;s Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Doongz&#39;s Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.99c6e2a1.css">
<link rel="preload" href="/assets/js/runtime~main.f9aa80d1.js" as="script">
<link rel="preload" href="/assets/js/main.0ded408c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Home page</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Notes</a><a class="navbar__item navbar__link" href="/community/support">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Courses</a><ul class="dropdown__menu"><li><a href="https://github.com/doongz/mlc-ai" target="_blank" rel="noopener noreferrer" class="dropdown__link">Machine Learning Compilation<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/cs229" target="_blank" rel="noopener noreferrer" class="dropdown__link">Stanford CS229: Machine Learning<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/aics" target="_blank" rel="noopener noreferrer" class="dropdown__link">中国科学院 智能计算系统<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/cs50-ai" target="_blank" rel="noopener noreferrer" class="dropdown__link">Harvard CS50’s Introduction to AI with Python<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/mit-6.824" target="_blank" rel="noopener noreferrer" class="dropdown__link">MIT-6.824 Distributed Systems<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/os-workbench" target="_blank" rel="noopener noreferrer" class="dropdown__link">南京大学 操作系统：设计与实现<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/mit-6.s081" target="_blank" rel="noopener noreferrer" class="dropdown__link">MIT-6.S081 Operating Systems Engineering<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/doongz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Tutorial Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Algorithm/前述/面试时做题技巧">Algorithm</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Competition/比赛">Competition</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Course/CMU-15-213">Course</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Knowledge/IC/IC">Knowledge</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Math/微积分/极限">Math</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Skill/ASM/RISC-V/汇编语言格式及ABI">Skill</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Skill/ASM/RISC-V/汇编语言格式及ABI">ASM</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Skill/ASM/RISC-V/汇编语言格式及ABI">RISC-V</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/汇编语言格式及ABI">汇编语言格式及ABI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/RISC-V简介">RISC-V 简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/通用寄存器和指令">RISC-V 通用寄存器和指令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/扩展寄存器和指令">RISC-V 扩展寄存器和指令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/流水线&amp;硬件模块&amp;译码模块">流水线 &amp; 硬件模块 &amp; 译码模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/ALU模块&amp;branch模块">ALU 模块和 branch 模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/LOAD&amp;STORE-UNIT">LSU &amp; SRAM &amp; GPIO模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/CSR读写控制">CSR读写控制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/EXU模块和CPU运行">EXU模块和CPU运行</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Skill/ASM/RISC-V/RISC-V总线和流水线">RISC-V 总线和流水线</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/RISC-V定时器及中断">RISC-V 定时器及中断</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/riscv-asm-manual">RISC-V Assembly Programmer&#x27;s Manual</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/ASM/x86/X86-64汇编">x86</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/Android/Android概述">Android</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/C/基础知识/数据类型">C</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/C++/基础知识/基本数据类型">C++</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/Golang/基础知识/条件判断">Golang</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/Skill/LaTeX/">LaTex</a><button aria-label="Toggle the collapsible sidebar category &#x27;LaTex&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/Linux/POSIX">Linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/Skill/Markdown/">README</a><button aria-label="Toggle the collapsible sidebar category &#x27;README&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/Mermaid/">mermaid</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/Python/运算符">Python</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/SQL/数据库理论">SQL</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/工具链/工具&amp;网站">工具链</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/常用CLI/docker-CLI">常用CLI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/设计模式/多态和多态性">设计模式</a></div></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Skill</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">ASM</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">RISC-V</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">RISC-V 总线和流水线</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>RISC-V 总线和流水线</h1><p>来源：<a href="https://www.icfedu.cn/?s=RISC-V+%E6%80%BB%E7%BA%BF%E5%92%8C%E6%B5%81%E6%B0%B4" target="_blank" rel="noopener noreferrer">https://www.icfedu.cn/?s=RISC-V+%E6%80%BB%E7%BA%BF%E5%92%8C%E6%B5%81%E6%B0%B4</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一总线简介">一、总线简介<a class="hash-link" href="#一总线简介" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1总线">1、总线<a class="hash-link" href="#1总线" title="Direct link to heading">​</a></h3><p>在计算机体系结构中，总线（最初来自拉丁词omnibus）是一种通信系统，可<strong>在计算机内部组件之间或计算机之间传输数据</strong>。早期的总线主要是连接内存和外设的线束。</p><p>早在1981年，IBM公司就开发了ISA总线。ISA全称为Industry Standard Architecture，为8比特或是16比特宽的并行总线，速度最高可达16 MB/s。乍一面世，ISA总线就被广泛使用，直到1993年满足更高传输速度的Intel公司发明的总线，PCI面世。</p><p>PCI（Peripheral Component Interconnect）总线的最高传输速度为533 MB/s，总线位宽也被扩展到32比特/64比特，更适合当时处理器的爆炸式发展速度。并且PCI总线支持即插即用，和ISA总线添加新设备时需要复杂的配置参数（IRQ线，I/O地址和DMA等）相比，PCI总线使用起来更方便。</p><p>PCI总线之后AGP（Accelerated Graphics Port）总线作为满足3D显卡的后继也逐渐崭露头角。而在之后的发展时期，PCI又通过后继者PCI-X和PCI-express，进一步提高速度和扩展了性能。当今，PCI-express是最广泛用来连接显卡，硬盘驱动等的总线。除此之外，还有许多现代总线在不同的应用场合发挥着必不可少的重要作用。</p><p>总线的发展可以大致分为3代：</p><ol><li>初代总线都有一个致命的缺点：总线上的所有设备必须以相同的时钟主频运行，因此快速的CPU可能因为需要迁就慢速的外设而降低速度通信。</li><li>发展的总线可以将CPU和内存之间的通信，外设之间的通信分开控制（总线控制器是南桥芯片的前身）。这就可以使得CPU在不影响总线的情况下提高速度。</li><li>之后的总线允许以支持内存和视频卡所需的非常高的速度运行，同时在与较慢的外设通信时还支持较低的速度。进一步将慢速和快速的设备切割开来。CPU和内存之间的控制是北桥芯片的前身。CPU和北桥之间连接的总线被称为前端总线（Front Side Bus，FSB）。</li></ol><p>现代总线根据计算机传输的信息类型，可划分为数据总线，地址总线和控制总线，分别用于传输数据，地址和控制信号。</p><p>总线分类有很多种：</p><ul><li>从计算机的角度来看，根据总线的主要角色，内部或外部连接设备可以分为<strong>内部总线</strong>和<strong>外部总线</strong>。 SPI和I2C是内部总线，而Firewire（IEEE 1394）和GPIB（IEEE-488）是外部总线。</li><li>分类也可以基于数据传输形式，总线可以是串行或并行的。<strong>并行总线</strong>在多条线上并行承载数据字，而<strong>串行总线</strong>以位串行形式传输数据。例如，PCIE和USB是串行总线，而ISA和Wishbone是并行的。</li><li>通过总线是否有单独时钟线可以分为<strong>同步总线</strong>和<strong>异步总线</strong>。同步总线一般有单独的时钟线，异步总线的时钟信号由数据信号的边沿提取。比如SPI和I2C就是同步总线，UART和CAN为异步总线。</li></ul><p>使用总线可以标准化输入和输出的数据格式，使CPU与外围设备，外围设备和外围设备之间的数据通信不依赖于其自身的数据格式。 由于外围设备的种类繁多，因此外围设备的数据格式必须采用相同的标准。 只要计算机使用USB协议并与相应的软件配合使用，当计算机访问打印机，麦克风，键盘等多个外围设备时，外围设备就可以工作，而无需设计各种与计算机连接的接口。 这样，消除了不同设计接口连接的复杂性，并且计算机和外围设备的设计得以分离和简化。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2不同通信接口举例">2、不同通信接口举例<a class="hash-link" href="#2不同通信接口举例" title="Direct link to heading">​</a></h3><p>RAM，FIFO，FLASH等都是FPGA的内部逻辑，但是它们具有不同的模块和通信接口。 以下是RAM和FIFO的接口模块。</p><p>RAM模块</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//单端口RAM，也可以设置为双端口RAM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TSP_RAM     your_instance_name </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .clka   (clka),       // 输入 clka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .wea    (wea),        // 输入 [0 : 0] wea</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .addra  (addra),      // 输入 [11 : 0] addra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 第二次实例化RAM的时候，可能就需要不同长度的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .dina   (dina),       // 输入 [31 : 0] dina</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .douta  (douta),      // 输出 [31 : 0] douta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FIFO 模块</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">fifo_generator     your_instance_name (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .clk    (clk),      // 输入 clk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .srst   (srst),     // 输入 srst, reset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .din    (din),      // 输入 [7 : 0] din</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .wr_en  (wr_en),    // 输入 wr_en</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .rd_en  (rd_en),    // 输入 rd_en</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .dout   (dout),     // 输出 [7 : 0] dout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      // FIFO 满/空</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .full   (full),     // 输出 FIFO满</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .empty  (empty)     // 输出 FIFO空</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>CPU需要同时连接RAM和FIFO，但显然它们具有不同的数据长度和不同的地址格式。 如果CPU不需要为每个外围设备设计特定的接口，则可以节省大量时间来设计CPU本身。 RISC-V CPU加载和存储的模块示例：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">i_D_PC,          // 外围设备地址 (比如 FIFO, RAM)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">i_LOAD,          // 加载指令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">i_load_instr,    // {rv32i_lbu,rv32i_lb,rv32i_lhu,rv32i_lh,rv32i_lw};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">o_rd_wen,        // 读写使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">i_rd_idx,        // 寄存器索引，用于回写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">o_wb_data,       // 回写数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">i_STORE,         // 储存指令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">i_store_instr,   // {rv32i_sb,rv32i_sh,rv32i_sw};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">i_rs2_val,       // 实际储存在外围设备的值</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看出，CPU接口与外围设备也有所不同。 同时，外围设备始终在发展。 如果没有总线，即使CPU在最初设计时也考虑了所有外围设备，随着外围设备的扩展，最终还是会产生问题。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3使用总线的优点">3、使用总线的优点<a class="hash-link" href="#3使用总线的优点" title="Direct link to heading">​</a></h3><p>假设CPU和外围设备之间没有总线，那么一些问题需要解决：</p><ul><li>将CPU译码出来的指令信息转换为RAM接口所需的信号。同时也将CPU译码出来的指令信息转换为FIFO接口所需的信号。</li><li>时钟不匹配。 外围设备可能是超低速设备，也可能是可以在多个时钟周期内获取数据的设备（例如DDR需要数十个时钟才能读取或写入一次数据）。</li><li>RISC-V CPU设计者必须逐个处理不同的外围设备。这样，CPU core设计者和外围IP设计者必须协同合作。很多项目是由多个开发者或多个公司完成，这增加了很多沟通成本。</li></ul><p>解决方法就是使用总线，优点如下：</p><ul><li>使用相同的标准，无需关心外围设备接口。</li><li>无需担心CPU与外围设备之间的时钟不匹配，即使外围设备是多时钟周期的低速设备。</li><li>CPU设计者专注于CPU core的设计。 外围设备开发者关注外围设备的相关开发。 每个人都遵守总线规范，即可轻松实现互连。</li><li>总线可以扩展和互连。 例如，可以将FII RISC-V总线扩展为AHB，而不会破坏当前的总线结构，并且可以直接使用以前由AHB连接的IP内核。</li><li>这对外围设备的裁剪也非常有帮助。不需要更改CPU，只需更新地址，即可定制芯片。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二fii-risc-v-cpu总线设计">二、FII RISC-V CPU总线设计<a class="hash-link" href="#二fii-risc-v-cpu总线设计" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1学习总线设计">1、学习总线设计<a class="hash-link" href="#1学习总线设计" title="Direct link to heading">​</a></h3><p>学习设计总线是本文的学习目的，在学习时遵循从简单到复杂的设计。本文将分析目前已有的总线来说明为什么需要设计特有的FII RISC-V BUS。首先，设计这个总线的目的是在CPU内部传输数据。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="复杂但功能强大的axi总线">复杂但功能强大的AXI总线<a class="hash-link" href="#复杂但功能强大的axi总线" title="Direct link to heading">​</a></h4><p>AXI（Advanced eXtensible Interface）总线是ARM公司的AMBA（Advanced Microcontroller Bus Architecture）部分协议。其特点是总线接口多，协议全面，操作复杂，且可以实现灵活控制。</p><p>上述的AXI总线的优点另一方面来看也是缺点。针对一个专为嵌入式 IoT设计的CPU而言，无论是使用还是调试时，AXI过于庞大和复杂。完全支持像AXI4这样的总线会消耗太多资源，耗电。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="简单易控制的spi总线">简单易控制的SPI总线<a class="hash-link" href="#简单易控制的spi总线" title="Direct link to heading">​</a></h4><p>SPI总线是由1979年Motorola公司发明的同步串行总线，常用于SD（secure digital） card和LCD（liquid crystal display）显示屏通信中。SPI总线的硬件实现也很简单，通讯线比较少，一般只有4条，但不使用SPI作为总线的原因是，在CPU内部，数据传输一般都是并行的，而SPI是串行总线，如果使用SPI总线作为RISC-V内部总线，需要多次串并，并串的转换。</p><hr><p>通过上述的两个具有代表性的总线可以看出，现有的总线要么复杂难以控制，要么过于简单，不适用于CPU内部传输。因此，在综合考虑了性能，功耗，资源的平衡后，我们选择实现一个小而精的总线。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2fii-risc-v-总线设计">2、FII RISC-V 总线设计<a class="hash-link" href="#2fii-risc-v-总线设计" title="Direct link to heading">​</a></h3><p>以下代码模块显示了FII RISC-V总线设计。 具体细节在代码模块中详细注释说明。</p><p>//RISCV 总线设计：RIB (riscv internal bus) 总线定义</p><p><strong>32bit： rib_addr,   // 地址总线</strong></p><p><strong>32bit： rib_dout,   // 数据总线</strong></p><p><strong>32bit： rib_din,    // 数据总线</strong></p><p><strong>1bit: rib_valid,     // 控制总线</strong></p><p><strong>2bit： rib_ready,   // 控制总线</strong></p><p><strong>32bit： rib_we,    // 控制总线</strong></p><p><strong>1bit： rib_rd,      // 控制总线</strong></p><p><strong>1bit： rib_op,      // 控制总线</strong></p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//RISCV master 总线设计 （cpu 等）：verilog代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [31:0]   o_rib_maddr,    // master 发送， 32位 地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [31:0]   o_rib_mdout,    // master 发送， 32位 数据   （ 写操作 ）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input  [31:0]   i_rib_mdin,     // master 接收， 32位 数据   （ 读操作 ）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output          o_rib_mvalid,   // master 发出， 用于表示 有 操作（读/写）发生</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input  [1:0]    i_rib_mready,   // master 接收， bit[1]= 总线错误， bit[0] 外设准备好</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [3:0]    o_rib_mwe,      // master 发送，写操作信号，每一位表示一个 （单沿）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output          o_rib_mrd,      // master 发送，读操作信号，（单沿）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output          o_rib_mop,      // master 发送，表示每次操作（单沿）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//RISCV slave 总线设计 （外设 等）：verilog 代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input  [31:0]   i_rib_saddr,    // slave 接收， 32位 地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input  [31:0]   i_rib_sdin,     // slave 接收， 32位 数据   （ 写操作 ）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [31:0]   o_rib_sdout,    // slave 发出， 32位 数据   （ 读操作 ）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input           i_rib_svalid,   // slave 接收， 用于表示 有 操作（读/写）发生</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [1:0]    o_rib_sready,   // slave 发出， bit[1]= 总线错误， bit[0] 外设准备好</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input  [3:0]    i_rib_swe,      // slave 接收，写操作信号，每一位表示一个 （单沿）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input           i_rib_srd,      // slave 接收，读操作信号，（单沿）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input           i_rib_sop,      // slave 接收，表示每次操作（单沿）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3读写操作分析">3、读写操作分析<a class="hash-link" href="#3读写操作分析" title="Direct link to heading">​</a></h3><p>接下来，对单独的读写操作进行分析，最简单的单时钟周期总线读操作时序图如图1所示。注意：</p><ul><li>mvalid，mready<!-- -->[0]<!-- -->同时产生</li><li>读信号，地址，读数据和mop操作信号都是单周期</li></ul><p>在图中，灰色波形表示无效区域。 蓝色波形表示输出（相对于CPU），绿色波形表示输入（相对于CPU）。</p><p>单时钟周期读操作时序图:</p><p><img loading="lazy" src="/assets/images/110-dbe42e1559f5e052e75528935de560db.jpeg" width="838" height="582" class="img_ev3q"></p><p>数值示例如下：对于地址32’h9000_00xx，读取数据（mdin）32’h1234_5678。</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mrd  = 1,        32&#x27;hxxxx_xx78，maddr = 32&#x27;h9000_0000，  lb(u)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mrd  = 1,        32&#x27;hxxxx_56xx，maddr = 32&#x27;h9000_0001，  lb(u)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mrd  = 1,        32&#x27;hxx34_xxxx，maddr = 32&#x27;h9000_0002，  lb(u)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mrd  = 1,        32&#x27;h12xx_xxxx，maddr = 32&#x27;h9000_0003，  lb(u)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mrd  = 1,        32&#x27;hxxxx_5678， maddr = 32&#x27;h9000_0000， lh(u)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mrd  = 1,        32&#x27;h1234_xxxx， maddr = 32&#x27;h9000_0002， lh(u)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mrd  = 1,        32&#x27;h1234_5678，maddr = 32&#x27;h9000_0000，  lw</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>单时钟周期总线写操作时序图如图2所示。注意，与单时钟周期总线读操作类似：</p><ul><li>mvalid，mready<!-- -->[0]<!-- -->同时产生</li><li>写信号，地址，写数据和mop操作信号均为单个时钟周期操作</li></ul><p>单时钟周期写操作时序图</p><p><img loading="lazy" src="/assets/images/111-23366c4e6b0c6a7d317a6a7e527cad34.jpeg" width="838" height="591" class="img_ev3q"></p><p>与读取数据示例类似，写入数据示例如下：对于地址32’h9000_00xx，写数据（mdout）32’h1234_5678。</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mwe = 4&#x27;b0001,        32&#x27;hxxxx_xx78，maddr= 32&#x27;h9000_0000， sb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mwe = 4&#x27;b0010,        32&#x27;hxxxx_56xx，maddr= 32&#x27;h9000_0001， sb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mwe = 4&#x27;b0100,        32&#x27;hxx34_xxxx，maddr= 32&#x27;h9000_0002， sb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mwe = 4&#x27;b1000,        32&#x27;h12xx_xxxx，maddr= 32&#x27;h9000_0003， sb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mwe = 4&#x27;b0011,        32&#x27;hxxxx_5678，maddr= 32&#x27;h9000_0000， sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mwe = 4&#x27;b1100,        32&#x27;h1234_xxxx，maddr= 32&#x27;h9000_0002， sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mwe = 4&#x27;b1111,        32&#x27;h1234_5678，maddr= 32&#x27;h9000_0000， sw</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>单时钟周期总线连续读操作，其时序图如图3所示。与单时钟周期读取操作相同：</p><ul><li>mvalid，mready<!-- -->[0]<!-- -->同时产生</li><li>读信号，地址，读数据，mop操作信号均为单时钟周期操作信号</li></ul><p>单时钟周期连续读操作时序图:</p><p><img loading="lazy" src="/assets/images/112-93c3124b9dd3d524b7a39535b4d54fab.jpeg" width="842" height="593" class="img_ev3q"></p><p>单时钟周期总线连续写操作，其时序图如图4所示：</p><ul><li>mvalid，mready<!-- -->[0]<!-- -->同时产生</li><li>写信号，地址，写数据，mop操作信号均为单时钟周期操作信号</li></ul><p>单时钟周期连续写操作时序图:</p><p><img loading="lazy" src="/assets/images/113-43faf42224f08a39ed6769c555ec9f52.jpeg" width="844" height="600" class="img_ev3q"></p><p>多个时钟周期总线读操作的时序图如图5所示。多个周期意味着<strong>*<!-- -->*<!-- -->ready<!-- -->*<!-- -->*</strong>无法立即响应<strong>*<!-- -->*<!-- -->valid<!-- -->*<!-- -->*</strong>，即外围设备的速度很慢。</p><ul><li>如果mvaild为高，则仅在准备好读数据后，将mready <!-- -->[0]<!-- -->拉高</li><li>读信号，地址是多个时钟周期操作信号，读数据，mop操作信号均为单时钟周期操作信号</li></ul><p>多个时钟周期读操作时序图:</p><p><img loading="lazy" src="/assets/images/114-d2e680e27e8c92e1cb5ce991fe3f056a.jpeg" width="836" height="593" class="img_ev3q"></p><p>多个时钟周期总线写操作的时序图如图6所示。</p><ul><li>如果mvaild为高，则仅在准备好写数据后，将mready <!-- -->[0]<!-- -->拉高</li><li>写信号，地址和写数据是多个时钟周期操作信号，mop操作信号为单时钟周期</li></ul><p>多个时钟周期写操作时序图</p><p><img loading="lazy" src="/assets/images/115-031cc485d6bd74d86a1d776f815ebef9.jpeg" width="842" height="603" class="img_ev3q"></p><p>多个时钟周期总线连续读操作的时序图如图7所示。</p><ul><li>如果mvaild为高，则仅在准备好读数据后，将mready <!-- -->[0]<!-- -->拉高</li><li>读信号，地址是多个时钟周期操作信号，读数据，mop操作信号均为单时钟周期操作信号</li></ul><p>多个时钟周期连续读操作时序图</p><p><img loading="lazy" src="/assets/images/116-a999a8cdec157f2d1c98c55a43918ab5.jpeg" width="844" height="608" class="img_ev3q"></p><p>多个时钟周期总线连续写操作的时序图如图8所示。</p><ul><li>如果mvaild为高，则仅在准备好写数据后，将mready <!-- -->[0]<!-- -->拉高</li><li>写信号，地址和写数据是多个时钟周期操作信号，mop操作信号为单时钟周期</li></ul><p>多个时钟周期连续写操作时序图</p><p><img loading="lazy" src="/assets/images/117-259145defc953108e6e3e8832114eed4.jpeg" width="839" height="590" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4代码">4、代码<a class="hash-link" href="#4代码" title="Direct link to heading">​</a></h3><p>相应的代码模块如下所示，具体细节在代码模块中详细注释说明。</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">localparam DEV_NUM = 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [DEV_NUM - 1:0] s_cs;//外围设备片选 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign s_cs[0] = ( i_rib_maddr[31:12] == DBG_BASEADDR[31:12] )  ? 1&#x27;b1 : 1&#x27;b0;//jtag调试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign s_cs[1] = ( i_rib_maddr[31:16] == PLIC_BASEADDR[31:16] ) ? 1&#x27;b1 : 1&#x27;b0;//外部中断</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign s_cs[2] = ( i_rib_maddr[31:16] == CPU_BASEADDR[31:16] )  ? 1&#x27;b1 : 1&#x27;b0;//CPU</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign s_cs[3] = ( i_rib_maddr[31:16] == MEM_BASEADDR[31:16] )  ? 1&#x27;b1 : 1&#x27;b0;//内存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign s_cs[4] = ( i_rib_maddr[31:16] == TMR_BASEADDR[31:16] )  ? 1&#x27;b1 : 1&#x27;b0;//计时器中断</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign s_cs[5] = ( i_rib_maddr[31:16] == GPIO_BASEADDR[31:16] ) ? 1&#x27;b1 : 1&#x27;b0;//GPIO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign s_cs[6] = ( i_rib_maddr[31:16] == UART_BASEADDR[31:16] ) ? 1&#x27;b1 : 1&#x27;b0;//UART</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//有一些未使用的选项，之后可以进行扩展</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign s_cs[7] = 1&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign s_cs[8] = 1&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign s_cs[9] = 1&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//===============================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always @ ( * )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if(!rst_n)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_rib_saddr  = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_rib_sdin   = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_rib_svalid = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_rib_swe    = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_rib_srd    = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_rib_sop    = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //主机发送的信息，每个外围设备都可以接收（广播）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_rib_saddr  = i_rib_maddr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_rib_sdin   = i_rib_mdout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_rib_svalid = i_rib_mvalid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_rib_swe    = i_rib_mwe;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_rib_srd    = i_rib_mrd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_rib_sop    = i_rib_mop;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//===============================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire bus_err_ack = (i_rib_maddr == i_PC) ? 1&#x27;b1 : 1&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always @ ( * )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //外围设备不能同时发送信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //如果当前片选被拉高，则相应的外设将返回数据和ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //与主机信息传输一起组成一个总线分配器/多路复用器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case (s_cs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10&#x27;b00_0000_0001:   // DBG_BASEADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mdin      = i0_rib_sdout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mready    = i0_rib_sready; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10&#x27;b00_0000_0010:   // PLIC_BASEADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mdin      = i1_rib_sdout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mready    = i1_rib_sready; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10&#x27;b00_0000_0100:   // CPU_BASEADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mdin      = i2_rib_sdout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mready    = i2_rib_sready; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10&#x27;b00_0000_1000:   // MEM_BASEADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mdin      = i3_rib_sdout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mready    = i3_rib_sready; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10&#x27;b00_0001_0000:   // TMR_BASEADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mdin      = i4_rib_sdout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mready    = i4_rib_sready; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10&#x27;b00_0010_0000:   // GPIO_BASEADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mdin      = i5_rib_sdout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mready    = i5_rib_sready; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10&#x27;b00_0100_0000:   // UART_BASEADDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mdin      = i6_rib_sdout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mready    = i6_rib_sready; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10&#x27;b00_1000_0000:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mdin      = i7_rib_sdout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mready    = i7_rib_sready; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10&#x27;b01_0000_0000:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mdin      = i8_rib_sdout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mready    = i8_rib_sready; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10&#x27;b10_0000_0000:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mdin      = i9_rib_sdout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mready    = i9_rib_sready; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mdin      = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_rib_mready    = {1&#x27;b1, bus_err_ack};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endcase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三流水线介绍">三、流水线介绍<a class="hash-link" href="#三流水线介绍" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1状态机">1、状态机<a class="hash-link" href="#1状态机" title="Direct link to heading">​</a></h3><p>在介绍流水线之前，先简介一下状态机(Finite-State Machine，FSM)。状态机CPU具有一组状态，以及一个将输入符号和当前状态映射到下一个状态的转换函数。 每次CPU仅执行一种状态，然后循环重复。</p><p>FII RISC-V有状态机版本(v2.01，v2.02)，相对于5级经典状态(取指，译码，执行，访存，回写)的CPU而言，FII CPU只有三级状态，将其中的四级状态两两合并，最后的三级状态分别是取指，译码和执行，访存和回写。状态相关代码模块如下所示(更多的细节可以点击<a href="https://www.icfedu.cn/archives/7923" target="_blank" rel="noopener noreferrer">这里</a>)。</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">`DBG_INFO reg [ 2: 0 ] instr_st = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg [ 2: 0 ] instr_st_nxt = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always@( posedge sys_clk )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (( rst_n == 1&#x27;b0 ) | i_cpu_reset )     instr_st &lt;= IDLE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else    instr_st &lt;= instr_st_nxt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always @ ( * )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case ( instr_st )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //IDLE是FPGA板处于上电复位时的状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //正常的执行状态是fetch，execution，和write back.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //每个时钟周期仅执行一个状态，一个完整的循环至少需要3个时钟周期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //如果有长周期指令，执行时间会更长</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IDLE:   // 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(!i_cpu_reset)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instr_st_nxt = I_FCH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instr_st_nxt = IDLE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    I_FCH:   // 1，取指</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(i_cpu_reset) instr_st_nxt = IDLE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else instr_st_nxt = I_EXE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    I_EXE:   // 2 译码和执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ( i_ls_need )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ( ls_rib_ok )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                instr_st_nxt = I_WB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                instr_st_nxt = I_EXE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instr_st_nxt = I_WB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    I_WB:   // 3 访存和回写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        instr_st_nxt = I_FCH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default : instr_st_nxt = IDLE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endcase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2流水线指令执行示例">2、流水线指令执行示例<a class="hash-link" href="#2流水线指令执行示例" title="Direct link to heading">​</a></h3><p>这里有一个汇编示例文件，如图1所示。</p><p><img loading="lazy" src="/assets/images/118-2b1ff16e9e6f8d608fdecc9c7b3e01f5.jpeg" width="317" height="217" class="img_ev3q"></p><p>图2 状态机在时钟周期下的相应状态</p><p><img loading="lazy" src="/assets/images/119-eef58414f96e7a644fd52c6710ccd906.jpeg" width="893" height="78" class="img_ev3q"></p><p>图2中的数字表示时钟周期，不同的指令状态用不同的颜色绘制。 它显示了对于状态机CPU：</p><ul><li>时钟周期1：FCH，取指令，<strong>*<!-- -->*<!-- -->ADDI<!-- -->*<!-- -->*</strong></li><li>时钟周期2：EXE，执行<strong>*<!-- -->*<!-- -->ADDI<!-- -->*<!-- -->*</strong></li><li>时钟周期3：WB，将X0 + 0的结果写入a5</li><li>时钟周期4：FCH，取指令，<strong>*<!-- -->*<!-- -->ADDI<!-- -->*<!-- -->*</strong></li><li>时钟周期5：EXE，执行<strong>*<!-- -->*<!-- -->ADDI<!-- -->*<!-- -->*</strong></li><li>时钟周期6：WB，将X0 + 0的结果写入s0</li><li>…</li></ul><p>对于相同的汇编示例代码，流水线执行的方式有所不同，3级流水线的示例参见图3。</p><p><img loading="lazy" src="/assets/images/120-6253afe7b334005feaa16f94074eaac6.jpeg" width="884" height="216" class="img_ev3q"></p><p>对于流水线：</p><ul><li>时钟周期1：FCH，取指令，<strong>*<!-- -->*<!-- -->ADDI<!-- -->*<!-- -->*</strong></li><li>时钟周期2：EXE ＆ FCH，执行<strong>*<!-- -->*<!-- -->ADDI<!-- -->*<!-- -->*</strong>&amp; 获取指令<strong>*<!-- -->*<!-- -->ADDI<!-- -->*<!-- -->*</strong></li><li>时钟周期3： WB ＆ EXE ＆ FCH，将X0 + 0的结果写入a5 &amp; 执行<strong>*<!-- -->*<!-- -->ADDI<!-- -->*<!-- -->*</strong> &amp;获取指令<strong>*<!-- -->*<!-- -->SB<!-- -->*<!-- -->*</strong></li><li>时钟周期4：FCH ＆ WB ＆ EXE，获取指令<strong>*<!-- -->*<!-- -->ADDI<!-- -->*<!-- -->*</strong>&amp; 将X0 +0的结果写入s0 &amp; 执行<strong>*<!-- -->*<!-- -->SB<!-- -->*<!-- -->*</strong></li><li>…</li></ul><p>尽管对于每条指令(如2个ADDI和SB)，它们仍需要3个时钟周期才能完成，但是在同一时钟周期下，3条指令将被同时执行。除了时钟周期1和2，流水线没有被完全填充，因此执行效率不高，其他时钟周期都同时执行3个指令。对于从时钟周期1到时钟周期12的相同时间段，状态机执行4条指令，而流水线至少执行10条指令。当时钟速度相同时，流水线CPU的效率绝对高于状态机CPU。</p><p>计算机体系结构中的流水线也被称为<strong>数据流水线</strong>。它将一个重复的流程分解为几个子流程，每个子流程与其他子流程并行运行。由于此工作方法与工厂中的生产流水线非常相似，因此称为流水线技术，即同时执行多个子流程。</p><p>经典的5级流水线包括:</p><ul><li>取指令(fetch instruction)</li><li>指令解码器(instruction decoder）</li><li>执行(execution）</li><li>存储器访问(memory access)</li><li>回写(writeback)。</li></ul><p>FII RISC-V将指令解码和执行，存储器访问和回写结合在一起，形成3级流水线：</p><ul><li>取指令(FCH)</li><li>执行(EXE)</li><li>回写(WB)。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3流水线分类">3、流水线分类<a class="hash-link" href="#3流水线分类" title="Direct link to heading">​</a></h3><p>图4显示了3级流水线。根据执行顺序，可以将流水线分为<strong>顺序流水线</strong>和<strong>乱序流水线</strong>。如果流水线具有反馈，则将其定义为<strong>非线性流水线</strong>。与之相反，如果流水线中的数据从第一级流到最后一级，则它是<strong>线性流水线</strong>。流水线有不同的阶段，多至31个阶段(hyper pipelined technology，超级流水线技术)。开发和使用不同的流水线CPU是因为在相同的生产过程和相同的时钟下，流水线CPU指令执行的效率和主频得到了极大的提高。</p><p><img loading="lazy" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAByAF4DASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD3+orX/j0h/wCua/yo+y2//PCL/vgVhVlVq8ltDWnT576nRUVztFZfWfI1+reZ0VFcC/i3SI7q5t3e8U2spiuJG0+cRQkAEl5NmxVwQ24nG0g5xzUmpeKNK0l51upLki3XfO8FnNMkIxu+dkQqp24bBIOCD0Ip/WH/ACi9gv5juqK4GfxbpFt9r8x7z/RLlLSbbp87Ylf7qjCfNnK4IyPmTn5lzuUniGugLDp9ToqK52ij6z5D+reZu2v/AB6Q/wDXNf5VLVaC2ga3jJhjJKgklR6VJ9lt/wDnhF/3wK6U7q5zNWdiWudrd23H/PWL/v2f/iqoRad5sKSebjcobG3pn8awrwlK1jahOMb3KNFaP9lf9Nv/AB3/AOvR/ZX/AE2/8d/+vWHsJ9jo9tDueZ6bajVfHWpXdnqySR6drIkns1dCozYCHdwpfdvJXBYL8jcZFXrG/sNOsL3RdSVJb6a8vGXTCFaW6jlnkddqE4dWVxlvur824rtbHff2V/02/wDHf/r0f2V/02/8d/8Ar1TpzfQhVILqeP6rf2K6jrt03iNIYYfEenrJaebAImI+y5LErvBHlyZwwH7puPlavT60f7K/6bf+O/8A16P7K/6bf+O//XpSpTfQaqwXUzqK0f7K/wCm3/jv/wBej+yv+m3/AI7/APXpewn2K9tDuXbf/j2i/wBwfyqSqtuJzbRESRgFBgGMnt9al23H/PWL/v2f/iq7lscL3Jaitf8Aj0h/65r/ACo+0J/dl/79N/hVKDVbJLeJGmwyoARtPp9KpJvYltLc0qKpf2vY/wDPf/xxv8KP7Xsf+e//AI43+FPll2DmXcu0VS/tex/57/8Ajjf4Uf2vY/8APf8A8cb/AAo5Zdg5l3LtFUv7Xsf+e/8A443+FH9r2P8Az3/8cb/Cjll2DmXcu0VS/tex/wCe/wD443+FH9r2P/Pf/wAcb/Cjll2DmXcsWv8Ax6Q/9c1/lUtVba4QWkIxJ9xekbHt9Kl+0J/dl/79N/hUjJa4mu2ria3o9TKr0CiiitjE5l/EeprqlxajS7RkivTaJi9bzJj5In+VTFtB8s9GdRkEbuhJd+I9Tt9Tm05NLtHu/tEUdtG16y+dE4kbzCfKIXAifK8n5Gx/BvoDTJ18U3mqHwzcPeC/820vPMt1Vk+zLBiRt5kEedzYCk9DgnK1ZvW1w+IDqcOkXbpaSLbQwrJb/v4G3ea4YyDblhEQCM/ulHG99sXZehM/iPU11S4tRpdoyRXptExet5kx8kT/ACqYtoPlnozqMgjd0J6auKGmTr4pvNUPhm4e8F/5tpeeZbqrJ9mWDEjbzII87mwFJ6HBOVrtapXEwooopknX2X/Hjb/9cl/lU9QWX/Hjb/8AXJf5VPXG9zqWxF9nT+9L/wB/W/xqlBpVk9vE7Q5ZkBJ3H0+taVRWv/HpD/1zX+VCbWwNJ7lf+yLH/nh/4+3+NH9kWP8Azw/8fb/GrtFPml3DlXYpf2RY/wDPD/x9v8aP7Isf+eH/AI+3+NXaKOaXcOVdil/ZFj/zw/8AH2/xo/six/54f+Pt/jV2ijml3DlXYpf2RY/88P8Ax9v8aP7Isf8Anh/4+3+NXaKOaXcOVdirbW6G0hOZPuL0kYdvrUv2dP70v/f1v8aLX/j0h/65r/KpakZFuuP+eUX/AH8P/wATWPFrvlQpH9mztULnf1x+FbtcVXNiKkoW5SZOxt/8JB/06/8AkT/61H/CQf8ATr/5E/8ArViUVzfWKncV2bf/AAkH/Tr/AORP/rUf8JB/06/+RP8A61cX4nvZNN0uG9S9+yJFe2wmc7NpiaZEcMWBwNrE5GCMDnrXJ2ut6xc+F7m/n1i7juIL2wtZVgt4maMsluJ12eWx375pMrgkMgAAwQbVWq1e4XZ7B/wkH/Tr/wCRP/rUf8JB/wBOv/kT/wCtXEeHbm5uXvN15cXdrGypG95EsVwJMZcMiom1cGPbuUMcseVKE7lS69RO1wuzb/4SD/p1/wDIn/1qP+Eg/wCnX/yJ/wDWrEopfWKncLs6q1ac2kJEcePLXGZD6fSpt1x/zyi/7+H/AOJptn/x42//AFzX+VT16MdUiyL7Vb/894v++xXH12tRWv8Ax6Q/9c1/lWVWl7S2omrnH0V2tFY/VPMXKee6vYf2rot/p3m+V9rt5IPM27tm5SucZGcZ6VmXPh65fRRYWt/DE/8AaJvjLLbGQf8AHwbgLtDr/FtGc8gHgZ49VoprDNfa/AOU8303Tbm3vbm+vrqG4u5444SYIDEgRC5X5SzHOZGyc4xjgYJOnXa0UPC36hynFUV2tFL6p5hylS0uYFs4AZowRGoILD0qb7Vb/wDPeL/vsUWv/HpD/wBc1/lUtdaVlYoKitf+PSH/AK5r/KiimBLRRRQAUUUUAFFFFABRRRQBFa/8ekP/AFzX+VS0UUAf/9k=" width="94" height="114" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4流水线冲突">4、流水线冲突<a class="hash-link" href="#4流水线冲突" title="Direct link to heading">​</a></h3><p>流水线CPU也为高性能付出了代价，例如，它的逻辑一般比状态机逻辑更复杂。 此外，流水线CPU主要会产生三种冲突：<strong>数据冲突</strong>，<strong>结构冲突</strong>和<strong>控制冲突</strong>。</p><ul><li><strong>数据冲突</strong></li></ul><p>当流水线不同阶段的指令表现出数据依赖性时，就会发生数据危险。 例如，在图5中，指令2依赖于于指令1，s0既是指令1的结果，也是指令2中的加数。当指令1将结果回写到寄存器时，指令2使用了未更新的错误s0值执行。解决方案是bypass该值，这意味着直接在回写之前，将指令1结果中的s0值传递给指令2。</p><p><img loading="lazy" src="/assets/images/122-50c2f541a473cb32e36dd28174f57fa6.jpeg" width="471" height="328" class="img_ev3q"></p><ul><li><strong>结构冲突</strong></li></ul><p>当流水线中的两个或更多指令需要相同资源时，就会发生结构冲突。 例如，当从存储块中提取指令时，与此同时，另一条指令正在写回到存储块中。 解决方案是在后面的指令前添加流水线气泡（nop，无操作），或增加可用硬件资源。</p><p><img loading="lazy" src="/assets/images/123-7bda9f3da3d17a11cc7fe2722909b594.jpeg" width="732" height="125" class="img_ev3q"></p><ul><li><strong>控制冲突</strong></li></ul><p>当流水线对分支预测做出错误决定时会发生控制冲突，因此必须丢弃已引入流水线的指令。 例如，在图7中，当执行j loop时，紧随其后的指令已被取出。 但是，PC(Program Counter，程序计数器)将跳至loop标签处，而不是指向已获取的指令。 在这种情况下，流水线将以nop(无操作)的形式执行已经获取的指令。</p><p><img loading="lazy" src="/assets/images/124-47e7109b8f20551f4444e032ed81e564.jpeg" width="474" height="326" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四流水线cpu设计">四、流水线CPU设计<a class="hash-link" href="#四流水线cpu设计" title="Direct link to heading">​</a></h2><p>本文在之前介绍流水线(详细的流水线CPU设计点击<a href="https://www.icfedu.cn/archives/9211" target="_blank" rel="noopener noreferrer">这里</a>)的基础上，讨论如何解决流水线产生的冲突，以及结合具体实例说明CPU的流水线设计。FII RISC-V是3级流水线CPU。 这三个阶段为：</p><ul><li>FCH</li></ul><p>取指， 从ITCM中拿到和当前PC匹配的指令</p><ul><li>EXE</li></ul><p>执行，执行当前的指令（包括指令译码，指令执行）</p><ul><li>WB</li></ul><p>仅当需要修改31个register（硬连接为0的寄存器x0不计算在内）或者读写外围设备的时候，需要执行这个操作。如果不需要，可以跳过，这样就节省一个时钟周期。如果外围设备需要很长时间才能得到数据，需要将流水线暂停（地址不变，发送`INST_NOP指令）</p><p>根据回写阶段的反馈，可以看出它是非线性流水线。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1解决流水线数据冲突">1、解决流水线数据冲突<a class="hash-link" href="#1解决流水线数据冲突" title="Direct link to heading">​</a></h3><p>如上所述，处理流水线数据冲突，特别是在“写之后读”的情况下。 如图1所示，当前一个回写寄存器（Rd）与下一个指令提取的寄存器（R1, R2)相同时，该值将被直接bypass。</p><p><img loading="lazy" src="/assets/images/125-e04327aa3e10d4e7de8edd5d1875ba86.jpeg" width="835" height="454" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2pc跳转">2、PC跳转<a class="hash-link" href="#2pc跳转" title="Direct link to heading">​</a></h3><p>在stage 1中，根据具体条件判断将下一条指令地址分配给<strong>*<!-- -->*<!-- -->instr_fch_pc<!-- -->*<!-- -->*</strong>。 通常，PC + 4是下一条指令地址。 当存在与跳转相关的指令或长周期加载和存储时，将为PC分配一个不同的值以获取正确的下一条指令地址，如图2所示。在stage 2中，将<strong>*<!-- -->*<!-- -->instr_fch_pc<!-- -->*<!-- -->*</strong>赋值到<strong>*<!-- -->*<!-- -->i_PC<!-- -->*<!-- -->*</strong>。</p><p><img loading="lazy" src="/assets/images/126-cfd2c244cf0f6a3eed298166953a6839.jpeg" width="833" height="472" class="img_ev3q"></p><p>图3列出了跳转情况的代码，并根据跳转类型为<strong>*<!-- -->*<!-- -->jump_addr<!-- -->*<!-- -->*</strong>分配不同的地址。 表1列出了相关跳转的标志及解释。</p><p><img loading="lazy" src="/assets/images/127-dedf09b1474e165fb4fcc4d5a4d1ae25.jpeg" width="836" height="328" class="img_ev3q"></p><table><thead><tr><th>标志</th><th>描述</th><th>标志</th><th>描述</th></tr></thead><tbody><tr><td><strong>*<!-- -->*<!-- -->I_dbg_entry_set<!-- -->*<!-- -->*</strong></td><td>Jtag调试模式</td><td><strong>*<!-- -->*<!-- -->dret<!-- -->*<!-- -->*</strong></td><td>退出调试模式</td></tr><tr><td><strong>*<!-- -->*<!-- -->Long_ir_cs<!-- -->*<!-- -->*</strong></td><td>长周期指令</td><td><strong>*<!-- -->*<!-- -->Irq_exp_flag<!-- -->*<!-- -->*</strong></td><td>进入中断</td></tr><tr><td><strong>*<!-- -->*<!-- -->mret<!-- -->*<!-- -->*</strong></td><td>退出中断</td><td><strong>*<!-- -->*<!-- -->default<!-- -->*<!-- -->*</strong></td><td>跳转指令</td></tr></tbody></table><p>图4显示了将跳转标志赋值给<strong>*<!-- -->*<!-- -->waiting_r<!-- -->*<!-- -->*</strong>。 只要有任何跳转发生，<strong>*<!-- -->*<!-- -->waiting_r<!-- -->*<!-- -->*</strong>就会拉高。 在图5中，如果<strong>*<!-- -->*<!-- -->waiting_r<!-- -->*<!-- -->*</strong>为高，则将`INST_NOP（no operation，无操作）赋值给<strong>*<!-- -->*<!-- -->curr_instr<!-- -->*<!-- -->*</strong>。 当发生跳转指令时，已经进入流水线之后的指令将被替换为nop。 INST_NOP（0x0000_0001）被解码为nop，它不会对内存或地址上产生任何操作。</p><p><img loading="lazy" src="/assets/images/128-0bfbebf0ae0e60f9fbc9445ee042d13f.jpeg" width="665" height="219" class="img_ev3q"></p><p><img loading="lazy" src="/assets/images/129-fab5a01d6b37d5cb79f7548410d5af27.jpeg" width="839" height="76" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3数码管显示实例及仿真">3、数码管显示实例及仿真<a class="hash-link" href="#3数码管显示实例及仿真" title="Direct link to heading">​</a></h3><p>图6显示了一个反汇编示例，该示例在数码管中显示字符“ F”。 显然，在标签 <code>&lt;START&gt;</code> 之前，流水线按顺序提取，执行和回写每条指令。 但是，在8000_003c地址中存在分支条件指令。 如果条件被满足，PC将跳至8000_0038，而不是8000_0040。 当流水线已经提取了8000_0040地址的指令时，应特别注意其执行结果。</p><p><img loading="lazy" src="/assets/images/130-b91658d3fdae5cfd7fe6d646df6a7557.jpeg" width="835" height="758" class="img_ev3q"></p><p>仿真结果如图7所示。可以看出，当<strong>*<!-- -->*<!-- -->curr_instr<!-- -->*<!-- -->*</strong>为0x0000_0001时，即为<strong>*<!-- -->*<!-- -->curr_instr<!-- -->*<!-- -->*</strong>被赋值为了nop时，<strong>*<!-- -->*<!-- -->i_PC<!-- -->*<!-- -->*</strong>会从0x8000_0040变为0x8000_0038，并且会带有延迟。 如前所述，跳转标志将使<strong>*<!-- -->*<!-- -->curr_instr<!-- -->*<!-- -->*</strong>从任何指令更改为ʻINST_NOP（0x0000_0001）。</p><p><img loading="lazy" src="/assets/images/131-168531c76950e461a0df108ba628d6e2.jpeg" width="839" height="197" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4uart串口输出实例及仿真">4、UART串口输出实例及仿真<a class="hash-link" href="#4uart串口输出实例及仿真" title="Direct link to heading">​</a></h3><p>图8显示了另一个UART示例。 它从UART输出“This is a call function program（这是一个调用函数程序）”。图9显示了存储在rodata段中的打印输出信息。当流水线执行0x8000_0044指令时，0x8000_0048地址中的指令已经被提取了。但是，根据0x8000_0044指令，PC应指向0x8000_0078以加载打印数据。这时，PC将放弃0x8000_0048地址的指令，并保留地址直到加载0x8000_0078 rodata，PC才会返回指向0x8000_0048的地址。图10显示了UART示例的仿真结果。可以看出，在放弃0x8000_0048地址的指令后，已将<strong>*<!-- -->*<!-- -->curr_instr<!-- -->*<!-- -->*</strong>赋值为INST_NOP（0x0000_0001）。</p><p>UART示例</p><p><img loading="lazy" src="/assets/images/132-789ed8abe265ea765fd66676073776a7.jpeg" width="818" height="325" class="img_ev3q"></p><p>输出打印信息</p><p><img loading="lazy" src="/assets/images/133-60e0d3927bc51f5a881be3c3dbaf07fb.jpeg" width="826" height="143" class="img_ev3q"></p><p>仿真结果</p><p><img loading="lazy" src="/assets/images/134-82eb38d937e17b6803609e6aa5bf19e9.jpeg" width="837" height="199" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5长周期访存指令处理">5、长周期访存指令处理<a class="hash-link" href="#5长周期访存指令处理" title="Direct link to heading">​</a></h3><p>在将实际地址分配给PC之前，将<strong>*<!-- -->*<!-- -->instr_fch_PC<!-- -->*<!-- -->*</strong>（PC + 4）赋值给<strong>*<!-- -->*<!-- -->next_addr<!-- -->*<!-- -->*</strong>，因为在执行加载/存储之后，正常的PC + 4地址将是下一个执行的PC，如图11所示。 图12与图2相同，但此处高亮显示了<strong>*<!-- -->*<!-- -->rib_delay_op<!-- -->*<!-- -->*</strong>。 这是一个决策判断，如果当前指令是长周期加载和存储，则将<strong>*<!-- -->*<!-- -->next_addr<!-- -->*<!-- -->*</strong>赋值给<strong>*<!-- -->*<!-- -->instr_fch_PC<!-- -->*<!-- -->*</strong>，在执行长周期加载和存储的时候，将<strong>*<!-- -->*<!-- -->next_addr<!-- -->*<!-- -->*</strong>分配给<strong>*<!-- -->*<!-- -->i_PC<!-- -->*<!-- -->*</strong>。</p><p>将instr_fch_PC赋值给next_addr</p><p><img loading="lazy" src="/assets/images/135-d80c829f1cdd179d5748f3c5f44e1518.jpeg" width="734" height="155" class="img_ev3q"></p><p>长周期加载&amp;存储</p><p><img loading="lazy" src="/assets/images/136-997c254ec164780efe0e2550b473102e.jpeg" width="836" height="474" class="img_ev3q"></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Skill/ASM/RISC-V/EXU模块和CPU运行"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">EXU模块和CPU运行</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Skill/ASM/RISC-V/RISC-V定时器及中断"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">RISC-V 定时器及中断</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一总线简介" class="table-of-contents__link toc-highlight">一、总线简介</a><ul><li><a href="#1总线" class="table-of-contents__link toc-highlight">1、总线</a></li><li><a href="#2不同通信接口举例" class="table-of-contents__link toc-highlight">2、不同通信接口举例</a></li><li><a href="#3使用总线的优点" class="table-of-contents__link toc-highlight">3、使用总线的优点</a></li></ul></li><li><a href="#二fii-risc-v-cpu总线设计" class="table-of-contents__link toc-highlight">二、FII RISC-V CPU总线设计</a><ul><li><a href="#1学习总线设计" class="table-of-contents__link toc-highlight">1、学习总线设计</a></li><li><a href="#2fii-risc-v-总线设计" class="table-of-contents__link toc-highlight">2、FII RISC-V 总线设计</a></li><li><a href="#3读写操作分析" class="table-of-contents__link toc-highlight">3、读写操作分析</a></li><li><a href="#4代码" class="table-of-contents__link toc-highlight">4、代码</a></li></ul></li><li><a href="#三流水线介绍" class="table-of-contents__link toc-highlight">三、流水线介绍</a><ul><li><a href="#1状态机" class="table-of-contents__link toc-highlight">1、状态机</a></li><li><a href="#2流水线指令执行示例" class="table-of-contents__link toc-highlight">2、流水线指令执行示例</a></li><li><a href="#3流水线分类" class="table-of-contents__link toc-highlight">3、流水线分类</a></li><li><a href="#4流水线冲突" class="table-of-contents__link toc-highlight">4、流水线冲突</a></li></ul></li><li><a href="#四流水线cpu设计" class="table-of-contents__link toc-highlight">四、流水线CPU设计</a><ul><li><a href="#1解决流水线数据冲突" class="table-of-contents__link toc-highlight">1、解决流水线数据冲突</a></li><li><a href="#2pc跳转" class="table-of-contents__link toc-highlight">2、PC跳转</a></li><li><a href="#3数码管显示实例及仿真" class="table-of-contents__link toc-highlight">3、数码管显示实例及仿真</a></li><li><a href="#4uart串口输出实例及仿真" class="table-of-contents__link toc-highlight">4、UART串口输出实例及仿真</a></li><li><a href="#5长周期访存指令处理" class="table-of-contents__link toc-highlight">5、长周期访存指令处理</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Doongz Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.f9aa80d1.js"></script>
<script src="/assets/js/main.0ded408c.js"></script>
</body>
</html>