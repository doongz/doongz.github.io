<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Skill/ASM/RISC-V/RISC-V定时器及中断">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">RISC-V 定时器及中断 | Doongz&#x27;s Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doongz.github.io/docs/Skill/ASM/RISC-V/RISC-V定时器及中断"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="RISC-V 定时器及中断 | Doongz&#x27;s Site"><meta data-rh="true" name="description" content="来源：https://www.icfedu.cn/?s=RISC-V+%E5%AE%9A%E6%97%B6%E5%99%A8%E5%8F%8A%E4%B8%AD%E6%96%AD"><meta data-rh="true" property="og:description" content="来源：https://www.icfedu.cn/?s=RISC-V+%E5%AE%9A%E6%97%B6%E5%99%A8%E5%8F%8A%E4%B8%AD%E6%96%AD"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://doongz.github.io/docs/Skill/ASM/RISC-V/RISC-V定时器及中断"><link data-rh="true" rel="alternate" href="https://doongz.github.io/docs/Skill/ASM/RISC-V/RISC-V定时器及中断" hreflang="en"><link data-rh="true" rel="alternate" href="https://doongz.github.io/docs/Skill/ASM/RISC-V/RISC-V定时器及中断" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Doongz&#39;s Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Doongz&#39;s Site Atom Feed">





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.bbae31c2.css">
<link rel="preload" href="/assets/js/runtime~main.958a4673.js" as="script">
<link rel="preload" href="/assets/js/main.715bfe53.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Home page</b></a><a class="navbar__item navbar__link" href="/docs/catalogue-algo">Algorithm</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/catalogue-skill">Skill</a><a class="navbar__item navbar__link" href="/docs/catalogue-knowledge">Knowledge</a><a class="navbar__item navbar__link" href="/community/support">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Courses</a><ul class="dropdown__menu"><li><a href="https://github.com/doongz/mlc-ai" target="_blank" rel="noopener noreferrer" class="dropdown__link">Machine Learning Compilation<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/cs229" target="_blank" rel="noopener noreferrer" class="dropdown__link">Stanford CS229: Machine Learning<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/aics" target="_blank" rel="noopener noreferrer" class="dropdown__link">中国科学院 智能计算系统<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/cs50-ai" target="_blank" rel="noopener noreferrer" class="dropdown__link">Harvard CS50’s Introduction to AI with Python<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/mit-6.824" target="_blank" rel="noopener noreferrer" class="dropdown__link">MIT-6.824 Distributed Systems<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/os-workbench" target="_blank" rel="noopener noreferrer" class="dropdown__link">南京大学 操作系统：设计与实现<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/mit-6.s081" target="_blank" rel="noopener noreferrer" class="dropdown__link">MIT-6.S081 Operating Systems Engineering<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/doongz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/catalogue-skill">Catalogue</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Skill/ASM/RISC-V/汇编语言格式及ABI">ASM</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Skill/ASM/RISC-V/汇编语言格式及ABI">RISC-V</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/汇编语言格式及ABI">汇编语言格式及ABI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/RISC-V简介">RISC-V 简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/通用寄存器和指令">RISC-V 通用寄存器和指令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/扩展寄存器和指令">RISC-V 扩展寄存器和指令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/流水线&amp;硬件模块&amp;译码模块">流水线 &amp; 硬件模块 &amp; 译码模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/ALU模块&amp;branch模块">ALU 模块和 branch 模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/LOAD&amp;STORE-UNIT">LSU &amp; SRAM &amp; GPIO模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/CSR读写控制">CSR读写控制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/EXU模块和CPU运行">EXU模块和CPU运行</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/RISC-V总线和流水线">RISC-V 总线和流水线</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Skill/ASM/RISC-V/RISC-V定时器及中断">RISC-V 定时器及中断</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/riscv-asm-manual">RISC-V Assembly Programmer&#x27;s Manual</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/ASM/x86/X86-64汇编">x86</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/Android/Android概述">Android</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/C/基础知识/数据类型">C</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/C++/基础知识/基本数据类型">C++</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/Golang/基础知识/条件判断">Golang</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/Skill/LaTeX/">LaTex</a><button aria-label="Toggle the collapsible sidebar category &#x27;LaTex&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/Linux/POSIX">Linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/Skill/Markdown/">README</a><button aria-label="Toggle the collapsible sidebar category &#x27;README&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Skill/Mermaid/">mermaid</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/Python/运算符">Python</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/SQL/数据库理论">SQL</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/工具链/工具&amp;网站">工具链</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/常用CLI/docker-CLI">常用CLI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/设计模式/多态和多态性">设计模式</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">ASM</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">RISC-V</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">RISC-V 定时器及中断</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>RISC-V 定时器及中断</h1><p>来源：<a href="https://www.icfedu.cn/?s=RISC-V+%E5%AE%9A%E6%97%B6%E5%99%A8%E5%8F%8A%E4%B8%AD%E6%96%AD" target="_blank" rel="noopener noreferrer">https://www.icfedu.cn/?s=RISC-V+%E5%AE%9A%E6%97%B6%E5%99%A8%E5%8F%8A%E4%B8%AD%E6%96%AD</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一读写定时器中断寄存器">一、读写定时器中断寄存器<a class="hash-link" href="#一读写定时器中断寄存器" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1读定时器中断寄存器">1、读定时器中断寄存器<a class="hash-link" href="#1读定时器中断寄存器" title="Direct link to heading">​</a></h3><p>之前在<a href="https://www.icfedu.cn/archives/7742" target="_blank" rel="noopener noreferrer">RISC-V LSU，SRAM，GPIO模块（1）exu_lsu</a>模块中介绍过exu_lsu模块可以让RISC-V CPU访问外设模块，本文将介绍之前没有提到的exu_lsu模块下的子模块fii_timer_lsu。</p><p><img loading="lazy" alt="139" src="/assets/images/139-d4390b6147a3c366867df3bc1d6d3ed0.jpeg" width="1760" height="1226" class="img_ev3q"></p><p>首先，参考<a href="https://www.icfedu.cn/archives/7952" target="_blank" rel="noopener noreferrer">FII RISC-V Address Map</a>上对定时器中断(timer interrupt)有关的寄存器定义，如图1所示。可以看到有定时器控制寄存器，定时器值的低32位和高32位寄存器，及定时器比较值的低32位和高32位寄存器。其相关读(load)的代码在exu_lsu模块中，见下面代码：</p><p>图1 定时器中断寄存器</p><p><img loading="lazy" alt="139" src="/assets/images/140-bfc9b6a783c33fdb2be67b6d7fd69b5c.jpeg" width="665" height="261" class="img_ev3q"></p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">parameter [ 31: 0 ] TMR_BASEADDR = 32&#x27;h0200_0000//计时器中断寄存器基地址参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire t_sft_cs   = ( i_D_PC[ 31: 16 ] == TMR_BASEADDR[ 31: 16 ] ) ? 1&#x27;b1 : 1&#x27;b0;//定时器有关的寄存器片选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire sft_cs     = t_sft_cs &amp; ( ( ~i_D_PC[ 12 ] ) &amp; ( i_D_PC[ 5: 2 ] == 0 ) );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire tm_ctrl_cs = t_sft_cs &amp; ( ( ~i_D_PC[ 12 ] ) &amp; ( i_D_PC[ 5: 2 ] == 1 ) );//定时器控制寄存器片选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire t_cs0 = t_sft_cs &amp; ( ( ~i_D_PC[ 12 ] ) &amp; ( i_D_PC[ 5: 2 ] == 2 ) );//定时器值的低32位寄存器片选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire t_cs1 = t_sft_cs &amp; ( ( ~i_D_PC[ 12 ] ) &amp; ( i_D_PC[ 5: 2 ] == 3 ) );//定时器值的高32位寄存器片选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire tcmp_cs0 = t_sft_cs &amp; ( ( ~i_D_PC[ 12 ] ) &amp; ( i_D_PC[ 5: 2 ] == 4 ) );//定时器比较值的低32位寄存器片选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire tcmp_cs1 = t_sft_cs &amp; ( ( ~i_D_PC[ 12 ] ) &amp; ( i_D_PC[ 5: 2 ] == 5 ) );//定时器比较值的高32位寄存器片选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] ls_rb_d_t_sft = sft_cs     ? o_sft_int_v ://根据片选信号，确定要读的寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             ( tm_ctrl_cs ? o_tm_ctrl :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  ( t_cs0 ? i_timer_l :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  ( t_cs1 ? i_timer_h :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               ( tcmp_cs0 ? o_tcmp_l :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               ( tcmp_cs1 ? o_tcmp_h : o_CPU_dout ) ) ) ) );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] ls_rb_d = mem_cs ? mem_dout : ( GPIO_cs ? rb_GPIO_d : ( UART_cs ? o_UART_dout : ls_rb_d_t_sft ) );//根据片选信号，确定要读的寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always@( * )//省略了该代码块的部分代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ( i_LOAD )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin //&amp;mem_init_rdy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case ( i_load_instr ) // i_load_instr ={rv32i_lbu, rv32i_lb, rv32i_lhu, rv32i_lh, rv32i_lw};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    5&#x27;b00001:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin //rv32i_lw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_wb_data &lt;= ls_rb_d;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    5&#x27;b00010:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin //rv32i_lh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_wb_data &lt;= { { 16{ ls_rb_d[ 15 ] } }, ls_rb_d[ 15: 0 ] };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    5&#x27;b00100:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin //rv32i_lhu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_wb_data &lt;= { { 16{ 1&#x27;b0 } }, ls_rb_d[ 15: 0 ] };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    5&#x27;b01000:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin //rv32i_lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_wb_data &lt;= { { 24{ ls_rb_d[ 7 ] } }, ls_rb_d[ 7: 0 ] };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    5&#x27;b10000:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin //rv32i_lbu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_wb_data &lt;= { { 24{ 1&#x27;b0 } }, ls_rb_d[ 7: 0 ] };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default: ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">endcase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2写定时器中断寄存器">2、写定时器中断寄存器<a class="hash-link" href="#2写定时器中断寄存器" title="Direct link to heading">​</a></h3><p>定时器中断寄存器的写(store)是在fii_timer_lsu模块中完成的。通过从外层模块exu_lsu中引进的写使能信号，以及各个片选信号等，选择相应要写的寄存器。代码如下：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wire [31: 0] cpu_data_in = i_rs2_val &lt;&lt; {i_D_PC[1:0],3&#x27;b000};//exu_lsu模块中的cpu_data_in最后传递给了i_sft_timer_din</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always@( posedge clk or negedge rst_n )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ( !rst_n )//复位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_tm_ctrl &lt;= 0;//初始值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_sft_int_v &lt;= 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_timer_l &lt;= 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_timer_h &lt;= 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_tcmp_l &lt;= 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_tcmp_h &lt;= 16&#x27;h8000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_timer_valid &lt;= 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_timer_valid &lt;= 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ( i_tmr_sft_we )//写使能信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ( i_tcs0 )//定时器值的低32位寄存器片选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            o_timer_l &lt;= i_sft_timer_din;//写进定时器值的低32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            o_timer_valid[ 0 ] &lt;= 1&#x27;b1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ( i_tcs1 )//定时器值的高32位寄存器片选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            o_timer_h &lt;= i_sft_timer_din;//写进定时器值的高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            o_timer_valid[ 1 ] &lt;= 1&#x27;b1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ( i_tcmp_cs0 )//定时器比较值的低32位寄存器片选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            o_tcmp_l &lt;= i_sft_timer_din;//写进定时器比较值的低32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ( i_tcmp_cs1 )//定时器比较值的高32位寄存器片选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            o_tcmp_h &lt;= i_sft_timer_din;//写进定时器比较值的高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ( i_tm_ctrl_cs )//定时器控制寄存器片选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            o_tm_ctrl &lt;= i_sft_timer_din;//写进定时器控制寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二定时器中断产生">二、定时器中断产生<a class="hash-link" href="#二定时器中断产生" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1fii_irq_clint">1、fii_irq_clint<a class="hash-link" href="#1fii_irq_clint" title="Direct link to heading">​</a></h3><p>在写进定时器中断相关寄存器后，由模块exu_lsu向上一级级输出，最后在fii_riscv_cpu内传递给fii_irq_clint模块。irq表示interrupt request，意为中断请求。clint为core level interrupt，意为核心级中断。这里，该模块只产生两个中断请求，软件中断和定时器中断。因为软件中断比较简单，只需要写入软件中断寄存器就能发送软件中断请求，这里不做多的讨论。</p><p>fii_irq_clint接收到和定时器中断有关的信号后，直接传递给了下一级模块，fii_clint_top。fii_irq_clint代码如下：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">module fii_irq_clint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input sys_clk,//系统时钟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_sft_int_v,//软件中断寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_timer_l,//定时器低32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_timer_h,//定时器高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [ 31: 0 ] o_timer_l,//输出现在的定时器低32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [ 31: 0 ] o_timer_h,//输出现在的定时器高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_tcmp_l,//比较定时器低32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_tcmp_h,//比较定时器高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 1: 0 ] i_timer_valid,//两个bit分别控制定时器的低/高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_tm_ctrl,//定时器控制寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output clint_tmr_irq,//输出定时器中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output clint_sft_irq,//输出软件中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input l_clk,//低频时钟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input rst_n//复位信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fii_clint_top u_fii_clint_top (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .sys_clk       ( sys_clk ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_sft_int_v   ( i_sft_int_v ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_timer_l     ( i_timer_l ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_timer_h     ( i_timer_h ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_timer_l     ( o_timer_l ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_timer_h     ( o_timer_h ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_tcmp_l      ( i_tcmp_l ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_tcmp_h      ( i_tcmp_h ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_timer_valid ( i_timer_valid ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_tm_ctrl     ( i_tm_ctrl ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .l_clk         ( l_clk ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_mtip        ( clint_tmr_irq ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_msip        ( clint_sft_irq ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .rst_n         ( rst_n )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">endmodule</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2fii_clint_top">2、fii_clint_top<a class="hash-link" href="#2fii_clint_top" title="Direct link to heading">​</a></h3><p>在这个模块内，除了继续将有关定时器中断信号传给下一层模块fii_clint外，这里还做了一个l_clk的分频。从时钟的IP核可知，有两个主要使用的时钟频率，分别是50 MHz和8.3888 MHz，如图1所示。这里主要将50MHz的时钟作为系统时钟，也就是很多模块中出现的sys_clk。而8.3888 MHz的时钟则是上层模块fii_irq_clint引进来的l_clk。fii_clint_top代码如下：</p><p>图1 CPU时钟IP核</p><p><img loading="lazy" src="/assets/images/141-c14fdd19a2b57f73d5d7aad40e9fe9b0.jpeg" width="899" height="110" class="img_ev3q"></p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">module fii_clint_top (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input sys_clk,//系统时钟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input l_clk,//低频时钟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [31:0] i_sft_int_v,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [31:0] i_timer_l,//定时器低32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [31:0] i_timer_h,//定时器高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [31:0] o_timer_l,//输出现在的定时器低32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [31:0] o_timer_h,//输出现在的定时器高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [31:0] i_tcmp_l,//比较定时器低32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [31:0] i_tcmp_h,//比较定时器高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [1:0] i_timer_valid,//两个bit分别控制定时器的低/高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [31:0] i_tm_ctrl,//定时器控制寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output o_mtip,//输出定时器中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output o_msip,//输出软件中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input rst_n//复位信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg [7:0] rtc_r = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always @ (posedge l_clk)//在低频时钟下继续分频</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rtc_r &lt;= rtc_r + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg rtc_sys = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always @ (posedge sys_clk )//在高速系统时钟下抓取宽信号(128倍宽的rtc_r信号)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rtc_sys &lt;= rtc_r[7];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg [1:0] rtc_toggle = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always @ (posedge sys_clk or negedge rst_n)//在系统时钟下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if(!rst_n) rtc_toggle &lt;= 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else if(i_tm_ctrl[31])//如果控制寄存器有效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rtc_toggle &lt;= {rtc_toggle[0], rtc_sys};//抓取rtc_sys的移位信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire rtcTick = (rtc_toggle == 2&#x27;b01) ? 1&#x27;b1 : 1&#x27;b0;//如果rtc_sys有上升沿，rtcTick即拉高(256倍分频达到32.768 kHz)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fii_clint u_fii_clint (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .sys_clk       ( sys_clk ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_sft_int_v   ( i_sft_int_v ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_timer_l     ( i_timer_l ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_timer_h     ( i_timer_h ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_timer_l     ( o_timer_l ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_timer_h     ( o_timer_h ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_tcmp_l      ( i_tcmp_l ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_tcmp_h      ( i_tcmp_h ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_timer_valid ( i_timer_valid ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_tm_ctrl     ( i_tm_ctrl ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_mtip        ( o_mtip ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_msip        ( o_msip ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_rtcTick     ( rtcTick ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .rst_n         ( rst_n )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">endmodule</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3fii_clint">3、fii_clint<a class="hash-link" href="#3fii_clint" title="Direct link to heading">​</a></h3><p>真正产生中断请求的信号是发生在fii_clint模块下，代码如下：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">module fii_clint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input sys_clk,//系统时钟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_sft_int_v,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_timer_l,//定时器低32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_timer_h,//定时器高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [ 31: 0 ] o_timer_l,//输出现在的定时器低32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [ 31: 0 ] o_timer_h, //输出现在的定时器高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_tcmp_l,//比较定时器低32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_tcmp_h,//比较定时器高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 1: 0 ] i_timer_valid,//两个bit分别控制定时器的低/高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31:0 ] i_tm_ctrl,//定时器控制寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output o_mtip,//输出定时器中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output o_msip,//输出软件中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input i_rtcTick,//32.768 kHz时钟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input rst_n//复位信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg [ 31: 0 ] time_l;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reg [ 31: 0 ] time_h;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 63: 0 ] timer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] timecmp_l;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] timecmp_h;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire ipi_0; //soft interrupt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//生成定时器中断请求的条件：定时器寄存器的值是否超过比较定时器寄存器的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mtip = ( { time_h, time_l } &gt;= { timecmp_h, timecmp_l } ) ? 1&#x27;b1 : 1&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_msip = ipi_0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign timer  = { time_h, time_l } + 64&#x27;h1;//定时器寄存器 + 1 计数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always @( posedge sys_clk or negedge rst_n )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ( !rst_n )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time_l &lt;= 32&#x27;h0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ( i_timer_valid[ 0 ] )//低位bit控制定时器的低32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time_l &lt;= i_timer_l;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if ( i_rtcTick &amp; i_tm_ctrl[0]) // 在32.768 kHz的时钟和控制寄存器有效时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time_l &lt;= timer[ 31: 0 ];//锁存，使上面的定时器计数有效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always @( posedge sys_clk or negedge rst_n )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ( !rst_n )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time_h &lt;= 32&#x27;h0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ( i_timer_valid[ 1 ] )//高位bit控制定时器的高32位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time_h &lt;= i_timer_h;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if ( i_rtcTick &amp; i_tm_ctrl[0])// 在32.768 kHz的时钟和控制寄存器有效时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time_h &lt;= timer[ 63: 32 ];//锁存，使上面的定时器计数有效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//写进比较定时器寄存器的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign timecmp_l = i_tcmp_l;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign timecmp_h = i_tcmp_h;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign ipi_0     = i_sft_int_v[ 0 ];//输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_timer_l = time_l;//输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_timer_h = time_h;//输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">endmodule</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Skill/ASM/RISC-V/RISC-V总线和流水线"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">RISC-V 总线和流水线</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Skill/ASM/RISC-V/riscv-asm-manual"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">RISC-V Assembly Programmer&#x27;s Manual</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一读写定时器中断寄存器" class="table-of-contents__link toc-highlight">一、读写定时器中断寄存器</a><ul><li><a href="#1读定时器中断寄存器" class="table-of-contents__link toc-highlight">1、读定时器中断寄存器</a></li><li><a href="#2写定时器中断寄存器" class="table-of-contents__link toc-highlight">2、写定时器中断寄存器</a></li></ul></li><li><a href="#二定时器中断产生" class="table-of-contents__link toc-highlight">二、定时器中断产生</a><ul><li><a href="#1fii_irq_clint" class="table-of-contents__link toc-highlight">1、fii_irq_clint</a></li><li><a href="#2fii_clint_top" class="table-of-contents__link toc-highlight">2、fii_clint_top</a></li><li><a href="#3fii_clint" class="table-of-contents__link toc-highlight">3、fii_clint</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Doongz Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.958a4673.js"></script>
<script src="/assets/js/main.715bfe53.js"></script>
</body>
</html>