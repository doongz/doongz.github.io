<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Skill/ASM/RISC-V/CSR读写控制">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">CSR读写控制 | Doongz&#x27;s Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doongz.github.io/docs/Skill/ASM/RISC-V/CSR读写控制"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="CSR读写控制 | Doongz&#x27;s Site"><meta data-rh="true" name="description" content="来源：https://www.icfedu.cn/?s=RISC-V+CSR%E8%AF%BB%E5%86%99%E6%8E%A7%E5%88%B6"><meta data-rh="true" property="og:description" content="来源：https://www.icfedu.cn/?s=RISC-V+CSR%E8%AF%BB%E5%86%99%E6%8E%A7%E5%88%B6"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://doongz.github.io/docs/Skill/ASM/RISC-V/CSR读写控制"><link data-rh="true" rel="alternate" href="https://doongz.github.io/docs/Skill/ASM/RISC-V/CSR读写控制" hreflang="en"><link data-rh="true" rel="alternate" href="https://doongz.github.io/docs/Skill/ASM/RISC-V/CSR读写控制" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Doongz&#39;s Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Doongz&#39;s Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.99c6e2a1.css">
<link rel="preload" href="/assets/js/runtime~main.f9aa80d1.js" as="script">
<link rel="preload" href="/assets/js/main.0ded408c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Home page</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Notes</a><a class="navbar__item navbar__link" href="/community/support">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Courses</a><ul class="dropdown__menu"><li><a href="https://github.com/doongz/mlc-ai" target="_blank" rel="noopener noreferrer" class="dropdown__link">Machine Learning Compilation<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/cs229" target="_blank" rel="noopener noreferrer" class="dropdown__link">Stanford CS229: Machine Learning<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/aics" target="_blank" rel="noopener noreferrer" class="dropdown__link">中国科学院 智能计算系统<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/cs50-ai" target="_blank" rel="noopener noreferrer" class="dropdown__link">Harvard CS50’s Introduction to AI with Python<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/mit-6.824" target="_blank" rel="noopener noreferrer" class="dropdown__link">MIT-6.824 Distributed Systems<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/os-workbench" target="_blank" rel="noopener noreferrer" class="dropdown__link">南京大学 操作系统：设计与实现<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/mit-6.s081" target="_blank" rel="noopener noreferrer" class="dropdown__link">MIT-6.S081 Operating Systems Engineering<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/doongz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Tutorial Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Algorithm/前述/面试时做题技巧">Algorithm</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Competition/比赛">Competition</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Course/CMU-15-213">Course</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Knowledge/IC/IC">Knowledge</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Math/微积分/极限">Math</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Skill/ASM/RISC-V/汇编语言格式及ABI">Skill</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Skill/ASM/RISC-V/汇编语言格式及ABI">ASM</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Skill/ASM/RISC-V/汇编语言格式及ABI">RISC-V</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/汇编语言格式及ABI">汇编语言格式及ABI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/RISC-V简介">RISC-V 简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/通用寄存器和指令">RISC-V 通用寄存器和指令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/扩展寄存器和指令">RISC-V 扩展寄存器和指令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/流水线&amp;硬件模块&amp;译码模块">流水线 &amp; 硬件模块 &amp; 译码模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/ALU模块&amp;branch模块">ALU 模块和 branch 模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/LOAD&amp;STORE-UNIT">LSU &amp; SRAM &amp; GPIO模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Skill/ASM/RISC-V/CSR读写控制">CSR读写控制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/EXU模块和CPU运行">EXU模块和CPU运行</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/RISC-V总线和流水线">RISC-V 总线和流水线</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/RISC-V定时器及中断">RISC-V 定时器及中断</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/ASM/RISC-V/riscv-asm-manual">RISC-V Assembly Programmer&#x27;s Manual</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/ASM/x86/X86-64汇编">x86</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/Android/Android概述">Android</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/C/基础知识/数据类型">C</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/C++/基础知识/基本数据类型">C++</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/Golang/基础知识/条件判断">Golang</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/Skill/LaTeX/">LaTex</a><button aria-label="Toggle the collapsible sidebar category &#x27;LaTex&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/Linux/POSIX">Linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/Skill/Markdown/">README</a><button aria-label="Toggle the collapsible sidebar category &#x27;README&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/Mermaid/">mermaid</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/Python/运算符">Python</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/SQL/数据库理论">SQL</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/工具链/工具&amp;网站">工具链</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/常用CLI/docker-CLI">常用CLI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/设计模式/多态和多态性">设计模式</a></div></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Skill</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">ASM</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">RISC-V</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">CSR读写控制</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>CSR读写控制</h1><p>来源：<a href="https://www.icfedu.cn/?s=RISC-V+CSR%E8%AF%BB%E5%86%99%E6%8E%A7%E5%88%B6" target="_blank" rel="noopener noreferrer">https://www.icfedu.cn/?s=RISC-V+CSR%E8%AF%BB%E5%86%99%E6%8E%A7%E5%88%B6</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一exu_csr模块">一、exu_csr模块<a class="hash-link" href="#一exu_csr模块" title="Direct link to heading">​</a></h2><p>本文使用的代码是基于FII RISC-V V2.01(没有JTAG和总线)。有关CSR六条指令的复习见文章<a href="https://www.icfedu.cn/archives/6238" target="_blank" rel="noopener noreferrer">RISC-V CSR寄存器（1）CSR简介和CSR指令</a>，本文将从exu_csr模块开始介绍RISC-V CPU中如何控制CSR的读写。</p><p><img loading="lazy" src="/assets/images/102-a95c64cc7f84adfce4a14e07c038942e.jpeg" width="1822" height="1234" class="img_ev3q"></p><p><img loading="lazy" alt="103" src="/assets/images/103-46f9777eb1f237a8f3476b6173fe2af3.jpeg" width="1890" height="1114" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1输入输出">1、输入/输出<a class="hash-link" href="#1输入输出" title="Direct link to heading">​</a></h3><p>下面是比较重要的输入输出信号，相应的解释标在了代码段中。</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    input  sys_clk,              //系统时钟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  i_SYSTEM,             //CSR指令的opcode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  [ 31: 0 ] i_rs1_val,  //rs1的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  [ 4: 0 ]  i_rd_idx,   //rd的索引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  [ 5: 0 ]  i_csr_instr,//csr的指令(6条之一)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  [ 11: 0 ] i_csr_addr, //索引CSR寄存器的12位地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  [ 31: 0 ] i_csr_imm,  //零扩展后的立即数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  i_ext_irq,            //外部中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  i_sft_irq,            //软件中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  i_tmr_irq,            //计时器中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  i_irq_src,            //中断源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  i_exp_src,            //异常源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  [ 31: 0 ] i_exe_pc,   //执行的程序计数器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  [ 31: 0 ] i_ir,       //指令寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [ 31: 0 ]   o_irq_pc, //中断入口地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [ 31: 0 ]   o_mepc,   //中断返回后需要执行的PC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  i_mret_ena,           //中断返回使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//------------------------------省略与调试相关的信号-----------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  i_EXE_vld,            //执行有效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [ 31: 0 ] o_wr_csr_nxt,//写入CSR寄存器的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output o_rd_wen,             //CSR寄存器读使能，用于回写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [ 4: 0 ] o_wb_rd_idx, //回写索引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [ 31: 0 ] o_wb_data,  //回写数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output o_meie,               //外部中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output o_msie,               //软件中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output o_mtie,               //计时器中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output o_glb_irq,            //全局中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input  rst_n                 //复位</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看出，以上主要可以分为中断相关信号和CSR指令执行相关信号。和exu_alu模块类似，csr指令的执行也需要寄存器相关的索引和值。中断相关的信号主要有高层模块输入的中断/异常请求信号，和底部模块输出的中断使能，PC信号。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2执行">2、执行<a class="hash-link" href="#2执行" title="Direct link to heading">​</a></h3><p>代码主体部分是CSR的6条指令，代码的解释如下：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//--------------------省略部分信号的声明和赋值-------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// CSR指令按照如下排列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// i_csr_instr = {rv32i_csrrci, rv32i_csrrsi, rv32i_csrrwi,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                rv32i_csrrc,  rv32i_csrrs,  rv32i_csrrw};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 写入寄存器的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always @ ( * )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reg_csr_val &lt;= 32&#x27;b0;//初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ( i_SYSTEM &amp; csr_wen )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case ( i_csr_instr )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            6&#x27;h01:            //rv32i_csrrw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                reg_csr_val &lt;= i_rs1_val;              </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            6&#x27;h02:            //rv32i_csrrs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                reg_csr_val &lt;= i_rs1_val | w_csr_val;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            6&#x27;h04:            //rv32i_csrrc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                reg_csr_val &lt;= ( ~i_rs1_val ) &amp; w_csr_val; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            6&#x27;h08:            //rv32i_csrrwi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                reg_csr_val &lt;= i_csr_imm; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            6&#x27;h10:            //rv32i_csrrsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                reg_csr_val &lt;= i_csr_imm | w_csr_val;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            6&#x27;h20:            //rv32i_csrrci</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                reg_csr_val &lt;= ( ~i_csr_imm ) &amp; w_csr_val; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            default: ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        endcase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//CSR[11:10]/机器码的bit 30-31如果不为2‘b11，即为可读可写的属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire csr_wen  = i_EXE_vld &amp; i_SYSTEM &amp; (i_csr_addr[11:10] != 2&#x27;b11);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire csr_rden = i_EXE_vld &amp; i_SYSTEM;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上的代码用case选择，将CSR的指令进行区分以及写寄存器的实现。用以下代码举例</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">6’h02:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reg_csr_val &lt;= i_rs1_val | w_csr_val; //rv32i_csrrs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>i_csr_instr的bit 2对应的CSR指令是CSRRS rd，csr，rs1。t = CSRs<!-- -->[csr]<!-- -->; CSRs<!-- -->[csr]<!-- --> = t | x<!-- -->[rs1]<!-- -->; x<!-- -->[rd]<!-- --> = t</p><p>该指令是把CSR寄存器中的值读出并赋值到rd寄存器中，且将CSR寄存器中的值和寄存器rs1中的值按位或(bitwise OR)的结果写入CSR寄存器。</p><p><img loading="lazy" src="/assets/images/104-db77e24c6ec9244f044a26a42806c94a.jpeg" width="1730" height="678" class="img_ev3q"></p><p>其指令的机器码如图1所示。这里的实现CSR置位的功能是<em>reg_csr_val &lt;= i_rs1_val | w_csr_val;</em> </p><p>另外一部分CSR读寄存器的功能会在csr_reg模块里实现，之后讲到该模块时再进行解释。</p><p><img loading="lazy" src="/assets/images/105-a3e889301591cbcafef304999d9b4abc.jpeg" width="819" height="75" class="img_ev3q"></p><p>所有的CSR指令都是每次只能对一个CSR寄存器操作，其机器码如图1所示。可以看到CSR指令类似于I-type指令。虽然也有12位的立即数域，但是实际上<strong>机器码的bit 20-31是用来 索引相应CSR寄存器的地址</strong>。所以理论上，一共可以实现2^12 = 4096位CSR寄存器。</p><p><strong>按照惯例，CSR地址的高位(CSR<!-- -->[11:8]<!-- -->/机器码的bit 28-31)用于根据权限级别对CSR的读写可访问性进行编码。</strong></p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//CSR寄存器bit 10-11如果不为2‘b11即为可读可写的属性 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire csr_wen = i_EXE_vld &amp; i_SYSTEM &amp; (i_csr_addr[11:10] != 2&#x27;b11); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire csr_rden = i_EXE_vld &amp; i_SYSTEM;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p><strong>前两位(CSR<!-- -->[11:10]<!-- -->/机器码的bit 30-31)指示该CSR寄存器是可读可写(00，01或10)还是只读(11)。</strong></p></li><li><p><strong>接下来两位(CSR<!-- -->[9:8]<!-- -->/机器码的bit 28-29)编码表明可以访问该CSR寄存器的最低特权级别 <!-- -->[2]<!-- -->。</strong></p></li></ul><p>这里，通过wire csr_wen和wire csr_rden 信号的实现，对相应的CSR寄存器进行可读可写属性的区分。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3csr_reg实例">3、csr_reg实例<a class="hash-link" href="#3csr_reg实例" title="Direct link to heading">​</a></h3><p>exu_csr模块下由csr_reg模块的例化，很多exu_csr的输出信号由csr_reg模块传递上来，同样，一些exu_csr的输入信号，也继续往下传递到了csr_reg模块。详细代码见下图：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">csr_reg csr_reg_U</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .sys_clk        ( sys_clk ),//系统时钟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_mret_ena     ( i_mret_ena ),//中断返回使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_EXE_vld      ( i_EXE_vld ),//执行有效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//中断请求和中断源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_ext_irq      ( i_ext_irq ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_sft_irq      ( i_sft_irq ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_tmr_irq      ( i_tmr_irq ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_irq_src      ( i_irq_src &amp; o_glb_irq),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//异常源，异常PC和异常指令  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_exp_src      ( i_exp_src ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_exe_pc       ( i_exe_pc ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_ir           ( i_ir ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//中断PC和中断入口地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_irq_pc       ( o_irq_pc ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_mepc         ( o_mepc ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//------------------------------省略与调试相关的信号-----------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//CSR指令相关信号    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_csr_rden     ( csr_rden ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_csr_addr     ( i_csr_addr ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_csr_val      ( reg_csr_val ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .i_csr_wen      ( csr_wen ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_csr_val      ( w_csr_val ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//由mie，mstatus寄存器输出的中断使能信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_meie         ( o_meie ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_msie         ( o_msie ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_mtie         ( o_mtie ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .o_glb_irq      ( o_glb_irq ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .rst_n          ( rst_n )//复位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二csr_reg模块">二、csr_reg模块<a class="hash-link" href="#二csr_reg模块" title="Direct link to heading">​</a></h2><p>本文使用的代码是基于FII RISC-V V2.01(没有JTAG和总线)。csr_reg的上层模块见<a href="https://www.icfedu.cn/archives/7006" target="_blank" rel="noopener noreferrer">RISC-V CSR读写控制（1）exu_csr模块</a>，这里将主要介绍csr_reg模块，继续CSR读写控制的学习。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1输入输出-1">1、输入输出<a class="hash-link" href="#1输入输出-1" title="Direct link to heading">​</a></h3><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    input sys_clk,             //系统时钟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//---------------这里同样省略调试有关信号--------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input i_EXE_vld,           //执行有效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input i_ext_irq,           //外部中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input i_sft_irq,           //软件中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input i_tmr_irq,           //计时器中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input i_irq_src,           //中断源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input i_exp_src,           //异常源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_exe_pc,  //执行的程序计数器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_ir,      //指令寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [ 31: 0 ] o_mepc,   //中断返回后需要执行的PC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [ 31: 0 ] o_irq_pc, //中断入口地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input i_csr_rden,          //CSR寄存器可读</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 11: 0 ] i_csr_addr,//csr的指令(6条之一)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input [ 31: 0 ] i_csr_val, //CSR指令写到CSR寄存器的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input i_csr_wen,           //CSR寄存器可写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output [ 31: 0 ] o_csr_val,//CSR寄存器读出来的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output o_meie,             //外部中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output o_msie,             //软件中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output o_mtie,             //计时器中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output o_glb_irq,          //全局中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input rst_n                //复位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2执行-1">2、执行<a class="hash-link" href="#2执行-1" title="Direct link to heading">​</a></h3><p>代码主体中除了一些信号的声明和传递，还有对CSR寄存器的读，代码如下：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">assign o_csr_val = csr_reh_sel;  //CSR寄存器读出来的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always@( * )   //CSR 读取</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">case ( i_csr_addr &amp; { 12{ i_csr_rden } } )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;h300: csr_reh_sel = w_mstatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;h301: csr_reh_sel = w_misa;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;h304: csr_reh_sel = w_mie;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;h305: csr_reh_sel = w_mtvec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;h306: csr_reh_sel = w_mcounteren;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;hf11: csr_reh_sel = w_mvendorid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;hf12: csr_reh_sel = w_marchid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;hf13: csr_reh_sel = w_mimpid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;hf14: csr_reh_sel = w_mhartid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;h340: csr_reh_sel = w_mscratch;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;h341: csr_reh_sel = o_mepc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;h342: csr_reh_sel = w_mcause;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;h343: csr_reh_sel = w_mtval;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;h344: csr_reh_sel = w_mip;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;hb00: csr_reh_sel = w_mcycle_l;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;hb80: csr_reh_sel = w_mcycle_h;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;hb02: csr_reh_sel = w_minstret_l;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;hb82: csr_reh_sel = w_minstret_h;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;h7b0: csr_reh_sel = i_dcsr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;h7b1: csr_reh_sel = i_dpc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;h7b2: csr_reh_sel = i_dscratch;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default: csr_reh_sel = 32&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">endcase</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到，通过对CSR地址的索引和CSR可读属性的判断，在不同的case下，将不同CSR寄存器的值读出来。</p><p>注意：这里的case选择，虽然列出了21条，但是在每一次的CSR指令读取中，只会有一个确切的CSR寄存器被读取，也就是说，一条CSR指令只会根据需要的地址<strong>每次只执行一条</strong>case。</p><blockquote><p>case ( i_csr_addr &amp; { 12{ i_csr_rden } } )</p></blockquote><p>这个写法中 <em>{ 12{ i_csr_rden } }</em>的<em>i_csr_rden</em>原本是1bit的信号，这里把它扩展成12位，是为了便于和CSR地址运算。例如：</p><ul><li>如果该CSR寄存器可读，<em>i_csr_rden</em>为1，<em>{ 12{ i_csr_rden } }</em>即为12‘b1111_1111_1111，与 <em>i_csr_addr</em>相与得到的值，是 <em>i_csr_addr</em>本身，开始case选择；</li><li>如果该CSR寄存器不可读，<em>i_csr_rden</em>为0，<em>{ 12{ i_csr_rden } }</em>即为12‘b00000_0000_0000，与<em>i_csr_addr</em>相与得到的值为0，任何case都不满足，跳到default语句，也就是，将CSR寄存器读出的值赋0。</li></ul><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">assign o_glb_irq = w_mstatus[3];  //全局中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] vect_pc = {w_mtvec[ 31: 2 ], 2&#x27;b00} + {w_mcause[ 3: 0 ], 2&#x27;b00};  // Mode1，向量地址 = base + 4 X cause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_irq_pc = ( w_mtvec[ 1: 0 ] == 0 ) ? {w_mtvec[ 31: 2 ], 2&#x27;b00}://选择中断入口地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  ( w_mtvec[ 1 :0 ] == 1 ) ? vect_pc : o_irq_pc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire status_ena = w_mstatus[3] &amp; ( o_meie | o_mtie | o_msie ) &amp; i_irq_src;//发生中断</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的代码是关于输出全局中断使能<em>o_glb_irq</em>，传递<em>ststus_ena</em>中断发生信号给mstatus寄存器，用于MPIE和MIE位的判断。</p><p><em>o_irq_pc</em>是中断的入口地址，由<em>w_mtvec</em>的bit 0-1决定输出的Mode</p><ul><li>Mode为1时，中断入口地址是向量地址，由base基地址 + 4 X cause(由mcause寄存器决定)组成</li><li>Mode为0时，中断入口直接被赋值成base基地址</li><li>如果Mode等于2或者3，保留值，目前没有定义</li></ul><p><strong>注意：mtvec寄存器中 bit 2-31中只有30位的base基地址，因为默认中断跳转的地址都是4字节对齐 <!-- -->[1]<!-- -->。</strong>所以真正的中断入口地址，还需要左移2位，也就是上面代码中的<em>{w_mtvec<!-- -->[ 31: 2 ]<!-- -->, 2’b00}</em>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3csr寄存器实例">3、CSR寄存器实例<a class="hash-link" href="#3csr寄存器实例" title="Direct link to heading">​</a></h3><p>csr_reg模块下的实例由所有实现的CSR寄存器构成，有以下寄存器模块：</p><ul><li>csr_mtvec</li><li>csr_mstatus</li><li>csr_mtval</li><li>csr_mepc</li><li>csr_mcause</li><li>csr_mie</li><li>csr_mip</li><li>csr_misa</li><li>csr_mcounteren</li><li>csr_mid：包括mvendorid，marchid，mimpid和mhartid</li><li>csr_scratch：mscratch寄存器</li><li>csr_mcycle：包括低位和高位的32位寄存器，共组成64位</li><li>csr_minstret：包括低位和高位的32位寄存器，共组成64位</li><li>dug_csr：包括一些和调试有关的信号</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三csr寄存器实现">三、CSR寄存器实现<a class="hash-link" href="#三csr寄存器实现" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1寄存器模块">1、寄存器模块<a class="hash-link" href="#1寄存器模块" title="Direct link to heading">​</a></h3><p>要介绍的寄存器模块主要包括以下(其中的有些CSR寄存器没有完全实现)：</p><ul><li>csr_mtvec</li><li>csr_mstatus</li><li>csr_mtval</li><li>csr_mepc</li><li>csr_mcause</li><li>csr_mie</li><li>csr_mip</li><li>csr_misa</li><li>csr_mcounteren</li><li>csr_mid：包括mvendorid，marchid，mimpid和mhartid</li><li>csr_scratch：mscratch寄存器</li><li>csr_mcycle：包括低位和高位的32位寄存器，共组成64位</li><li>csr_minstret：包括低位和高位的32位寄存器，共组成64位</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csr_mtvec">csr_mtvec<a class="hash-link" href="#csr_mtvec" title="Direct link to heading">​</a></h4><p>mtvec是一个可读可写寄存器。虽然mtvec有两种模式，但这里只实现了MODE 0， 也就是说，所有的中断入口地址都是基地址。实现mtvec的寄存器的部分重要代码如下：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">input [ 11: 0 ] i_csr_addr, //索引寄存器的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input [ 31: 0 ] i_csr_val,  //CSR指令写到寄存器上的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_csr_wen,            //csr可写的属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [ 31: 0 ] o_mtvec,   //输出mtvec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire wbck_csr_wen = i_csr_wen; //确定该寄存器可写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire sel_mtvec = ( i_csr_addr == 12&#x27;h305 );     //通过地址索引确认寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire wr_mtvec = sel_mtvec &amp; i_csr_wen;          //确认该寄存器既可写，又的确是mtvec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire mtvec_ena = ( wr_mtvec &amp; wbck_csr_wen );   //确认mtvec寄存器可写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] mtvec_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] mtvec_nxt = { i_csr_val[ 31: 2 ] , 2&#x27;b00 }; //中断入口地址都是基地址， MODE == 2&#x27;b00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fii_dfflr #( 32 ) mtvec_dfflr ( mtvec_ena, mtvec_nxt, mtvec_r, sys_clk, rst_n ); //锁存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mtvec = mtvec_r; //输出</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csr_msatus">csr_msatus<a class="hash-link" href="#csr_msatus" title="Direct link to heading">​</a></h4><p>mstatus是一个可读可写寄存器。<strong>mstatus控制全局中断的使能</strong>。实现msatus的寄存器的部分重要代码如下(与上文重复的代码省略)：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">input i_mret_ena,        //中断返回</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_status_ena,      //由全局中断&amp;中断使能(包括计时器/外部/软件)&amp;中断源组成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [31:0] o_mstatus, //输出mstatus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire sel_mstatus = (i_csr_addr == 12&#x27;h300);   //通过地址索引确认寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire wr_mstatus = sel_mstatus &amp; wbck_csr_wen; //确认该寄存器既可写，又的确是mstatus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire status_mpie_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire status_mie_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 在以下情况更新MPIE位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire status_mpie_ena = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      // CSR指令写入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      wr_mstatus |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      // 中断返回</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      i_mret_ena |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      // 中断到来</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      i_status_ena;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire status_mpie_nxt = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      //中断来时，MPIE位更新为MIE位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      i_status_ena ? status_mie_r :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      // 中断返回时，MPIE设置成1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      i_mret_ena ? 1&#x27;b1 :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      // CSR指令写入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      wr_mstatus ? i_csr_val[7] : // MPIE是mstatus寄存器的bit 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      status_mpie_r; // 如果以上条件都不满足，MPIE不变</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fii_dfflr #(1) status_mpie_dfflr (status_mpie_ena, status_mpie_nxt, status_mpie_r, sys_clk, rst_n);//锁存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// MIE的实现与MPIE类似</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire status_mie_ena = status_mpie_ena; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire status_mie_nxt = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     // 中断来临时，MIE将值给MPIE，然后自己清零</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     i_status_ena ? 1&#x27;b0 :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     // 中断返回时，MIE得到存储在MPIE中的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     i_mret_ena ? status_mpie_r :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     // CSR指令写入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     wr_mstatus ? i_csr_val[3] : // MIE是mstatus寄存器的bit 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     status_mie_r; // 如果以上条件都不满足，MIE不变</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fii_dfflr #(1) status_mie_dfflr (status_mie_ena, status_mie_nxt, status_mie_r, sys_clk, rst_n);//锁存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//分别对mstatus的每一bit分开赋值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [31:0] status_tmp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[31]    = status_sd_r; // SD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[30:23] = 8&#x27;b0; // 保留</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[22:17] = 6&#x27;b0; // TSR--MPRV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[16:15] = status_xs_r; // XS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[14:13] = status_fs_r; // FS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[12:11] = 2&#x27;b11; // MPP </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[10:9]  = 2&#x27;b0; // 保留</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[8]     = 1&#x27;b0; // SPP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[7]     = status_mpie_r; // MPIE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[6]     = 1&#x27;b0; // 保留</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[5]     = 1&#x27;b0; // SPIE </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[4]     = 1&#x27;b0; // UPIE </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[3]     = status_mie_r; // MIE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[2]     = 1&#x27;b0; // 保留</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[1]     = 1&#x27;b0; // SIE </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign status_tmp[0]     = 1&#x27;b0; // UIE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mstatus = status_tmp;//输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csr_mtval">csr_mtval<a class="hash-link" href="#csr_mtval" title="Direct link to heading">​</a></h4><p>mtval也是可读可写的寄存器，<strong>用来存储引发异常的原因</strong>，比如非法指令，异常有关的信息等用来帮助软件处理，这里没有完全实现，只有基本的读写。在之前的定义中，是mbadaddr。相关的代码如下(与上文重复的代码省略)：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">input i_irq_src,          //中断源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_exp_src,          //异常源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input [ 31: 0 ] i_exe_pc, //当前的PC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input [ 31: 0 ] i_ir,     //当前的指令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [ 31: 0 ] o_mtval, //输出mtval</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire sel_mtval = ( i_csr_addr == 12&#x27;h343 ); //通过地址索引确认寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire mtval_ena;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] mtval_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] mtval_nxt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign mtval_nxt = trap_mtval_ena ? i_trap_mtval_val : i_csr_val;//如果是中断/异常，存储相关的信息，不然由CSR指令写入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fii_dfflr #( 32 ) mtval_dfflr ( mtval_ena, mtval_nxt, mtval_r, sys_clk, rst_n );//锁存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mtval = mtval_r;//输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">endmodule</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csr_mepc">csr_mepc<a class="hash-link" href="#csr_mepc" title="Direct link to heading">​</a></h4><p>mepc寄存器中存储在中断或异常发生时的<strong>准备执行指令</strong>的PC值，将在异常子程序中作为返回地址，是一个可读可写的寄存器。实现mepc寄存器的部分重要代码如下(与前面模块中重复的代码省略)：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">input i_irq_src,//中断源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_exp_src,//异常源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input [ 31: 0 ] i_exe_pc,//当前的PC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [ 31: 0 ] o_mepc,//输出mepc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] i_mepc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] mepc_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire mepc_valid = (i_irq_src | i_exp_src) ? 1&#x27;b1 : 1&#x27;b0;//中断或者异常到来</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign i_mepc = mepc_valid ? i_exe_pc : mepc_r;//如果有中断/异常到来，把PC设置成当前PC，否则用之前存储的mepc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire sel_mepc = ( i_csr_addr == 12&#x27;h341 );//通过地址索引确认寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire wr_mepc = sel_mepc &amp; i_csr_wen;// mepc寄存器可写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire mepc_ena = wr_mepc | mepc_valid;//使能由CSR指令写入或者中断/异常置起来</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] mepc_nxt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign mepc_nxt[ 31: 1 ] = mepc_valid ? i_mepc[ 31 : 1 ] : i_csr_val[ 31 : 1 ];//如果有中断，写入中断的返回地址，不然由CSR指令写入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign mepc_nxt[ 0 ] = 1&#x27;b0; // mepc的地址至少要以2字节对齐，不然可能会生成地址错位异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fii_dfflr #( 32 ) epc_dfflr ( mepc_ena, mepc_nxt, mepc_r, sys_clk, rst_n );//锁存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mepc = mepc_r;//输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csr_mcause">csr_mcause<a class="hash-link" href="#csr_mcause" title="Direct link to heading">​</a></h4><p>mcause是一个可读可写的寄存器，记录最近一次进入异常或者中断时间的原因，以记录号(异常代码)的方式服务于中断或异常子程序。其具体值的定义可参见<a href="https://www.icfedu.cn/archives/6318" target="_blank" rel="noopener noreferrer">RISC-V CSR寄存器（2）CSR寄存器</a>中的图8。</p><p>mcause也会与mtvec配合使用，如果mtvec的MODE为1， 那么中断的入口地址就会变成BASE + 4 X cause，这里的cause就是中断的异常代码(<strong>异常发生时，中断入口地址依然是基地址</strong>)。实现mcause寄存器的部分重要代码如下(与前面模块中重复的代码省略)：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">input i_irq_src,//中断源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_mie,//中断全局使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_meie,//机器模式下外部中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_mtie,//机器模式下计时器中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_msie,//机器模式下软件中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_sft_irq,//软件中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_tmr_irq,//计时器中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_ext_irq,//外部中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_EXE_vld,//是否为执行阶段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_exp_src,//异常源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//下面是一些异常，目前没有实现，在外层csr_reg模块中硬连线到0。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_iam_exp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_iaf_exp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_illi_exp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_bp_exp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_mti_exp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_lam_exp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_laf_exp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_saam_exp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_saaf_exp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [ 31: 0 ] o_mcause,//输出mcause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire m_is = i_mie &amp; i_msie &amp; i_sft_irq;//软件中断</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire m_it = i_mie &amp; i_mtie &amp; i_tmr_irq;//计时器中断</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire m_ie = i_mie &amp; i_meie &amp; i_ext_irq;//外部中断</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//=============================异常和中断==================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [31:0] exp_mcause;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//发生异常时，mcause最高位是0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign exp_mcause[31:5] = 27&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//根据异常的种类，置相应的位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign exp_mcause[4:0] = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         i_iam_exp  ? 5&#x27;d0 //Instruction address misaligned</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       : i_iaf_exp  ? 5&#x27;d1 //Instruction access fault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       : i_illi_exp ? 5&#x27;d2 //Illegal instruction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       : i_bp_exp   ? 5&#x27;d3 //Breakpoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       : i_lam_exp  ? 5&#x27;d4 //load address misalign</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       : i_laf_exp  ? 5&#x27;d5 //load access fault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       : i_saam_exp ? 5&#x27;d6 //Store/AMO address misalign</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       : i_saaf_exp ? 5&#x27;d7 //Store/AMO access fault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       : 5&#x27;h1F; //Otherwise a reserved value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [31:0] irq_mcause;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//发生中断时，mcause最高位是1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign irq_mcause[31] = 1&#x27;b1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign irq_mcause[30:4] = 27&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//根据中断的种类，置相应的位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign irq_mcause[3:0] = m_is ? 4&#x27;d3 : // 3 Machine software interrupt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         m_it ? 4&#x27;d7 : // 7 Machine timer interrupt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         m_ie ? 4&#x27;d11 : // 11 Machine external interrupt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         4&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [31:0] mcause_val = i_irq_src ? irq_mcause : exp_mcause;//判断中断还是异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//===============================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire mcause_valid = (i_irq_src | i_exp_src) ? 1&#x27;b1 : 1&#x27;b0;//中断/异常是否发生</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire sel_mcause = (i_csr_addr == 12&#x27;h342);//通过地址索引确认寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [31:0] mcause_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [31:0] mcause_nxt = mcause_valid ? mcause_val : i_csr_val;//如果中断/异常发生， mcause被赋值成中断/异常的原因，否则被CSR指令写入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fii_dfflr #(32) mcause_dfflr (mcause_ena, mcause_nxt, mcause_r, sys_clk, rst_n);//锁存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mcause = mcause_r;//输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csr_mie">csr_mie<a class="hash-link" href="#csr_mie" title="Direct link to heading">​</a></h4><p>mie寄存器是可读可写的，用于进一步对不同中断的分别使能控制，注意将其与mstatus的位MIE分开。实现mie寄存器的部分重要代码如下(与前面模块中重复的代码省略)：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">output [ 31: 0 ] o_mie,//输出mie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output o_meie,//输出机器模式下外部中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output o_msie,//输出机器模式下软件中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output o_mtie,//输出机器模式下计时器中断使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire sel_mie = ( i_csr_addr == 12&#x27;h304 );//通过地址索引确认寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] mie_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] mie_nxt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign mie_nxt[ 31: 12 ] = 20&#x27;b0;//将其他的位硬连线到0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign mie_nxt[ 11 ]     = i_csr_val[ 11 ]; //o_meie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign mie_nxt[ 10: 8 ]  = 3&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign mie_nxt[ 7 ]      = i_csr_val[ 7 ]; //o_mtie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign mie_nxt[ 6: 4 ]   = 3&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign mie_nxt[ 3 ]      = i_csr_val[ 3 ]; //o_msie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign mie_nxt[ 2: 0 ]   = 3&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fii_dfflr #( 32 ) mie_dfflr ( mie_ena, mie_nxt, mie_r, sys_clk, rst_n );//锁存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mie = mie_r;//输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//单独将重要的中断使能位输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_meie = o_mie[ 11 ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mtie = o_mie[ 7 ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_msie = o_mie[ 3 ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csr_mip">csr_mip<a class="hash-link" href="#csr_mip" title="Direct link to heading">​</a></h4><p>mip是中断悬挂寄存器，当中断请求到来时，mip相应的位就会被置高。</p><p>mip寄存器虽然定义上是可读可写的，但在这里使用的MEIP，MSIP和MTIP都是只读的。实现mip寄存器的部分重要代码如下(与前面模块中重复的代码省略)：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">input i_sft_irq,//软件中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_tmr_irq,//计时器中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_ext_irq,//外部中断请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [ 31: 0 ] o_mip,//输出mip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire sel_mip = ( i_csr_addr == 12&#x27;h344 );//通过地址索引确认寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire meip_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire msip_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire mtip_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//只要有中断请求，相应的中断悬挂位就会置起来</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign meip_r = i_ext_irq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign msip_r = i_sft_irq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign mtip_r = i_tmr_irq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//将mip中的位分别赋值。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [ 31: 0 ] ip_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign ip_r[ 31: 12 ] = 20&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign ip_r[ 11 ]     = meip_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign ip_r[ 10: 8 ]  = 3&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign ip_r[ 7 ]      = mtip_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign ip_r[ 6: 4 ]   = 3&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign ip_r[ 3 ]      = msip_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign ip_r[ 2: 0 ]   = 3&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mip = ip_r;//输出</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csr_misa">csr_misa<a class="hash-link" href="#csr_misa" title="Direct link to heading">​</a></h4><p>misa寄存器可读可写，存储RISC-V CPU的信息，比如架构和支持的基本/压缩指令集。实现misa寄存器的部分重要代码如下(与上文重复的代码省略)：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">output [31:0] o_misa//输出misa寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_misa = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2&#x27;b1 // 最高两位为2b&#x27;01表示为32位架构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,4&#x27;b0 // WIRI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 25 Z Reserved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 24 Y Reserved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 23 X Non-standard extensions present</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 22 W Reserved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 21 V Tentatively reserved for Vector extension 20 U User mode implemented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 20 U User mode implemented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 19 T Tentatively reserved for Transactional Memory extension</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 18 S Supervisor mode implemented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 17 R Reserved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 16 Q Quad-precision floating-point extension</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 15 P Tentatively reserved for Packed-SIMD extension</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 14 O Reserved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 13 N User-level interrupts supported</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 12 M Integer Multiply/Divide extension</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 11 L Tentatively reserved for Decimal Floating-Point extension</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 10 K Reserved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 9 J Reserved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b1 // &lt;= 8 I RV32I/64I/128I base ISA//目前实现的基本指令集是RV32I，32位整型的指令集</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 7 H Hypervisor mode implemented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 6 G Additional standard extensions present</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 5 F Single-precision floating-point extension</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 4 E RV32E base ISA </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 3 D Double-precision floating-point extension</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 2 C Compressed extension</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 1 B Tentatively reserved for Bit operations extension</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">,1&#x27;b0 // 0 A Atomic extension</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csr_mcounteren">csr_mcounteren<a class="hash-link" href="#csr_mcounteren" title="Direct link to heading">​</a></h4><p>mcounteren寄存器是可读可写的，每一位分别对应一组计数器，无论CSR指令写入什么值，相应的计数器不受影响。mcounteren控制的是下一个特权级别是否能读出相应的计数器，如果相应的位为0，则尝试读出计数器会引起非法指令异常。如下图所示。</p><p>因为这里只实现了机器模式，所以没有用mcounteren。这里只实现了mcounteren的读写。实现mcounteren寄存器的部分重要代码如下(与上文重复的代码省略)：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">output [ 31: 0 ] o_mcounteren,//输出mcounteren</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire mcounteren_ena = (i_csr_wen &amp; (i_csr_addr == 12&#x27;h306));//通过地址索引确认寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [31:0] mcounteren_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [31:0] mcounteren_nxt = i_csr_val;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fii_dfflr #(32) mtvec_dfflr (mcounteren_ena, mcounteren_nxt, mcounteren_r, sys_clk, rst_n);//锁存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mcounteren = mcounteren_r;//输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csr_mid">csr_mid<a class="hash-link" href="#csr_mid" title="Direct link to heading">​</a></h4><p>csr_mid模块中组合了很多和ID相关的寄存器，有mvendorid，marchid，mimpid和mhartid。这四个寄存器都是只读的。寄存器的具体含义参考<a href="https://www.icfedu.cn/archives/6318" target="_blank" rel="noopener noreferrer">RISC-V CSR寄存器（2）CSR寄存器</a>中的<strong>1.7-1.10</strong>。寄存器实现的部分重要代码如下(与上文重复的代码省略)：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">output [31:0] o_mvendorid, //输出mvendorid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [31:0] o_marchid,   //输出marchid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [31:0] o_mimpid,    //输出mimpid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output [31:0] o_mhartid    //输出mhartid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//以下的三个ID没有完全实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mvendorid = 32&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_marchid   = 32&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mimpid    = 32&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mhartid   = 32&#x27;b0;//hart ID为0表示CPU是单核</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csr_scratch">csr_scratch<a class="hash-link" href="#csr_scratch" title="Direct link to heading">​</a></h4><p>mscratch寄存器是机器模式下可读可写，没有指定的用法。实现mscratch寄存器的部分重要代码如下(与上文重复的代码省略)：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">output [ 31: 0 ] o_mscratch, //输出mscratch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire mscratch_ena = (i_csr_wen &amp; (i_csr_addr == 12&#x27;h340)); //通过地址索引确认寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [31:0] mscratch_r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire [31:0] mscratch_nxt = i_csr_val;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fii_dfflr #(32) mtvec_dfflr (mscratch_ena, mscratch_nxt, mscratch_r, sys_clk, rst_n);//锁存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assign o_mscratch = mscratch_r;//输出</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csr_mcycle">csr_mcycle<a class="hash-link" href="#csr_mcycle" title="Direct link to heading">​</a></h4><p>csr_mcylce模块包括mcycle和mcycleh两个寄存器，用于计数过了多少个时钟周期。两个32位计数器组成一个64位的计数器。实现计数器的部分重要代码如下(与上文重复的代码省略)：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//调试相关信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_dbg_mode,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_dbg_stpcyl,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output reg [ 31: 0 ] o_mcycle_l,//输出mcycle寄存器，低32位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output reg [ 31: 0 ] o_mcycle_h,//输出mcycleh寄存器，高32位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire dbg_stop = i_dbg_mode &amp; i_dbg_stpcyl;//调试开始</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always@( posedge sys_clk or negedge rst_n )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ( !rst_n )//如果没有复位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_mcycle_l &lt;= 32&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_mcycle_h &lt;= 32&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else if ( i_csr_wen )//CSR寄存器可写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case ( i_csr_addr )//CSR指令写入，根据地址索引到低位/高位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;hb00: o_mcycle_l &lt;= i_csr_val;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;hb80: o_mcycle_h &lt;= i_csr_val;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default: ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endcase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ( !dbg_stop )//如果不处于调试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ( o_mcycle_l == 32&#x27;hffff_ffff )//如果低32位寄存器已满</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            o_mcycle_h &lt;= o_mcycle_h + 1;//高位进位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            o_mcycle_l &lt;= 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            o_mcycle_l &lt;= o_mcycle_l + 1;//低32位的寄存器加1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csr_minstret">csr_minstret<a class="hash-link" href="#csr_minstret" title="Direct link to heading">​</a></h4><p>csr_minstret模块与上面的csr_mcycle模块类似，包括minstret和minstreth两个32位寄存器，用来组成一个64位寄存器。minstret和minstreth主要用来计数已经执行过的指令。实现寄存器的部分重要代码如下(与上文重复的代码省略)：</p><div class="language-verilog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-verilog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">input i_EXE_vld,//判断是否处在执行阶段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//调试相关信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_dbg_mode,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input i_dbg_stpcyl,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output reg [ 31: 0 ] o_minstret_l,//输出mintret寄存器，低32位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output reg [ 31: 0 ] o_minstret_h,//输出minstreth寄存器，高32位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wire dbg_stop = i_dbg_mode &amp; i_dbg_stpcyl;//调试开始</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">always@( posedge sys_clk or negedge rst_n )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if ( !rst_n )//如果没有复位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_minstret_l &lt;= 32&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    o_minstret_h &lt;= 32&#x27;b0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else if ( i_csr_wen )//CSR寄存器可写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case ( i_csr_addr )//CSR指令写入，根据地址索引到低位/高位寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;hb02: o_minstret_l &lt;= i_csr_val;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12&#x27;hb82: o_minstret_h &lt;= i_csr_val;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default: ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endcase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else if ( ( i_EXE_vld ) &amp;&amp; ( dbg_stop == 1&#x27;b0 ) )//如果不处于调试，且在执行阶段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ( o_minstret_l == 32&#x27;hffff_ffff )//如果低32位寄存器已满</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_minstret_l &lt;= 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_minstret_h &lt;= o_minstret_h + 1;//高位进位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        o_minstret_l &lt;= o_minstret_l + 1;//低32位的寄存器加1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Skill/ASM/RISC-V/LOAD&amp;STORE-UNIT"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">LSU &amp; SRAM &amp; GPIO模块</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Skill/ASM/RISC-V/EXU模块和CPU运行"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">EXU模块和CPU运行</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一exu_csr模块" class="table-of-contents__link toc-highlight">一、exu_csr模块</a><ul><li><a href="#1输入输出" class="table-of-contents__link toc-highlight">1、输入/输出</a></li><li><a href="#2执行" class="table-of-contents__link toc-highlight">2、执行</a></li><li><a href="#3csr_reg实例" class="table-of-contents__link toc-highlight">3、csr_reg实例</a></li></ul></li><li><a href="#二csr_reg模块" class="table-of-contents__link toc-highlight">二、csr_reg模块</a><ul><li><a href="#1输入输出-1" class="table-of-contents__link toc-highlight">1、输入输出</a></li><li><a href="#2执行-1" class="table-of-contents__link toc-highlight">2、执行</a></li><li><a href="#3csr寄存器实例" class="table-of-contents__link toc-highlight">3、CSR寄存器实例</a></li></ul></li><li><a href="#三csr寄存器实现" class="table-of-contents__link toc-highlight">三、CSR寄存器实现</a><ul><li><a href="#1寄存器模块" class="table-of-contents__link toc-highlight">1、寄存器模块</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Doongz Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.f9aa80d1.js"></script>
<script src="/assets/js/main.0ded408c.js"></script>
</body>
</html>