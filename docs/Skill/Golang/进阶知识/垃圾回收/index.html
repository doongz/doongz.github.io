<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Skill/Golang/进阶知识/垃圾回收">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Golang GC | Doongz&#x27;s Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doongz.github.io/docs/Skill/Golang/进阶知识/垃圾回收"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Golang GC | Doongz&#x27;s Site"><meta data-rh="true" name="description" content="参考一：Go GC"><meta data-rh="true" property="og:description" content="参考一：Go GC"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://doongz.github.io/docs/Skill/Golang/进阶知识/垃圾回收"><link data-rh="true" rel="alternate" href="https://doongz.github.io/docs/Skill/Golang/进阶知识/垃圾回收" hreflang="en"><link data-rh="true" rel="alternate" href="https://doongz.github.io/docs/Skill/Golang/进阶知识/垃圾回收" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Doongz&#39;s Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Doongz&#39;s Site Atom Feed">





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.bbae31c2.css">
<link rel="preload" href="/assets/js/runtime~main.a61035f3.js" as="script">
<link rel="preload" href="/assets/js/main.7aad8990.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Home page</b></a><a class="navbar__item navbar__link" href="/docs/catalogue-algo">Algorithm</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/catalogue-skill">Skill</a><a class="navbar__item navbar__link" href="/docs/catalogue-knowledge">Knowledge</a><a class="navbar__item navbar__link" href="/community/support">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Courses</a><ul class="dropdown__menu"><li><a href="https://github.com/doongz/mlc-ai" target="_blank" rel="noopener noreferrer" class="dropdown__link">Machine Learning Compilation<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/cs229" target="_blank" rel="noopener noreferrer" class="dropdown__link">Stanford CS229: Machine Learning<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/aics" target="_blank" rel="noopener noreferrer" class="dropdown__link">中国科学院 智能计算系统<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/cs50-ai" target="_blank" rel="noopener noreferrer" class="dropdown__link">Harvard CS50’s Introduction to AI with Python<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/mit-6.824" target="_blank" rel="noopener noreferrer" class="dropdown__link">MIT-6.824 Distributed Systems<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/os-workbench" target="_blank" rel="noopener noreferrer" class="dropdown__link">南京大学 操作系统：设计与实现<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/mit-6.s081" target="_blank" rel="noopener noreferrer" class="dropdown__link">MIT-6.S081 Operating Systems Engineering<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/doongz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/catalogue-skill">Catalogue</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/ASM/RISC-V/汇编语言格式及ABI">ASM</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/Android/Android概述">Android</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/C/基础知识/数据类型">C</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/C++/基础知识/基本数据类型">C++</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Skill/Golang/基础知识/条件判断">Golang</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/Golang/基础知识/条件判断">基础知识</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/Golang/Go语言并发/go&amp;chan">Go语言并发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Skill/Golang/进阶知识/垃圾回收">进阶知识</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Skill/Golang/进阶知识/垃圾回收">Golang GC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/Golang/进阶知识/go-tool">go-tool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Skill/Golang/进阶知识/runtime">Go runtime</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Skill/Golang/实用函数/计时器">实用函数</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/Skill/LaTeX/">LaTex</a><button aria-label="Toggle the collapsible sidebar category &#x27;LaTex&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/Linux/POSIX">Linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/Skill/Markdown/">README</a><button aria-label="Toggle the collapsible sidebar category &#x27;README&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Skill/Mermaid/">mermaid</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/Python/运算符">Python</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/SQL/数据库理论">SQL</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/工具链/工具&amp;网站">工具链</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/常用CLI/docker-CLI">常用CLI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Skill/设计模式/多态和多态性">设计模式</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Golang</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">进阶知识</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Golang GC</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Golang GC</h1><p>参考一：<a href="https://blog.csdn.net/weixin_40242845/article/details/114744783" target="_blank" rel="noopener noreferrer">Go GC</a></p><p>参考二：<a href="https://www.jianshu.com/p/4c5a303af470" target="_blank" rel="noopener noreferrer">[典藏版]Golang三色标记、混合写屏障GC模式图文全分析</a></p><p>参考三：<a href="https://mp.weixin.qq.com/s/o2oMMh0PF5ZSoYD0XOBY2Q" target="_blank" rel="noopener noreferrer">【重要】Go GC 20 问</a></p><p>参考四：<a href="https://www.jianshu.com/p/4a972dc959ca" target="_blank" rel="noopener noreferrer">GoGC整理</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一garbage-collection">一、Garbage Collection<a class="hash-link" href="#一garbage-collection" title="Direct link to heading">​</a></h2><p>GC，全称 GarbageCollection，即垃圾回收，是一种自动内存管理的机制。</p><p><strong>当程序向操作系统申请的内存不再需要时，垃圾回收主动将其回收并供其他代码进行内存申请时候复用，或者将其归还给操作系统，这种针对内存级别资源的自动回收过程，即为垃圾回收</strong>。而负责垃圾回收的程序组件，即为垃圾回收器。</p><p>垃圾回收其实一个完美的 “Simplicity is Complicated” 的例子。一方面，程序员受益于 GC，无需操心、也不再需要对内存进行手动的申请和释放操作，GC 在程序运行时自动释放残留的内存。另一方面，GC 对程序员几乎不可见，仅在程序需要进行特殊优化时，通过提供可调控的 API，对 GC 的运行时机、运行开销进行把控的时候才得以现身。</p><p>通常，垃圾回收器的执行过程被划分为两个半独立的组件：</p><ul><li>赋值器（Mutator）：这一名称本质上是在指代用户态的代码。因为对垃圾回收器而言，用户态的代码仅仅只是在修改对象之间的引用关系，也就是在对象图（对象之间引用关系的一个有向图）上进行操作。</li><li>回收器（Collector）：负责执行垃圾回收的代码。</li></ul><p>从原理上而言，所有的语言都能够自行实现 GC。从语言诞生之初就提供 GC 的语言，例如：Python、JavaScript、Java、Objective-C、Swift</p><p>而不以 GC 为目标，被直接设计为手动管理内存、但可以自行实现 GC 的语言有：C、C++</p><p>也有一些语言可以在编译期，依靠编译器插入清理代码的方式，实现精准的清理，例如：Rust</p><p><strong>GC 的优势</strong>：垃圾回收使程序员无需手动处理内存释放，从而能够消除一些需要手动管理内存才会出现的运行时错误：</p><ul><li>在仍然有指向内存区块的指针的情况下释放这块内存时，会产生悬挂指针，从而后续可能错误的访问已经用于他用的内存区域。</li><li>多重释放同一块申请的内存区域可能导致不可知的内存损坏。</li></ul><p>当然，垃圾回收也会伴随一些缺陷，这也就造就了<strong>没有 GC 的一些优势</strong>：</p><ul><li>没有额外的性能开销</li><li>精准的手动内存管理，极致的利用机器的性能</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1垃圾回收器组件">1、垃圾回收器组件<a class="hash-link" href="#1垃圾回收器组件" title="Direct link to heading">​</a></h3><p>垃圾回收器分为两个半独立的组件</p><ul><li>赋值器 Mutator：对用户态对象图进行操作(上色)</li><li>回收器 Collector：负责执行垃圾回收(回收)</li></ul><p>用户程序Mutator通过内存分配器Allocator在堆Heap上申请内存，垃圾回收器Collector会定时清理堆上的内存。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2垃圾回收器的目标">2、垃圾回收器的目标<a class="hash-link" href="#2垃圾回收器的目标" title="Direct link to heading">​</a></h3><ul><li>无内存泄漏：垃圾回收器最基本的目标就是减少防止程序员未及时释放导致的内存泄漏，垃圾回收器会识别并清理内存中的垃圾</li><li>自动回收无用内存：垃圾回收器作为独立的子任务，不需要程序员显式调用即可自动清理内存垃圾</li><li>内存整理：如果只是简单回收无用内存，那么堆上的内存空间会存在较多碎片而无法满足分配较大对象的需求，因此垃圾回收器需要重整内存空间，提高内存利用率</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3根对象">3、根对象<a class="hash-link" href="#3根对象" title="Direct link to heading">​</a></h3><p>根对象在垃圾回收的术语中又叫做根集合，它是垃圾回收器在标记过程时最先检查的对象，包括：</p><ol><li>全局变量：程序在编译期就能确定的那些存在于程序整个生命周期的变量。</li><li>执行栈：每个 goroutine 都包含自己的执行栈，这些执行栈上包含栈上的变量及指向分配的堆内存区块的指针。</li><li>寄存器：寄存器的值可能表示一个指针，参与计算的这些指针可能指向某些赋值器分配的堆内存区块。</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4常见的gc问题">4、常见的GC问题<a class="hash-link" href="#4常见的gc问题" title="Direct link to heading">​</a></h3><ol><li>对停顿敏感，GC导致用户只需代码滞后</li><li>对资源消耗敏感，频繁分配内存应用，导致频繁垃圾回收，影响用户代码CPU利用</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="解决示例">解决示例<a class="hash-link" href="#解决示例" title="Direct link to heading">​</a></h4><ol><li>合理化内存分配的速度、提高赋值器的 CPU 利用率，例如合理创建routine</li><li>降低并复用已经申请的内存</li><li>调整GOGC值：如果我们在遇到海量请求的时，为了避免 GC 频繁触发，可以通过将 GOGC 的值设置得更大，让 GC 触发的时间变得更晚，从而减少其触发频率</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5触发机制">5、触发机制<a class="hash-link" href="#5触发机制" title="Direct link to heading">​</a></h3><ul><li>主动触发：runtime GC，阻塞式等待当前GC调用完成</li><li>被动触发：<ul><li>系统监控，超过2分钟没有引用就强制GC</li><li>步调(Pacing算法)，控制内存增长的比例</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="6stw">6、STW<a class="hash-link" href="#6stw" title="Direct link to heading">​</a></h3><p><code>STW</code> 是 <code>StoptheWorld</code> 的缩写，即万物静止，是指在垃圾回收过程中为了保证实现的正确性、防止无止境的内存增长等问题而不可避免的需要停止赋值器进一步操作对象图的一段过程。</p><p>在这个过程中整个用户代码被停止或者放缓执行， <code>STW</code> 越长，对用户代码造成的影响（例如延迟）就越大，早期 Go 对垃圾回收器的实现中 <code>STW</code> 长达几百毫秒，对时间敏感的实时通信等应用程序会造成巨大的影响。我们来看一个例子：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;runtime&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Millisecond</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;OK&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的这个程序在 Go 1.14 以前永远都不会输出 <code>OK</code>，其罪魁祸首是 STW 无限制的被延长。</p><p>尽管 STW 如今已经优化到了半毫秒级别以下，但这个程序被卡死原因在于仍然是 STW 导致的。原因在于，GC 在进入 STW 时，需要等待让所有的用户态代码停止，但是 <code>for{}</code> 所在的 goroutine 永远都不会被中断，从而停留在 STW 阶段。实际实践中也是如此，当程序的某个 goroutine 长时间得不到停止，强行拖慢 STW，这种情况下造成的影响（卡死）是非常可怕的。好在自 Go 1.14 之后，这类 goroutine 能够被异步地抢占，从而使得 STW 的时间如同普通程序那样，不会超过半个毫秒，程序也不会因为仅仅等待一个 goroutine 的停止而停顿在 STW 阶段。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二常见-gc-算法">二、常见 GC 算法<a class="hash-link" href="#二常见-gc-算法" title="Direct link to heading">​</a></h2><p>常见GC分为两大类：</p><ul><li>追踪法(tracing)：从根对象出发，根据对象之间的引用信息，扫描，直到确定要保留的对象，回收无引用对象。一般是GO，JAVA，V8等</li><li>引用计数法：每个对象自身包含一个计数器，当计数器归零的自动回收。一般是Python，object-C等</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1追踪法">1、追踪法<a class="hash-link" href="#1追踪法" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1标记清扫">1）标记清扫<a class="hash-link" href="#1标记清扫" title="Direct link to heading">​</a></h4><p>标记-清除算法将垃圾回收分为两个阶段：标记阶段和清除阶段。</p><p>一种可行的实现是，在标记阶段，首先通过根节点，标记所有从根节点开始的可达对象。因此，未被标记的对象就是未被引用的垃圾对象。然后，在清除阶段，清除所有未被标记的对象。<strong>这也是GO的GC算法的基础</strong></p><p><img loading="lazy" src="/assets/images/gc-1-b299c67a2ad37e884c8f46e1be9a84e2.png" width="1647" height="689" class="img_ev3q"></p><p>优点：</p><ul><li>以解决循环调用问题</li></ul><p>缺点：</p><ul><li>效率较慢，因为在标记和清除时都要遍历所有的对象，并且在每次GC开始的时候都要STW</li><li>因为内存分配时的碎片化，导致在回收之后也会有不同程度的碎片化，导致内存利用率不高</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2标记压缩">2）标记压缩<a class="hash-link" href="#2标记压缩" title="Direct link to heading">​</a></h4><p>它在标记-清除算法的基础上做了一些优化。和标记-清除算法一样，标记-压缩算法也首先需要从根节点开始，对所有可达对象做一次标记。但之后，它并不简单的清理未标记的对象，而是将所有的存活对象压缩到内存的一端。之后，清理边界外所有的空间。</p><p><img loading="lazy" src="/assets/images/gc-2-d85c245f3c15a83cce6258f5cca14e10.png" width="1647" height="689" class="img_ev3q"></p><p>优点：</p><ul><li>标记-压缩算法适合用于存活对象较多的场合，如老年代</li><li>降低堆内存碎片化问题</li></ul><p>缺点：</p><ul><li>效率相较标记清扫更低了</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3标记复制">3）标记复制<a class="hash-link" href="#3标记复制" title="Direct link to heading">​</a></h4><p>将原有的内存空间分为两块，每次只使用其中一块，在垃圾回收时，将正在使用的内存中的存活对象复制到未使用的内存块中，之后，清除正在使用的内存块中的所有对象，交换两个内存的角色，完成垃圾回收。</p><p><img loading="lazy" src="/assets/images/gc-3-6ea66eaf29d8f018ac44ed86b12a15db.png" width="1679" height="679" class="img_ev3q"></p><p>优点：</p><ul><li>与标记-清除算法相比，复制算法是一种相对高效的回收方法（默认应用于青年代）</li><li>效率较高</li></ul><p>缺点：</p><ul><li>浪费空间</li><li>对可达对象存活周期长的效率不高</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4分代式">4）分代式<a class="hash-link" href="#4分代式" title="Direct link to heading">​</a></h4><p>对于一个大型的系统，当创建的对象和方法变量比较多时，堆内存中的对象也会比较多，如果逐一分析对象是否该回收，那么势必造成效率低下。</p><p>分代收集算法是基于这样一个事实：不同的对象的生命周期(存活情况)是不一样的，而不同生命周期的对象位于堆中不同的区域，因此对堆内存不同区域采用不同的策略进行回收可以提高 JVM 的执行效率。当代商用虚拟机使用的都是分代收集算法：新生代对象存活率低，就采用复制算法；老年代存活率高，就用标记清除算法或者标记整理算法。Java堆内存一般可以分为新生代、老年代和永久代三个模块。</p><p>根据不同对象的存活周期分为不同的几块</p><ul><li>老年代：标记清扫 或 标记整理</li><li>青年代：标记复制</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2引用计数法">2、引用计数法<a class="hash-link" href="#2引用计数法" title="Direct link to heading">​</a></h3><p><strong>引用计数 Reference counting 会为每个对象维护一个计数器，当该对象被其他对象引用时加一，引用失效时减一，当引用次数归零后即可回收对象</strong>。</p><p>使用这类GC方法的语言包括python、php、objective-C和C++标准库中的std::shared_ptr等。</p><p>以python为例，python中的每个对象都包含如下结构：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct_object {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ob_refcnt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct_typeobject *ob_type;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}PyObject;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中ob_refcnt为引用计数器，当一个对象有新的引用时计数器增一，当引用它的对象被删除时计数器减一。</p><p>引用计数法优点包括：</p><ul><li>原理和实现都比较简单</li><li>回收的即时性：当对象的引用计数为0时立即回收，不像其他GC机制需要等待特定时机再回收，提高了内存的利用率</li><li>不需要暂停应用即可完成回收</li></ul><p>缺点包括：</p><ul><li>无法解决循环引用的回收问题：当ObjA引用了ObjB，ObjB也引用ObjA时，这两个对象的引用次数使用大于0，从而占用的内存无法被回收</li><li>时间和空间成本较高：一方面是因为每个对象需要额外的空间存储引用计数器变量，另一方面是在栈上的赋值时修改引用次数时间成本较高（原本只需要修改寄存器中的值，现在计数器需要不断更新因此不是只读的，需要额外的原子操作来保证线程安全）</li><li>引用计数是一种摊销算法，会将内存的回收分摊到整个程序的运行过程，但是当销毁一个很大的树形结构时无法保证响应时间</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三go-的-gc-算法">三、Go 的 GC 算法<a class="hash-link" href="#三go-的-gc-算法" title="Direct link to heading">​</a></h2><p><strong>无分代、不整理、并发的三色标记法</strong></p><p>对象整理目的：</p><ul><li>是解决内存碎片问题，但是Go给予tcmalloc分配算法，基本没有碎片问题。另外顺序内存分配器在多线程并不适用，整理内存队tcmalloc分配没有实质提升</li><li>分代GC目标主要是针对新创建对象，不会频繁检查所有对象。但是Go会通过逃逸分析将大部分“新生”对象存储在栈上，需要长期保存的对象存在于堆中。栈会被回收，不需要GC。<strong>Go的GC更专注于如何让GC和用户代码并发执行</strong></li></ul><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Go </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">：串行三色标记清扫</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Go </span><span class="token number" style="color:#36acaa">1.3</span><span class="token plain">：并行清扫，标记过程需要 STW，停顿时间在约几百毫秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Go </span><span class="token number" style="color:#36acaa">1.5</span><span class="token plain">：并发标记清扫，停顿时间在一百毫秒以内</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Go </span><span class="token number" style="color:#36acaa">1.6</span><span class="token plain">：使用 bitmap 来记录回收内存的位置，大幅优化垃圾回收器自身消耗的内存，停顿时间在十毫秒以内</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Go </span><span class="token number" style="color:#36acaa">1.7</span><span class="token plain">：停顿时间控制在两毫秒以内</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Go </span><span class="token number" style="color:#36acaa">1.8</span><span class="token plain">：混合写屏障，停顿时间在半个毫秒左右</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Go </span><span class="token number" style="color:#36acaa">1.9</span><span class="token plain">：彻底移除了栈的重扫描过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Go </span><span class="token number" style="color:#36acaa">1.12</span><span class="token plain">：整合了两个阶段的 Mark Termination，但引入了一个严重的 GC Bug 至今未修（见问题 </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">），尚无该 Bug 对 GC 性能影响的报告</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Go </span><span class="token number" style="color:#36acaa">1.13</span><span class="token plain">：着手解决向操作系统归还内存的，提出了新的 Scavenger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Go </span><span class="token number" style="color:#36acaa">1.14</span><span class="token plain">：替代了仅存活了一个版本的 scavenger，全新的页分配器，优化分配内存过程的速率与现有的扩展性问题，并引入了异步抢占，解决了由于</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1go-13-mark-and-sweep">1、Go 1.3 mark and sweep<a class="hash-link" href="#1go-13-mark-and-sweep" title="Direct link to heading">​</a></h3><p>mark and sweep分为2个步骤</p><ul><li>暂停业务逻辑（需要STW，Stop The World），找到不可达对象并标记</li><li>回收标记好的对象</li></ul><p><img loading="lazy" src="/assets/images/gc-4-063b25264308461f412739cf1f0018aa.png" width="1922" height="453" class="img_ev3q"></p><p><img loading="lazy" src="/assets/images/gc-5-c3bb249b6b433d170c5760bf3a503054.png" width="1375" height="84" class="img_ev3q"></p><p>可以看到一次GC里面需要一次STW，在没有优化之前，STW的时间是比较久的。只有到清扫完成之后才停止STW，因此GO 1.3进行了一个优化，就是讲停止STW改到清扫之前。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2go-15-三色并发标记法">2、Go 1.5 三色并发标记法<a class="hash-link" href="#2go-15-三色并发标记法" title="Direct link to heading">​</a></h3><ul><li>白色对象：程序生成的对象都是白色对象，GC结束后还是白色的会被回收</li><li>灰色对象：可达对象，在GC遍历时遍历到的对象，GC结束后不会回收，正常是变为黑色</li><li>黑色对象：保留对象，在灰色遍历完之后，或者无接下去可达对象的灰色对象，最后都变为灰色对象</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1步骤">1）步骤<a class="hash-link" href="#1步骤" title="Direct link to heading">​</a></h4><ol><li>将程序以根节点展开</li><li>所有对象放入白色集合</li><li>根节点开始遍历，遍历到的标为灰色</li><li>遍历灰色，将遍历到的放入灰色，原本灰色的放入黑色</li><li>重复上一步直到无灰色对象</li><li>回收白色对象</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2实现">2）实现<a class="hash-link" href="#2实现" title="Direct link to heading">​</a></h4><p>基于标记清扫的例子，看一下三色并发标记法是如何实现的，<strong>记住GC开始时还是需要STW</strong></p><p>步骤一：将程序以根节点展开</p><p><img loading="lazy" src="/assets/images/gc-6-862b9d38762d0f5d7ec3b376ed8dcbbe.png" width="1531" height="595" class="img_ev3q"></p><p>步骤二：我们会建立白色对象，灰色对象和黑色对象集合。首先的是将所有对象先放到白色对象。</p><p><img loading="lazy" src="/assets/images/gc-7-41c02e136f7f5c34b9214ae23e49d525.png" width="1112" height="628" class="img_ev3q"></p><p>步骤三：遍历白色对象内的根对象，也就是对象1(dx1)和对象4。将遍历到的对象，由白色标记为灰色。</p><p><img loading="lazy" src="/assets/images/gc-8-6bab4e1b4b8193e25257cd16bdba143d.png" width="1112" height="628" class="img_ev3q"></p><p>步骤四：遍历灰色，将遍历到的放入灰色，原本灰色的放入黑色。</p><p>以对象1为例，对象2会从白色标机为灰色，而对象1会被标记为黑色。</p><p><img loading="lazy" src="/assets/images/gc-9-e5f3fd5a195039e01be2308e32ff94f2.png" width="1112" height="628" class="img_ev3q"></p><p>步骤五：循环第四步，直到没有灰色对象为止。</p><p><img loading="lazy" src="/assets/images/gc-10-01ad43a10bc07b8e531b72b401fc9902.png" width="1907" height="636" class="img_ev3q"></p><p>步骤六，当没有灰色对象后，回收白色对象</p><p><img loading="lazy" src="/assets/images/gc-11-26aa4e8debf4b83d4782ca7d30bafa82.png" width="808" height="628" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3为何在gc一开始需要stw">3）为何在GC一开始需要STW<a class="hash-link" href="#3为何在gc一开始需要stw" title="Direct link to heading">​</a></h4><p>看下图，要扫描对象2的时候。对象2删除对对象6的引用，同时，对象4创建指针指向对象6。此时继续标记，因为对象4不会再被扫描，所以，对象6会被当做回收对象。到最后就是，对象4指向的对象6会被清扫。因此，在没有STW的时候会发生如下两种情况：</p><ul><li>白对象被黑引用</li><li>灰对象与可达对象失去关系</li></ul><p><img loading="lazy" src="/assets/images/gc-12-3b4c6788bcae0ea9b5c9f4bf934783c7.png" width="1913" height="608" class="img_ev3q"></p><p><strong>可见，其实STW是为了保护在程序执行过程中，由于额外的新增或删除导致不可控的对象丢失的一个做法</strong>。</p><p>因为STW是需要暂定整个程序，所以STW的时间成为了一个指标，也上升为GC算法的一个指标，也是后面GC算法优化的一个点。</p><p>因此提出2个概念用于防止上述情况发生：</p><ul><li>强三色不变式：不允许黑色对象引用白色对象</li><li>弱三色不变式：所有黑色对象引用的白色对象都必须在灰色对象保护链下</li></ul><p><img loading="lazy" src="/assets/images/gc-13-86539f6efc7122e9df6f38f72d7e4dd0.png" width="933" height="429" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4插入屏障-强三色不变式">4）插入屏障-强三色不变式<a class="hash-link" href="#4插入屏障-强三色不变式" title="Direct link to heading">​</a></h4><p><strong>插入屏障-强三色不变式：黑色引用白色对象后，白色对象变为灰色对象</strong></p><p>如下图例子，遍历完对象1和对象4之后，分别引用对象7和对象8。根据插入屏障强三式，此时对象8会标记为灰色，再下个循环标记的时候，对象8可以标记为黑色保留下来。</p><p><img loading="lazy" src="/assets/images/gc-14-69db01582f608355bdc0632357404aa6.png" width="1950" height="694" class="img_ev3q"></p><p>可以看到对象7其实是没有像对象8一样，立马被标记为灰色。</p><p>这是因为，<strong>栈容量小，反应速度要求高，不能用插入屏障的机制</strong>。</p><p>因此，在堆对象扫描完之后，会对栈对象STW，然后通过三色并发标记清扫，完成GC。即，此例中的对象7得以保留。</p><p><img loading="lazy" src="/assets/images/gc-15-d5326b16781635735dabe2190c240ac0.png" width="1603" height="789" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5删除屏障-弱三色不变式">5）删除屏障-弱三色不变式<a class="hash-link" href="#5删除屏障-弱三色不变式" title="Direct link to heading">​</a></h4><p><strong>删除屏障-弱三色不变式：被删除对象为灰色或白色，则标记为灰色对象</strong></p><p>如下，为了保证对象没有被误扫除，在扫描对象1和对象4时，对象1删除对对象2的指向后。根据删除屏障弱三式，对象2会被标记为灰色。按照三色并发标记，最终GC如下右侧图。不过可以看到，虽然在一定程度上降低了对象被误扫除的机率，但同时降低了GC的精度。</p><p>例如对象2和对线6就需要在下次GC的时候才会销毁。</p><p><img loading="lazy" src="/assets/images/gc-16-80abf4ffbcc3a0e6bb32572b420d0092.png" width="1973" height="654" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3go-18-混合写屏障">3、Go 1.8 混合写屏障<a class="hash-link" href="#3go-18-混合写屏障" title="Direct link to heading">​</a></h3><p>可以看到之前的插入屏障和删除屏障有明显的自身缺陷：</p><ul><li>插入屏障：需要对栈对象重新STW遍历</li><li>删除屏障：回收精度低</li></ul><p>混合写屏障，就是结合两者优势，又中和两者的劣势。混合写屏障减少STW，并且减少了扫描栈对象的时间。混合写屏障会做如下操作：</p><ul><li>GC开始时，将栈全部标记为黑色</li><li>GC期间，任何创建在栈上的对象都标记为黑色</li><li>被删除的对象标记为灰色</li><li>被添加的对象标记为灰色</li></ul><p><strong>情况一：栈对象引用堆对象</strong></p><p>遍历对象4时，删除对对象5的引用，对象1创建对对象5的引用，对象5被标记为灰色。</p><p><img loading="lazy" src="/assets/images/gc-17-cb935165b5caa0eda31544d4d527d972.png" width="1932" height="658" class="img_ev3q"></p><p><strong>情况二：某个栈对象引用另一个栈对象的引用</strong></p><p>在栈上创建对象7，对象7会被标记为黑色。同时，对象7创建对对象6的引用，对象2删除对对象6的引用。由于都在栈上操作，因此没有标记色动作。</p><p><img loading="lazy" src="/assets/images/gc-18-a8f92a3002e88d53e4bfab8c3a7ef83c.png" width="1327" height="654" class="img_ev3q"></p><p><strong>情况三：某个堆对象引用另一个堆对象的引用</strong></p><p>遍历对象4时，删除对对象5的引用。同时，对象7创建对对象5的引用。对象5被标记为灰色，避免被错误回收。</p><p><img loading="lazy" src="/assets/images/gc-19-68ca730cba9c1075a21336cf8308e982.png" width="1365" height="664" class="img_ev3q"></p><p><strong>情况四：堆对象引用栈对象</strong></p><p>遍历对象4时，删除对对象5的引用。同时，对象4创建对对象2的引用。对象5会被标记为灰色，为了保证下游对象不被误回收。</p><p><img loading="lazy" src="/assets/images/gc-20-975791d146fb1ed6d4cf25e2d482c5a1.png" width="1340" height="654" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4总结-go-gc-流程">4、总结 Go GC 流程<a class="hash-link" href="#4总结-go-gc-流程" title="Direct link to heading">​</a></h3><p>Go GC对应5个流程分别是：</p><p><strong>GC Mark Prepare</strong></p><p>标记准备阶段，为并发标记做准备工作，包括开启写屏障(write barrier)和辅助GC(mutator assist)，统计root对象的任务数量等 --&gt; STW</p><p><strong>GC Mark</strong></p><p>扫描标记阶段，扫描所有root对象，包括全局指针和goroutine(G)栈上的指针（扫描对应G栈时需停止该G)，将其加入标记队列(灰色队列)，并循环处理灰色队列的对象，直到灰色队列为空 --&gt; 后台并发</p><p><strong>GC Mark Termination</strong></p><p>标记终止阶段，保证一个周期内标记任务完成，停止写屏障。同时由于Mark和用户代码是并发执行，所以需要重新扫描(re-scan)全局指针和栈。 --&gt; STW</p><p><strong>GC Off SWEEP</strong></p><p>内存清扫阶段，将需要回收的内存归还到堆中，写屏障关闭 --&gt; 后台并发</p><p><strong>GC off</strong></p><p>内存归还阶段，将过多的内存归还给操作系统，写屏障关闭 --&gt; 后台并发</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5go-gc-api">5、Go GC API<a class="hash-link" href="#5go-gc-api" title="Direct link to heading">​</a></h3><ul><li>runtime.GC：手动触发GC</li><li>runtime.ReadMemStats：读取内存相关的统计信息，其中包含部分GC相关的统计信息</li><li>debug.FreeOSMemory：手动将内存归还给操作系统</li><li>debug.ReadGCStats：读取关于GC的相关统计信息</li><li>debug.SetGCPercent：设置GOGC调步变量</li><li>debug.SetMaxHeap：设置GO程序堆的上限值</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四观察-gc">四、观察 GC<a class="hash-link" href="#四观察-gc" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1开启打印gc信息godebuggctrace1">1、开启打印gc信息：GODEBUG=gctrace=1<a class="hash-link" href="#1开启打印gc信息godebuggctrace1" title="Direct link to heading">​</a></h3><p>代码：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">allocate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">allocate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>命令：<a href="https://pkg.go.dev/runtime" target="_blank" rel="noopener noreferrer">https://pkg.go.dev/runtime</a></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">GODEBUG</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">gctrace</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> ./main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行后结果如下:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> @0.000s </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.012</span><span class="token plain">+0.26+0.003 ms clock, </span><span class="token number" style="color:#36acaa">0.10</span><span class="token plain">+0.075/0.14/0.041+0.029 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> @0.002s </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.032</span><span class="token plain">+0.72+0.004 ms clock, </span><span class="token number" style="color:#36acaa">0.25</span><span class="token plain">+0.11/0.029/0.20+0.035 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> @0.005s </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.094</span><span class="token plain">+1.2+0.010 ms clock, </span><span class="token number" style="color:#36acaa">0.75</span><span class="token plain">+0.19/0.039/0.32+0.082 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> @0.008s </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.062</span><span class="token plain">+0.55+0.002 ms clock, </span><span class="token number" style="color:#36acaa">0.49</span><span class="token plain">+0.21/0.044/0+0.023 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> @0.009s </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.048</span><span class="token plain">+0.62+0.003 ms clock, </span><span class="token number" style="color:#36acaa">0.38</span><span class="token plain">+0.19/0.18/0.057+0.031 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> @0.011s </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.057</span><span class="token plain">+0.31+0.003 ms clock, </span><span class="token number" style="color:#36acaa">0.46</span><span class="token plain">+0.10/0.096/0.052+0.030 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> @0.012s </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.11</span><span class="token plain">+0.38+0.012 ms clock, </span><span class="token number" style="color:#36acaa">0.91</span><span class="token plain">+0.10/0.064/0.063+0.097 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> @0.014s </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.063</span><span class="token plain">+0.35+0.003 ms clock, </span><span class="token number" style="color:#36acaa">0.50</span><span class="token plain">+0.072/0.096/0.044+0.026 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> @0.015s </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.095</span><span class="token plain">+1.0+0.006 ms clock, </span><span class="token number" style="color:#36acaa">0.76</span><span class="token plain">+0.36/0.16/0.091+0.048 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">6</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> @0.017s </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.034</span><span class="token plain">+0.33+0.003 ms clock, </span><span class="token number" style="color:#36acaa">0.27</span><span class="token plain">+0.082/0.091/0.036+0.025 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> @0.017s </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.038</span><span class="token plain">+0.26+0.004 ms clock, </span><span class="token number" style="color:#36acaa">0.30</span><span class="token plain">+0.060/0.050/0.065+0.032 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> @0.018s </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.40</span><span class="token plain">+0.90+0.002 ms clock, </span><span class="token number" style="color:#36acaa">3.2</span><span class="token plain">+0.13/0.14/0.037+0.023 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">6</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">13</span><span class="token plain"> @0.020s </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.068</span><span class="token plain">+0.33+0.003 ms clock, </span><span class="token number" style="color:#36acaa">0.54</span><span class="token plain">+0.066/0.047/0+0.026 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> @0.021s </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.034</span><span class="token plain">+0.33+0.002 ms clock, </span><span class="token number" style="color:#36acaa">0.27</span><span class="token plain">+0.059/0.090/0.040+0.023 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">15</span><span class="token plain"> @0.023s </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.17</span><span class="token plain">+0.59+0.004 ms clock, </span><span class="token number" style="color:#36acaa">1.4</span><span class="token plain">+0.11/0.005/0.24+0.033 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">6</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">16</span><span class="token plain"> @0.025s </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.73</span><span class="token plain">+0.98+0.005 ms clock, </span><span class="token number" style="color:#36acaa">5.8</span><span class="token plain">+0.36/0.44/0.056+0.045 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">17</span><span class="token plain"> @0.027s </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.046</span><span class="token plain">+0.46+0.015 ms clock, </span><span class="token number" style="color:#36acaa">0.37</span><span class="token plain">+0.11/0.16/0.079+0.12 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">18</span><span class="token plain"> @0.029s </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.22</span><span class="token plain">+0.54+0.088 ms clock, </span><span class="token number" style="color:#36acaa">1.7</span><span class="token plain">+0.15/0/0+0.71 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">19</span><span class="token plain"> @0.030s </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.028</span><span class="token plain">+0.30+0.002 ms clock, </span><span class="token number" style="color:#36acaa">0.22</span><span class="token plain">+0.059/0.20/0.099+0.020 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">20</span><span class="token plain"> @0.031s </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.14</span><span class="token plain">+1.0+0.004 ms clock, </span><span class="token number" style="color:#36acaa">1.1</span><span class="token plain">+0.13/0.86/0.004+0.033 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">21</span><span class="token plain"> @0.033s </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.22</span><span class="token plain">+0.79+0.006 ms clock, </span><span class="token number" style="color:#36acaa">1.7</span><span class="token plain">+0.25/0.082/0.062+0.050 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">22</span><span class="token plain"> @0.036s </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.12</span><span class="token plain">+0.57+0.004 ms clock, </span><span class="token number" style="color:#36acaa">0.98</span><span class="token plain">+0.12/0.18/0.044+0.034 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">23</span><span class="token plain"> @0.037s </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.073</span><span class="token plain">+0.49+0.015 ms clock, </span><span class="token number" style="color:#36acaa">0.59</span><span class="token plain">+0.19/0.28/0.16+0.12 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">24</span><span class="token plain"> @0.038s </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.039</span><span class="token plain">+0.41+0.002 ms clock, </span><span class="token number" style="color:#36acaa">0.31</span><span class="token plain">+0.14/0.12/0.001+0.022 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>解释此条数据</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> @0.002s </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">%: </span><span class="token number" style="color:#36acaa">0.032</span><span class="token plain">+0.72+0.004 ms clock, </span><span class="token number" style="color:#36acaa">0.25</span><span class="token plain">+0.11/0.029/0.20+0.035 ms cpu, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> MB, </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> MB goal, </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> P</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    gc # @#s #%: #+#+# ms clock, #+#/#/#+# ms cpu, #-&gt;#-&gt;# MB, # MB goal, # P</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">where the fields are as follows:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gc #        the GC number, incremented at each GC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @#s         time in seconds since program start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #%          percentage of time spent in GC since program start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #+...+#     wall-clock/CPU times for the phases of the GC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #-&gt;#-&gt;# MB  heap size at GC start, at GC end, and live heap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # MB goal   goal heap size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # P         number of processors used</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>gc 2</td><td>第二个 GC 周期</td></tr><tr><td>0.002</td><td>程序开始后的 0.002 秒</td></tr><tr><td>2%</td><td>该 GC 周期中 CPU 的使用率</td></tr><tr><td>0.032</td><td>标记开始时， STW 所花费的时间（wall clock）</td></tr><tr><td>0.72</td><td>标记过程中，并发标记所花费的时间（wall clock）</td></tr><tr><td>0.004</td><td>标记终止时， STW 所花费的时间（wall clock）</td></tr><tr><td>0.25</td><td>标记开始时， STW 所花费的时间（cpu time）</td></tr><tr><td>0.11</td><td>标记过程中，标记辅助所花费的时间（cpu time）</td></tr><tr><td>0.029</td><td>标记过程中，并发标记所花费的时间（cpu time）</td></tr><tr><td>0.20</td><td>标记过程中，GC 空闲的时间（cpu time）</td></tr><tr><td>0.035</td><td>标记终止时， STW 所花费的时间（cpu time）</td></tr><tr><td>4</td><td>标记开始时，堆的大小的实际值</td></tr><tr><td>5</td><td>标记结束时，堆的大小的实际值</td></tr><tr><td>1</td><td>标记结束时，标记为存活的对象大小</td></tr><tr><td>5</td><td>标记结束时，堆的大小的预测值</td></tr><tr><td>8</td><td>P 的数量</td></tr></tbody></table><p>可以这么理解，本次GC为「第二次」GC周期，占用了「2%」的CPU来执行这次GC。本次GC所花的STW扫描时间，STW并发标记时间，即STW清扫的总时间为「0.032+0.72+0.004 ms」wall clock。然后，本次GC占用的CPU时间为「0.25+0.11/0.029/0.20+0.035 ms」。标记前实际堆大小为「4 MB」，结束时为「5 MB」，清扫存活下来的为「1MB」。此GC基于「8核」CPU</p><p>wall clock 是指开始执行到完成所经历的实际时间，包括其他程序和本程序所消耗的时间；</p><p>cpu time 是指特定程序使用 CPU 的时间；他们存在以下关系：</p><ul><li>wall clock &lt; cpu time: 充分利用多核</li><li>wall clock ≈ cpu time: 未并行执行</li><li>wall clock &gt; cpu time: 多核优势不明显</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2性能追踪-go-tool-trace-traceout">2、性能追踪 go tool trace trace.out<a class="hash-link" href="#2性能追踪-go-tool-trace-traceout" title="Direct link to heading">​</a></h3><p>将上述代码块改为如下代码</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;os&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;runtime/trace&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;trace.out&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Stop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">allocate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">allocate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行 go run main.go，生成 trace.out</p><p>再执行 go tool trace trace.out，会启动一个web server</p><p><img loading="lazy" src="/assets/images/gc-21-e5cc37585ba3ff4f6cae3e2d06877390.png" width="474" height="349" class="img_ev3q"></p><p>页面上的内容如下：</p><ul><li>View trace：查看跟踪</li><li>Goroutine analysis：Goroutine 分析</li><li>Network blocking profile：网络阻塞概况</li><li>Synchronization blocking profile：同步阻塞概况</li><li>Syscall blocking profile：系统调用阻塞概况</li><li>Scheduler latency profile：调度延迟概况</li><li>User defined tasks：用户自定义任务</li><li>User defined regions：用户自定义区域</li><li>Minimum mutator utilization：最低 Mutator 利用率</li></ul><p>点击第一个链接view trace</p><p><img loading="lazy" src="/assets/images/gc-22-2b551fe84eab4d9bedb635c986854c72.png" width="1319" height="743" class="img_ev3q"></p><p>蓝色区域就是背景GC在执行的时间</p><p>堆就是我们通过allocate分配的内存</p><p>绿色为用户代码运行在系统线程上</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3debugreadgcstats">3、debug.ReadGCStats<a class="hash-link" href="#3debugreadgcstats" title="Direct link to heading">​</a></h3><p>此方式可以通过代码的方式来直接实现对感兴趣指标的监控，例如我们希望每隔一秒钟监控一次 GC 的状态：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;runtime/debug&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> GCStats </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LastGC         time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time       </span><span class="token comment" style="color:#999988;font-style:italic">// 上次一次收集时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NumGC          </span><span class="token builtin">int64</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// gc总次数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PauseTotal     time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Duration   </span><span class="token comment" style="color:#999988;font-style:italic">// 总共gc暂停的时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Pause          </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Duration </span><span class="token comment" style="color:#999988;font-style:italic">// 暂停的时间切片，每次暂停的花费时间，倒叙</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PauseEnd       </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time     </span><span class="token comment" style="color:#999988;font-style:italic">// 暂停结束的时间点，倒叙</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PauseQuantiles </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Duration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">printGCStats</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">allocate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">printGCStats</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewTicker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> debug</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GCStats</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">C</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            debug</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ReadGCStats</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;gc %d last@%v, PauseTotal %v\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NumGC</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LastGC</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PauseTotal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">allocate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行 go run main.go </p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@</span><span class="token number" style="color:#36acaa">2022</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">03</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">15.454572</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"> CST</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PauseTotal </span><span class="token number" style="color:#36acaa">63.362</span><span class="token plain">µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@</span><span class="token number" style="color:#36acaa">2022</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">03</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">15.454572</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"> CST</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PauseTotal </span><span class="token number" style="color:#36acaa">63.362</span><span class="token plain">µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@</span><span class="token number" style="color:#36acaa">2022</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">03</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">15.454572</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"> CST</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PauseTotal </span><span class="token number" style="color:#36acaa">63.362</span><span class="token plain">µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@</span><span class="token number" style="color:#36acaa">2022</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">03</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">15.454572</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"> CST</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PauseTotal </span><span class="token number" style="color:#36acaa">63.362</span><span class="token plain">µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@</span><span class="token number" style="color:#36acaa">2022</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">03</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">15.454572</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"> CST</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PauseTotal </span><span class="token number" style="color:#36acaa">63.362</span><span class="token plain">µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@</span><span class="token number" style="color:#36acaa">2022</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">03</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">15.454572</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"> CST</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PauseTotal </span><span class="token number" style="color:#36acaa">63.362</span><span class="token plain">µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@</span><span class="token number" style="color:#36acaa">2022</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">03</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">15.454572</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"> CST</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PauseTotal </span><span class="token number" style="color:#36acaa">63.362</span><span class="token plain">µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@</span><span class="token number" style="color:#36acaa">2022</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">03</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">15.454572</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"> CST</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PauseTotal </span><span class="token number" style="color:#36acaa">63.362</span><span class="token plain">µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@</span><span class="token number" style="color:#36acaa">2022</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">03</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">15.454572</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"> CST</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PauseTotal </span><span class="token number" style="color:#36acaa">63.362</span><span class="token plain">µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@</span><span class="token number" style="color:#36acaa">2022</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">03</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">15.454572</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"> CST</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PauseTotal </span><span class="token number" style="color:#36acaa">63.362</span><span class="token plain">µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@</span><span class="token number" style="color:#36acaa">2022</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">03</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">15.454572</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"> CST</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PauseTotal </span><span class="token number" style="color:#36acaa">63.362</span><span class="token plain">µs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@</span><span class="token number" style="color:#36acaa">2022</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">03</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">15.454572</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0800</span><span class="token plain"> CST</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PauseTotal </span><span class="token number" style="color:#36acaa">63.362</span><span class="token plain">µs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4runtimereadmemstats">4、runtime.ReadMemStats<a class="hash-link" href="#4runtimereadmemstats" title="Direct link to heading">​</a></h3><p>除了使用 debug 包提供的方法外，还可以直接通过运行时的内存相关的 API 进行监控：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;runtime&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">printMemStats</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">allocate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">printMemStats</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewTicker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MemStats</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">C</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ReadMemStats</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;gc %d last@%v, next_heap_size@%vMB\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NumGC</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Unix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">int64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Duration</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LastGC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Seconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NextGC</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">allocate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@2022-03-12 </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:00:05 +0800 CST, next_heap_size@4MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@2022-03-12 </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:00:05 +0800 CST, next_heap_size@4MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@2022-03-12 </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:00:05 +0800 CST, next_heap_size@4MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@2022-03-12 </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:00:05 +0800 CST, next_heap_size@4MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@2022-03-12 </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:00:05 +0800 CST, next_heap_size@4MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> last@2022-03-12 </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:00:05 +0800 CST, next_heap_size@4MB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当然，后两种方式能够监控的指标很多，读者可以自行查看 <code>debug.GCStats</code> 和<code>runtime.MemStats</code> 的字段，这里不再赘述。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="五内存泄漏">五、内存泄漏<a class="hash-link" href="#五内存泄漏" title="Direct link to heading">​</a></h2><p>在一个具有 GC 的语言中，我们常说的内存泄漏，用严谨的话来说应该是：<strong>预期的能很快被释放的内存由于附着在了长期存活的内存上、或生命期意外地被延长，导致预计能够立即回收的内存而长时间得不到回收</strong></p><p>在 Go 中，由于 goroutine 的存在，所谓的内存泄漏除了附着在长期对象上之外，还存在多种不同的形式。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="形式1预期能被快速释放的内存因被根对象引用而没有得到迅速释放">形式1：预期能被快速释放的内存因被根对象引用而没有得到迅速释放<a class="hash-link" href="#形式1预期能被快速释放的内存因被根对象引用而没有得到迅速释放" title="Direct link to heading">​</a></h4><p>当有一个全局对象时，可能不经意间将某个变量附着在其上，且忽略的将其进行释放，则该内存永远不会得到释放。例如：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> cache </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">keepalloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        m </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cache</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="形式2goroutine-泄漏">形式2：goroutine 泄漏<a class="hash-link" href="#形式2goroutine-泄漏" title="Direct link to heading">​</a></h4><p>Goroutine 作为一种逻辑上理解的轻量级线程，需要维护执行用户代码的上下文信息。在运行过程中也需要消耗一定的内存来保存这类信息，而这些内存在目前版本的 Go 中是不会被释放的。因此，如果一个程序持续不断地产生新的 goroutine、且不结束已经创建的 goroutine 并复用这部分内存，就会造成内存泄漏的现象，例如：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">keepalloc2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="验证">验证<a class="hash-link" href="#验证" title="Direct link to heading">​</a></h4><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;os&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;runtime/trace&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> cache </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">keepalloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        m </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cache</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">keepalloc2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;trace.out&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Stop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">keepalloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">keepalloc2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">go run main.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go tool trace trace.out</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="/assets/images/gc-23-4fe0c643d15ff3e6d2a1476fe90acae3.png" width="1084" height="606" class="img_ev3q"></p><p>可以看到，途中的 Heap 在持续增长，没有内存被回收，产生了内存泄漏的现象。</p><p>值得一提的是，这种形式的 goroutine 泄漏还可能由 channel 泄漏导致。而 channel 的泄漏本质上与 goroutine 泄漏存在直接联系。Channel 作为一种同步原语，会连接两个不同的 goroutine，如果一个 goroutine 尝试向一个没有接收方的无缓冲 channel 发送消息，则该 goroutine 会被永久的休眠，整个 goroutine 及其执行栈都得不到释放，例如：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> ch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">keepalloc3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 没有接收方，goroutine 会一直阻塞</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> ch </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="六gc-调优">六、GC 调优<a class="hash-link" href="#六gc-调优" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1gc-关注指标">1、GC 关注指标<a class="hash-link" href="#1gc-关注指标" title="Direct link to heading">​</a></h3><p>Go 的 GC 被设计为成比例触发、大部分工作与赋值器并发、不分代、无内存移动且会主动向操作系统归还申请的内存。</p><p>因此最主要关注的、能够影响赋值器的性能指标有：</p><ul><li>CPU 利用率：回收算法会在多大程度上拖慢程序？有时候，这个是通过回收占用的 CPU 时间与其它 CPU 时间的百分比来描述的。</li><li>GC 停顿时间：回收器会造成多长时间的停顿？目前的 GC 中需要考虑 STW 和 Mark Assist 两个部分可能造成的停顿。</li><li>GC 停顿频率：回收器造成的停顿频率是怎样的？目前的 GC 中需要考虑 STW 和 Mark Assist 两个部分可能造成的停顿。</li><li>GC 可扩展性：当堆内存变大时，垃圾回收器的性能如何？但大部分的程序可能并不一定关心这个问题。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2gc-调优方式">2、GC 调优方式<a class="hash-link" href="#2gc-调优方式" title="Direct link to heading">​</a></h3><p>Go 的 GC 被设计为极致简洁，与较为成熟的 Java GC 的数十个可控参数相比，严格意义上来讲，Go 可供用户调整的参数只有 GOGC 环境变量。<strong>当我们谈论 GC 调优时，通常是指减少用户代码对 GC 产生的压力</strong></p><ul><li>这一方面包含了减少用户代码分配内存的数量（即对程序的代码行为进行调优）</li><li>另一方面包含了最小化 Go 的 GC 对 CPU 的使用率（即调整 GOGC）</li></ul><p>GC 的调优是在特定场景下产生的，并非所有程序都需要针对 GC 进行调优。<strong>只有那些对执行延迟非常敏感、当 GC 的开销成为程序性能瓶颈的程序，才需要针对 GC 进行性能调优</strong>，几乎不存在于实际开发中 99% 的情况。除此之外，Go 的 GC 也仍然有一定的可改进的空间，也有部分 GC 造成的问题，目前仍属于 Open Problem。</p><p>总的来说，我们可以在现在的开发中处理的有以下几种情况：</p><ol><li>对停顿敏感：GC 过程中产生的长时间停顿、或由于需要执行 GC 而没有执行用户代码，导致需要立即执行的用户代码执行滞后。</li><li>对资源消耗敏感：对于频繁分配内存的应用而言，频繁分配内存增加 GC 的工作量，原本可以充分利用 CPU 的应用不得不频繁地执行垃圾回收，影响用户代码对 CPU 的利用率，进而影响用户代码的执行效率。</li></ol><p>从这两点来看，所谓 GC 调优的核心思想也就是充分的围绕上面的两点来展开：优化内存的申请速度，尽可能的少申请内存，复用已申请的内存。或者简单来说，不外乎这三个关键字：<strong>控制、减少、复用</strong>。</p><p>我们将通过三个实际例子介绍如何定位 GC 的存在的问题，并一步一步进行性能调优。当然，在实际情况中问题远比这些例子要复杂，这里也只是讨论调优的核心思想，更多的时候也只能具体问题具体分析。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="例1合理化内存分配的速度提高赋值器的-cpu-利用率"><strong>例1：合理化内存分配的速度、提高赋值器的 CPU 利用率</strong><a class="hash-link" href="#例1合理化内存分配的速度提高赋值器的-cpu-利用率" title="Direct link to heading">​</a></h4><p>我们来看这样一个例子。在这个例子中， <code>concat</code> 函数负责拼接一些长度不确定的字符串。并且为了快速完成任务，出于某种原因，在两个嵌套的 for 循环中一口气创建了 800 个 goroutine。在 main 函数中，启动了一个 goroutine 并在程序结束前不断的触发 GC，并尝试输出 GC 的平均执行时间：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;os&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;runtime&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;runtime/trace&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;sync/atomic&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stop  </span><span class="token builtin">int32</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    count </span><span class="token builtin">int64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sum   time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Duration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">concat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Go GC&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Hello&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;World&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;trace.out&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Stop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> t time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LoadInt32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Since</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            count</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;GC spend avg: %v\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Duration</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">int64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">concat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StoreInt32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个程序的执行结果是：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">go build -o main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GC spend avg: </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">.583421ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>GC 平均执行一次需要长达 2ms 的时间，我们再进一步观察 trace 的结果：</p><p><img loading="lazy" src="/assets/images/gc-24-d1a5e613f2d3f220de212a7a2dab13ec.png" width="1080" height="728" class="img_ev3q"></p><p>程序的整个执行过程中仅执行了一次 GC，而且仅 Sweep STW 就耗费了超过 1 ms，非常反常。甚至查看赋值器 mutator 的 CPU 利用率，在整个 trace 尺度下连 40% 都不到：</p><p><img loading="lazy" src="/assets/images/gc-25-8905337eb22cb378581ddf1b9b1bada0.png" width="1080" height="509" class="img_ev3q"></p><p>主要原因是什么呢？我们不妨查看 goroutine 的分析：</p><p><img loading="lazy" src="/assets/images/gc-26-7173f815ee6732a6f74d118aeafd242a.png" width="1080" height="659" class="img_ev3q"></p><p>在这个榜单中我们不难发现，goroutine 的执行时间占其生命周期总时间非常短的一部分，但大部分时间都花费在调度器的等待上了（蓝色的部分），说明同时创建大量 goroutine 对调度器产生的压力确实不小，我们不妨将这一产生速率减慢，一批一批地创建 goroutine：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">concat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wg </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WaitGroup</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Go GC&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Hello&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;World&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这时候我们再来看：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">go build -o main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GC spend avg: </span><span class="token number" style="color:#36acaa">328.54</span><span class="token plain">µs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>GC 的平均时间就降到 300 微秒了。这时的赋值器 CPU 使用率也提高到了 60%，相对来说就很可观了：</p><p><img loading="lazy" src="/assets/images/gc-27-91037385c8d32d761a450518dccefda5.png" width="1080" height="492" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="例2降低并复用已经申请的内存">例2：降低并复用已经申请的内存<a class="hash-link" href="#例2降低并复用已经申请的内存" title="Direct link to heading">​</a></h4><p>我们通过一个非常简单的 Web 程序来说明复用内存的重要性。</p><p>在这个程序中，每当产生一个 <code>/example2</code>的请求时，都会创建一段内存，并用于进行一些后续的工作。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;net/http&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;net/http/pprof&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newBuf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ListenAndServe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;localhost:6060&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HandleFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/example2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ResponseWriter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> r </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        b </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newBuf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 模拟执行一些工作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> idx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> b </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;done, %v&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">URL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Path</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ListenAndServe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;:8080&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>为了进行性能分析，我们还额外创建了一个监听 6060 端口的 goroutine，用于使用 pprof 进行分析。我们先让服务器跑起来：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">go build -o main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们这次使用 pprof 的 trace 来查看 GC 在此服务器中面对大量请求时候的状态，要使用 trace 可以通过访问 <code>/debug/pprof/trace</code> 路由来进行，其中 <code>seconds</code> 参数设置为 20s，并将 trace 的结果保存为 <code>trace.out</code>：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> http://127.0.0.1:6060/debug/pprof/trace</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">?seconds</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">20</span><span class="token plain"> -O trace.out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--2020-01-01 </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:13:34--  http://127.0.0.1:6060/debug/pprof/trace?seconds</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connecting to </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:6060</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. connected.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP request sent, awaiting response</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这时候我们使用一个压测工具 <code>ab</code>，来同时产生 500 个请求（ <code>-n</code> 一共 500 个请求， <code>-c</code> 一个时刻执行请求的数量，每次 100 个并发请求）：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ab -n </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> -c </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> http://127.0.0.1:8080/example2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is ApacheBench, Version </span><span class="token number" style="color:#36acaa">2.3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token variable" style="color:#36acaa">$Revision</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1843412</span><span class="token plain"> $</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copyright </span><span class="token number" style="color:#36acaa">1996</span><span class="token plain"> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Benchmarking </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">be patient</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">400</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Finished </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server Software:        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server Hostname:        </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server Port:            </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Document Path:          /example2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Document Length:        </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Concurrency Level:      </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time taken </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> tests:   </span><span class="token number" style="color:#36acaa">0.987</span><span class="token plain"> seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Complete requests:      </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Failed requests:        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total transferred:      </span><span class="token number" style="color:#36acaa">65500</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HTML transferred:       </span><span class="token number" style="color:#36acaa">7000</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Requests per second:    </span><span class="token number" style="color:#36acaa">506.63</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token comment" style="color:#999988;font-style:italic">#/sec] (mean)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time per request:       </span><span class="token number" style="color:#36acaa">197.382</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ms</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time per request:       </span><span class="token number" style="color:#36acaa">1.974</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ms</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mean, across all concurrent requests</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Transfer rate:          </span><span class="token number" style="color:#36acaa">64.81</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Kbytes/sec</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> received</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection Times </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              min  mean</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">+/-sd</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> median   max</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connect:        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">1.1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Processing:    </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">179</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">77.5</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">170</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">456</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting:       </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">168</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">78.8</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">162</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">455</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total:         </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">180</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">77.3</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">171</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">458</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Percentage of the requests served within a certain </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">50</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">171</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">66</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">203</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">75</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">222</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">239</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">90</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">281</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">95</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">335</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">98</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">365</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">400</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">458</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">longest request</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="/assets/images/gc-28-5ac5d2551b9a04a4f60051736579f32e.png" width="1080" height="407" class="img_ev3q"></p><p>GC 反复被触发，一个显而易见的原因就是内存分配过多。我们可以通过 <code>go tool pprof</code>来查看究竟是谁分配了大量内存（使用 web 指令来使用浏览器打开统计信息的可视化图形）：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ go tool pprof http://127.0.0.1:6060/debug/pprof/heap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Fetching profile over HTTP from http://localhost:6060/debug/pprof/heap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Saved profile </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> /Users/changkun/pprof/pprof.alloc_objects.alloc_space.inuse_o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bjects.inuse_space.003.pb.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type: inuse_space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time: Jan </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">2020</span><span class="token plain"> at </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:15pm </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Entering interactive mode </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type </span><span class="token string" style="color:#e3116c">&quot;help&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> commands, </span><span class="token string" style="color:#e3116c">&quot;o&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pprof</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pprof</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="/assets/images/gc-29-4a0baf7c5933fc8348db7f8e98cf9f53.png" width="988" height="1056" class="img_ev3q"></p><p>可见 <code>newBuf</code> 产生的申请的内存过多，现在我们使用 sync.Pool 来复用 <code>newBuf</code> 所产生的对象：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;net/http&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;net/http/pprof&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;sync&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 使用 sync.Pool 复用需要的 buf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> bufPool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pool</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    New</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ListenAndServe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;localhost:6060&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HandleFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/example2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ResponseWriter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> r </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        b </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> bufPool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> idx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> b </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;done, %v&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">URL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Path</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bufPool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ListenAndServe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;:8080&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中 ab 输出的统计结果为：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ab -n </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> -c </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> http://127.0.0.1:8080/example2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is ApacheBench, Version </span><span class="token number" style="color:#36acaa">2.3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token variable" style="color:#36acaa">$Revision</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1843412</span><span class="token plain"> $</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copyright </span><span class="token number" style="color:#36acaa">1996</span><span class="token plain"> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Benchmarking </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">be patient</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">400</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Finished </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server Software:        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server Hostname:        </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server Port:            </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Document Path:          /example2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Document Length:        </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Concurrency Level:      </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time taken </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> tests:   </span><span class="token number" style="color:#36acaa">0.427</span><span class="token plain"> seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Complete requests:      </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Failed requests:        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total transferred:      </span><span class="token number" style="color:#36acaa">65500</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HTML transferred:       </span><span class="token number" style="color:#36acaa">7000</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Requests per second:    </span><span class="token number" style="color:#36acaa">1171.32</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token comment" style="color:#999988;font-style:italic">#/sec] (mean)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time per request:       </span><span class="token number" style="color:#36acaa">85.374</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ms</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time per request:       </span><span class="token number" style="color:#36acaa">0.854</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ms</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mean, across all concurrent requests</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Transfer rate:          </span><span class="token number" style="color:#36acaa">149.85</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Kbytes/sec</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> received</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection Times </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              min  mean</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">+/-sd</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> median   max</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connect:        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">1.4</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Processing:     </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">75</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">48.2</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">66</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">211</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting:        </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">72</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">46.8</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">63</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">207</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total:          </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">77</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">48.2</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">67</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">211</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Percentage of the requests served within a certain </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">50</span><span class="token plain">%     </span><span class="token number" style="color:#36acaa">67</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">66</span><span class="token plain">%     </span><span class="token number" style="color:#36acaa">89</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">75</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">107</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">122</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">90</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">148</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">95</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">167</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">98</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">196</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">204</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">211</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">longest request</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但从 <code>Requestsper second</code> 每秒请求数来看，从原来的 506.63 变为 1171.32 得到了近乎一倍的提升。从 trace 的结果来看，GC 也没有频繁的被触发从而长期消耗 CPU 使用率：</p><p><img loading="lazy" src="/assets/images/gc-30-f635db12803398a7bcaa6b2025ffbb7f.png" width="1080" height="351" class="img_ev3q"></p><p>sync.Pool 是内存复用的一个最为显著的例子，从语言层面上还有很多类似的例子，例如在例 1 中， <code>concat</code> 函数可以预先分配一定长度的缓存，而后再通过 append 的方式将字符串存储到缓存中：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">concat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wg </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WaitGroup</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> n</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Go GC&quot;</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27; &#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Hello&quot;</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27; &#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;World&quot;</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>原因在于 <code>+</code> 运算符会随着字符串长度的增加而申请更多的内存，并将内容从原来的内存位置拷贝到新的内存位置，造成大量不必要的内存分配，先提前分配好足够的内存，再慢慢地填充，也是一种减少内存分配、复用内存形式的一种表现。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="例3调整-gogc">例3：调整 GOGC<a class="hash-link" href="#例3调整-gogc" title="Direct link to heading">​</a></h4><p>我们已经知道了 GC 的触发原则是由步调算法来控制的，其关键在于估计下一次需要触发 GC 时，堆的大小。可想而知，如果我们在遇到海量请求的时，为了避免 GC 频繁触发，是否可以通过将 GOGC 的值设置得更大，让 GC 触发的时间变得更晚，从而减少其触发频率，进而增加用户代码对机器的使用率呢？答案是肯定的。</p><p>我们可以非常简单粗暴的将 GOGC 调整为 1000，来执行上一个例子中未复用对象之前的程序：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token assign-left variable" style="color:#36acaa">GOGC</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"> ./main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这时我们再重新执行压测：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ab -n </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> -c </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> http://127.0.0.1:8080/example2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is ApacheBench, Version </span><span class="token number" style="color:#36acaa">2.3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token variable" style="color:#36acaa">$Revision</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1843412</span><span class="token plain"> $</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copyright </span><span class="token number" style="color:#36acaa">1996</span><span class="token plain"> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Benchmarking </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">be patient</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">400</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Completed </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Finished </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server Software:        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server Hostname:        </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server Port:            </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Document Path:          /example2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Document Length:        </span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Concurrency Level:      </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time taken </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> tests:   </span><span class="token number" style="color:#36acaa">0.923</span><span class="token plain"> seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Complete requests:      </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Failed requests:        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total transferred:      </span><span class="token number" style="color:#36acaa">65500</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HTML transferred:       </span><span class="token number" style="color:#36acaa">7000</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Requests per second:    </span><span class="token number" style="color:#36acaa">541.61</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token comment" style="color:#999988;font-style:italic">#/sec] (mean)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time per request:       </span><span class="token number" style="color:#36acaa">184.636</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ms</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time per request:       </span><span class="token number" style="color:#36acaa">1.846</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ms</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mean, across all concurrent requests</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Transfer rate:          </span><span class="token number" style="color:#36acaa">69.29</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Kbytes/sec</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> received</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection Times </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              min  mean</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">+/-sd</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> median   max</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connect:        </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">1.8</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Processing:     </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">171</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">210.4</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">66</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">859</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting:        </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">158</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">199.6</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">62</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">813</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total:          </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">173</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">210.6</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">68</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">860</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Percentage of the requests served within a certain </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">50</span><span class="token plain">%     </span><span class="token number" style="color:#36acaa">68</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">66</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">133</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">75</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">198</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">292</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">90</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">566</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">95</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">696</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">98</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">723</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">743</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain">%    </span><span class="token number" style="color:#36acaa">860</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">longest request</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到，压测的结果得到了一定幅度的改善（ <code>Requestsper second</code> 从原来的 506.63 提高为了 541.61），</p><p>并且 GC 的执行频率明显降低：</p><p><img loading="lazy" src="/assets/images/gc-31-d79735bc86a5cc43cc4235d15fde487e.png" width="1080" height="356" class="img_ev3q"></p><p>在实际实践中可表现为需要紧急处理一些由 GC 带来的瓶颈时，人为将 GOGC 调大，加钱加内存，扛过这一段峰值流量时期。</p><p>当然，这种做法其实是治标不治本，并没有从根本上解决内存分配过于频繁的问题，极端情况下，反而会由于 GOGC 太大而导致回收不及时而耗费更多的时间来清理产生的垃圾，这对时间不算敏感的应用还好，但对实时性要求较高的程序来说就是致命的打击了。</p><p>因此这时更妥当的做法仍然是，定位问题的所在，并从代码层面上进行优化。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3小结">3、小结<a class="hash-link" href="#3小结" title="Direct link to heading">​</a></h3><p>通过上面的三个例子我们可以看到在 GC 调优过程中 <code>go tool pprof</code> 和 <code>go tool trace</code>的强大作用是帮助我们快速定位 GC 导致瓶颈的具体位置，但这些例子中仅仅覆盖了其功能的很小一部分，我们也没有必要完整覆盖所有的功能，因为总是可以通过http pprof 官方文档、runtime pprof官方文档以及trace 官方文档来举一反三。</p><p>现在我们来总结一下前面三个例子中的优化情况：</p><ol><li>控制内存分配的速度，限制 goroutine 的数量，从而提高赋值器对 CPU 的利用率。</li><li>减少并复用内存，例如使用 sync.Pool 来复用需要频繁创建临时对象，例如提前分配足够的内存来降低多余的拷贝。</li><li>需要时，增大 GOGC 的值，降低 GC 的运行频率。</li></ol><p>这三种情况几乎涵盖了 GC 调优中的核心思路，虽然从语言上还有很多小技巧可说，但我们并不会在这里事无巨细的进行总结。实际情况也是千变万化，我们更应该着重于培养具体问题具体分析的能力。</p><p>当然，我们还应该谨记 <strong>过早优化是万恶之源</strong>这一警语，在没有遇到应用的真正瓶颈时，将宝贵的时间分配在开发中其他优先级更高的任务上。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Skill/Golang/Go语言并发/锁"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">锁</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Skill/Golang/进阶知识/go-tool"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">go-tool</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一garbage-collection" class="table-of-contents__link toc-highlight">一、Garbage Collection</a><ul><li><a href="#1垃圾回收器组件" class="table-of-contents__link toc-highlight">1、垃圾回收器组件</a></li><li><a href="#2垃圾回收器的目标" class="table-of-contents__link toc-highlight">2、垃圾回收器的目标</a></li><li><a href="#3根对象" class="table-of-contents__link toc-highlight">3、根对象</a></li><li><a href="#4常见的gc问题" class="table-of-contents__link toc-highlight">4、常见的GC问题</a></li><li><a href="#5触发机制" class="table-of-contents__link toc-highlight">5、触发机制</a></li><li><a href="#6stw" class="table-of-contents__link toc-highlight">6、STW</a></li></ul></li><li><a href="#二常见-gc-算法" class="table-of-contents__link toc-highlight">二、常见 GC 算法</a><ul><li><a href="#1追踪法" class="table-of-contents__link toc-highlight">1、追踪法</a></li><li><a href="#2引用计数法" class="table-of-contents__link toc-highlight">2、引用计数法</a></li></ul></li><li><a href="#三go-的-gc-算法" class="table-of-contents__link toc-highlight">三、Go 的 GC 算法</a><ul><li><a href="#1go-13-mark-and-sweep" class="table-of-contents__link toc-highlight">1、Go 1.3 mark and sweep</a></li><li><a href="#2go-15-三色并发标记法" class="table-of-contents__link toc-highlight">2、Go 1.5 三色并发标记法</a></li><li><a href="#3go-18-混合写屏障" class="table-of-contents__link toc-highlight">3、Go 1.8 混合写屏障</a></li><li><a href="#4总结-go-gc-流程" class="table-of-contents__link toc-highlight">4、总结 Go GC 流程</a></li><li><a href="#5go-gc-api" class="table-of-contents__link toc-highlight">5、Go GC API</a></li></ul></li><li><a href="#四观察-gc" class="table-of-contents__link toc-highlight">四、观察 GC</a><ul><li><a href="#1开启打印gc信息godebuggctrace1" class="table-of-contents__link toc-highlight">1、开启打印gc信息：GODEBUG=gctrace=1</a></li><li><a href="#2性能追踪-go-tool-trace-traceout" class="table-of-contents__link toc-highlight">2、性能追踪 go tool trace trace.out</a></li><li><a href="#3debugreadgcstats" class="table-of-contents__link toc-highlight">3、debug.ReadGCStats</a></li><li><a href="#4runtimereadmemstats" class="table-of-contents__link toc-highlight">4、runtime.ReadMemStats</a></li></ul></li><li><a href="#五内存泄漏" class="table-of-contents__link toc-highlight">五、内存泄漏</a></li><li><a href="#六gc-调优" class="table-of-contents__link toc-highlight">六、GC 调优</a><ul><li><a href="#1gc-关注指标" class="table-of-contents__link toc-highlight">1、GC 关注指标</a></li><li><a href="#2gc-调优方式" class="table-of-contents__link toc-highlight">2、GC 调优方式</a></li><li><a href="#3小结" class="table-of-contents__link toc-highlight">3、小结</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Doongz Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a61035f3.js"></script>
<script src="/assets/js/main.7aad8990.js"></script>
</body>
</html>