<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Knowledge/容器技术/kubernetes对象详解/daemonSet">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">详解 Kubernetes DaemonSet 的实现原理 | Doongz&#x27;s Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doongz.github.io/docs/Knowledge/容器技术/kubernetes对象详解/daemonSet"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="详解 Kubernetes DaemonSet 的实现原理 | Doongz&#x27;s Site"><meta data-rh="true" name="description" content="来源：详解 Kubernetes DaemonSet 的实现原理"><meta data-rh="true" property="og:description" content="来源：详解 Kubernetes DaemonSet 的实现原理"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://doongz.github.io/docs/Knowledge/容器技术/kubernetes对象详解/daemonSet"><link data-rh="true" rel="alternate" href="https://doongz.github.io/docs/Knowledge/容器技术/kubernetes对象详解/daemonSet" hreflang="en"><link data-rh="true" rel="alternate" href="https://doongz.github.io/docs/Knowledge/容器技术/kubernetes对象详解/daemonSet" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Doongz&#39;s Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Doongz&#39;s Site Atom Feed">





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.bbae31c2.css">
<link rel="preload" href="/assets/js/runtime~main.958a4673.js" as="script">
<link rel="preload" href="/assets/js/main.715bfe53.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Home page</b></a><a class="navbar__item navbar__link" href="/docs/catalogue-algo">Algorithm</a><a class="navbar__item navbar__link" href="/docs/catalogue-skill">Skill</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/catalogue-knowledge">Knowledge</a><a class="navbar__item navbar__link" href="/community/support">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Courses</a><ul class="dropdown__menu"><li><a href="https://github.com/doongz/mlc-ai" target="_blank" rel="noopener noreferrer" class="dropdown__link">Machine Learning Compilation<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/cs229" target="_blank" rel="noopener noreferrer" class="dropdown__link">Stanford CS229: Machine Learning<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/aics" target="_blank" rel="noopener noreferrer" class="dropdown__link">中国科学院 智能计算系统<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/cs50-ai" target="_blank" rel="noopener noreferrer" class="dropdown__link">Harvard CS50’s Introduction to AI with Python<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/mit-6.824" target="_blank" rel="noopener noreferrer" class="dropdown__link">MIT-6.824 Distributed Systems<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/os-workbench" target="_blank" rel="noopener noreferrer" class="dropdown__link">南京大学 操作系统：设计与实现<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/doongz/mit-6.s081" target="_blank" rel="noopener noreferrer" class="dropdown__link">MIT-6.S081 Operating Systems Engineering<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/doongz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/catalogue-knowledge">Catalogue</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Knowledge/IC/IC">IC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Knowledge/计算机组成/计算机组成-序">计算机组成</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Knowledge/操作系统/计算机系统概述">操作系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Knowledge/计算机网络/计算机网络体系结构">计算机网络</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Knowledge/容器技术/docker原理">容器技术</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/docker原理">Docker 原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes原理">kubernetes 原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes定制特性">如何为 Kubernetes 定制特性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes问题&amp;局限性">Kubernetes 的问题和局限性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes集群联邦&amp;资源分发">Kubernetes 集群联邦和资源分发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes贡献指南">kubernetes 贡献指南</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes对象详解/pod">kubernetes对象详解</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes对象详解/pod">详解 Kubernetes Pod 的实现原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes对象详解/service">详解 Kubernetes Service 的实现原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes对象详解/volume">详解 Kubernetes Volume 的实现原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes对象详解/replicaSet">详解 Kubernetes ReplicaSet 的实现原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes对象详解/garbage-collector">详解 Kubernetes 垃圾收集器的实现原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes对象详解/deployment">详解 Kubernetes Deployment 的实现原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes对象详解/statefulSet">详解 Kubernetes StatefulSet 实现原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes对象详解/daemonSet">详解 Kubernetes DaemonSet 的实现原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Knowledge/容器技术/kubernetes对象详解/job&amp;cronJob">详解 Kubernetes Job 和 CronJob 的实现原理</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Knowledge/数据存储/设计数据密集型应用/序">数据存储</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Knowledge/AI/Tensor">AI</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">容器技术</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">kubernetes对象详解</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">详解 Kubernetes DaemonSet 的实现原理</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>详解 Kubernetes DaemonSet 的实现原理</h1><p>来源：<a href="https://draveness.me/kubernetes-daemonset/" target="_blank" rel="noopener noreferrer">详解 Kubernetes DaemonSet 的实现原理</a></p><p><a href="https://draveness.me/kubernetes-deployment" target="_blank" rel="noopener noreferrer">Deployment</a> 是 Kubernetes 中用于处理无状态服务的资源，而 <a href="https://draveness.me/kubernetes-statefulset" target="_blank" rel="noopener noreferrer">StatefulSet</a> 是用于支持有状态服务的资源，这两种不同的资源从状态的角度对服务进行了划分，而 DaemonSet 从不同的维度解决了集群中的问题 — 如何<strong>同时在集群中的所有节点上提供基础服务和守护进程</strong>。</p><p>我们在这里将介绍 DaemonSet 如何进行状态的同步、Pod 与节点（Node）之间的调度方式和滚动更新的过程以及实现原理。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一概述">一、概述<a class="hash-link" href="#一概述" title="Direct link to heading">​</a></h2><p>DaemonSet 可以保证集群中所有的或者部分的节点都能够运行同一份 Pod 副本，每当有新的节点被加入到集群时，Pod 就会在目标的节点上启动，如果节点被从集群中剔除，节点上的 Pod 也会被垃圾收集器清除；DaemonSet 的作用就像是计算机中的守护进程，它能够运行集群存储、日志收集和监控等『守护进程』，这些服务一般是集群中必备的基础服务。</p><p>Google Cloud 的 Kubernetes 集群就会在所有的节点上启动 fluentd 和 Prometheus 来收集节点上的日志和监控数据，想要创建用于日志收集的守护进程其实非常简单，我们可以使用如下所示的代码：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> DaemonSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluentd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">elasticsearch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluentd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">elasticsearch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluentd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">elasticsearch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fluentd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">elasticsearch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> k8s.gcr.io/fluentd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">elasticsearch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">volumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> varlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /var/log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> varlibdockercontainers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /var/lib/docker/containers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">readOnly</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> varlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">hostPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /var/log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> varlibdockercontainers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">hostPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /var/lib/docker/containers</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当我们使用 <code>kubectl apply -f</code> 创建上述的 DaemonSet 时，它会在 Kubernetes 集群的 <code>kube-system</code> 命名空间中创建 DaemonSet 资源并在所有的节点上创建新的 Pod：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get daemonsets.apps fluentd-elasticsearch --namespace kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                    DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fluentd-elasticsearch   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">          19h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods --namespace kube-system --label </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">fluentd-elasticsearch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                          READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fluentd-elasticsearch-kvtwj   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          19h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于集群中只存在一个 Pod，所以 Kubernetes 只会在该节点上创建一个 Pod，如果我们向当前的集群中增加新的节点时，Kubernetes 就会创建在新节点上创建新的副本，总的来说，我们能够得到以下的拓扑结构：</p><p><img loading="lazy" alt="k8s-29" src="data:image/png;base64,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" width="960" height="520" class="img_ev3q"></p><p>集群中的 Pod 和 Node 一一对应，而 DaemonSet 会管理全部机器上的 Pod 副本，负责对它们进行更新和删除。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二实现原理">二、实现原理<a class="hash-link" href="#二实现原理" title="Direct link to heading">​</a></h2><p>所有的 DaemonSet 都是由控制器负责管理的，与其他的资源一样，用于管理 DaemonSet 的控制器是 <code>DaemonSetsController</code>，该控制器会监听 DaemonSet、ControllerRevision、Pod 和 Node 资源的变动。</p><p><img loading="lazy" alt="k8s-30" src="data:image/png;base64,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" width="1240" height="380" class="img_ev3q"></p><p>大多数的触发事件最终都会将一个待处理的 DaemonSet 资源入栈，下游 <code>DaemonSetsController</code> 持有的多个工作协程就会从队列里面取出资源进行消费和同步。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1同步">1、同步<a class="hash-link" href="#1同步" title="Direct link to heading">​</a></h3><p><code>DaemonSetsController</code> 同步 DaemonSet 资源使用的方法就是 <code>syncDaemonSet</code>，这个方法从队列中拿到 DaemonSet 的名字时，会先从集群中获取最新的 DaemonSet 对象并通过 <code>constructHistory</code> 方法查找当前 DaemonSet 全部的历史版本：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dsc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">DaemonSetsController</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">syncDaemonSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SplitMetaNamespaceKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dsLister</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DaemonSets</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">namespace</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dsKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> controller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">KeyFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cur</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> old</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">constructHistory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hash </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cur</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Labels</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">apps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultDaemonSetUniqueLabelKey</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">manage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> ds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UpdateStrategy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Type </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> apps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnDeleteDaemonSetStrategyType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> apps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RollingUpdateDaemonSetStrategyType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">rollingUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cleanupHistory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> old</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateDaemonSetStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后调用的 <code>manage</code> 方法会负责管理 DaemonSet 在节点上 Pod 的调度和运行，<code>rollingUpdate</code> 会负责 DaemonSet 的滚动更新；前者会先找出找出需要运行 Pod 和不需要运行 Pod 的节点，并调用 <code>syncNodes</code> 对这些需要创建和删除的 Pod 进行同步：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dsc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">DaemonSetsController</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">syncNodes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">apps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DaemonSet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podsToDelete</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nodesNeedingDaemonPods </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dsKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> controller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">KeyFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    generation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetTemplateGeneration</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    template </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CreatePodTemplate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Template</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> generation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    createDiff </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nodesNeedingDaemonPods</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    createWait </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WaitGroup</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    createWait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">createDiff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> createDiff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ix </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> createWait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            podTemplate </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> template</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DeepCopy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> utilfeature</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultFeatureGate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Enabled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">features</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ScheduleDaemonSetPods</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                podTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Affinity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ReplaceDaemonSetPodNodeNameNodeAffinity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">podTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Affinity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nodesNeedingDaemonPods</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ix</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">podControl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CreatePodsWithControllerRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podTemplate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewControllerRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> controllerKind</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                podTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SchedulerName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kubernetes.io/daemonset-controller&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">podControl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CreatePodsOnNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nodesNeedingDaemonPods</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ix</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podTemplate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewControllerRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> controllerKind</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    createWait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>获取了 DaemonSet 中的模板之之后，就会开始并行地为节点创建 Pod 副本，并发创建的过程使用了 for 循环、Goroutine 和 <code>WaitGroup</code> 保证程序运行的正确，然而这里使用了特性开关来对调度新 Pod 的方式进行了控制，我们会在接下来的调度一节介绍 DaemonSet 调度方式的变迁和具体的执行过程。</p><p>当 Kubernetes 创建了需要创建的 Pod 之后，就需要删除所有节点上不必要的 Pod 了，这里使用同样地方式并发地对 Pod 进行删除：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    deleteDiff </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">podsToDelete</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deleteWait </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WaitGroup</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deleteWait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deleteDiff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> deleteDiff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ix </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> deleteWait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">podControl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DeletePod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podsToDelete</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ix</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deleteWait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>到了这里我们就完成了节点上 Pod 的调度和运行，为一些节点创建 Pod 副本的同时删除另一部分节点上的副本，<code>manage</code> 方法执行完成之后就会调用 <code>rollingUpdate</code> 方法对 DaemonSet 的节点进行滚动更新并对控制器版本进行清理并更新 DaemonSet 的状态，文章后面的部分会介绍滚动更新的过程和实现。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2调度">2、调度<a class="hash-link" href="#2调度" title="Direct link to heading">​</a></h3><p>在早期的 Kubernetes 版本中，所有 DaemonSet Pod 的创建都是由 <code>DaemonSetsController</code> 负责的，而其他的资源都是由 kube-scheduler 进行调度，这就导致了如下的一些问题：</p><ol><li><code>DaemonSetsController</code> 没有办法在节点资源变更时收到通知 (<a href="https://github.com/kubernetes/kubernetes/issues/46935" target="_blank" rel="noopener noreferrer">#46935</a>, <a href="https://github.com/kubernetes/kubernetes/issues/58868" target="_blank" rel="noopener noreferrer">#58868</a>)；</li><li><code>DaemonSetsController</code> 没有办法遵循 Pod 的亲和性和反亲和性设置 (<a href="https://github.com/kubernetes/kubernetes/issues/29276" target="_blank" rel="noopener noreferrer">#29276</a>)；</li><li><code>DaemonSetsController</code> 可能需要二次实现 Pod 调度的重要逻辑，造成了重复的代码逻辑 (<a href="https://github.com/kubernetes/kubernetes/issues/42028" target="_blank" rel="noopener noreferrer">#42028</a>)；</li><li>多个组件负责调度会导致 Debug 和抢占等功能的实现非常困难；</li></ol><p>设计文档 <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/schedule-DS-pod-by-scheduler.md" target="_blank" rel="noopener noreferrer">Schedule DaemonSet Pods by default scheduler, not DaemonSet controller</a> 中包含了使用 <code>DaemonSetsController</code> 调度时遇到的问题以及新设计给出的解决方案。</p><p>如果我们选择使用过去的调度方式，<code>DeamonSetsController</code> 就会负责在节点上创建 Pod，通过这种方式创建的 Pod 的 <code>schedulerName</code> 都会被设置成 <code>kubernetes.io/daemonset-controller</code>，但是在默认情况下这个字段一般为 <code>default-scheduler</code>，也就是使用 Kubernetes 默认的调度器 kube-scheduler 进行调度：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dsc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">DaemonSetsController</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">syncNodes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">apps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DaemonSet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podsToDelete</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nodesNeedingDaemonPods </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> createDiff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ix </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            podTemplate </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> template</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DeepCopy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> utilfeature</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultFeatureGate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Enabled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">features</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ScheduleDaemonSetPods</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                podTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SchedulerName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kubernetes.io/daemonset-controller&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">podControl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CreatePodsOnNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nodesNeedingDaemonPods</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ix</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podTemplate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewControllerRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> controllerKind</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>DaemonSetsController</code> 在调度 Pod 时都会使用 <code>CreatePodsOnNode</code> 方法，这个方法的实现非常简单，它会先对 Pod 模板进行验证，随后调用 <code>createPods</code>方法通过 Kubernetes 提供的 API 创建新的副本：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r RealPodControl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreatePodsWithControllerRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">namespace </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> template </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodTemplateSpec</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> controllerObject runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Object</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> controllerRef </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OwnerReference</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">validateControllerRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">controllerRef</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createPods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> template</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> controllerObject</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> controllerRef</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>DaemonSetsController</code> 通过节点选择器和调度器的谓词对节点进行过滤，<code>createPods</code> 会直接为当前的 Pod 设置 <code>spec.NodeName</code> 属性，最后得到的 Pod 就会被目标节点上的 kubelet 创建。</p><p>除了这种使用 <code>DaemonSetsController</code> 管理和调度 DaemonSet 的方法之外，我们还可以使用 Kubernetes 默认的方式 kube-scheduler 创建新的 Pod 副本：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dsc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">DaemonSetsController</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">syncNodes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">apps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DaemonSet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podsToDelete</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nodesNeedingDaemonPods </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> createDiff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ix </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            podTemplate </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> template</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DeepCopy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> utilfeature</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultFeatureGate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Enabled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">features</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ScheduleDaemonSetPods</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                podTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Affinity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ReplaceDaemonSetPodNodeNameNodeAffinity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">podTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Affinity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nodesNeedingDaemonPods</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ix</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">podControl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CreatePodsWithControllerRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podTemplate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewControllerRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> controllerKind</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这种情况会使用 NodeAffinity 特性来避免发生在 <code>DaemonSetsController</code> 中的调度：</p><ol><li><code>DaemonSetsController</code> 会在 <code>podsShouldBeOnNode</code> 方法中根据节点选择器过滤所有的节点；</li><li>对于每一个节点，控制器都会创建一个遵循以下节点亲和的 Pod；</li></ol><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">nodeAffinity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">nodeSelectorTerms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">matchExpressions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes.io/hostname</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">operator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> dest_hostname</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>当节点进行同步时，DaemonSetsController 会根据节点亲和的设置来验证节点和 Pod 的关系；</li><li>如果调度的谓词失败了，DaemonSet 持有的 Pod 就会保持在 Pending 的状态，所以可以通过修改 Pod 的优先级和抢占保证集群在高负载下也能正常运行 DaemonSet 的副本；</li></ol><p>Pod 的优先级和抢占功能在 Kubernetes 1.8 版本引入，1.11 时转变成 beta 版本，在目前最新的 1.13 中依然是 beta 版本，感兴趣的读者可以阅读 <a href="https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/" target="_blank" rel="noopener noreferrer">Pod Priority and Preemption</a> 文档了解相关的内容。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3滚动更新">3、滚动更新<a class="hash-link" href="#3滚动更新" title="Direct link to heading">​</a></h3><p><code>DaemonSetsController</code> 对滚动更新的实现其实比较简单，它其实就是根据 DaemonSet 规格中的配置，删除集群中的 Pod 并保证同时不可用的副本数不会超过 <code>spec.updateStrategy.rollingUpdate.maxUnavailable</code>，这个参数也是 DaemonSet 滚动更新可以配置的唯一参数：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dsc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">DaemonSetsController</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rollingUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">apps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DaemonSet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nodeToDaemonPods</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getNodesToDaemonPods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldPods </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getAllDaemonSetPods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nodeToDaemonPods</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxUnavailable</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> numUnavailable</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getUnavailableNumbers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nodeToDaemonPods</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    oldAvailablePods</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldUnavailablePods </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SplitByAvailablePods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MinReadySeconds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldPods</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> oldPodsToDelete </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> oldUnavailablePods </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeletionTimestamp </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        oldPodsToDelete </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldPodsToDelete</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> oldAvailablePods </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> numUnavailable </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> maxUnavailable </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        oldPodsToDelete </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldPodsToDelete</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        numUnavailable</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> dsc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">syncNodes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldPodsToDelete</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>删除 Pod 的顺序其实也非常简单并且符合直觉，上述代码会将不可用的 Pod 先加入到待删除的数组中，随后将历史版本的可用 Pod 加入待删除数组 <code>oldPodsToDelete</code>，最后调用 <code>syncNodes</code> 完成对副本的删除。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4删除">4、删除<a class="hash-link" href="#4删除" title="Direct link to heading">​</a></h3><p>与 <a href="https://draveness.me/kubernetes-deployment" target="_blank" rel="noopener noreferrer">Deployment</a>、<a href="https://draveness.me/kubernetes-replicaset" target="_blank" rel="noopener noreferrer">ReplicaSet</a> 和 <a href="https://draveness.me/kubernetes-statefulset" target="_blank" rel="noopener noreferrer">StatefulSet</a> 一样，DaemonSet 的删除也会导致它持有的 Pod 的删除，如果我们使用如下的命令删除该对象，我们能观察到如下的现象：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl delete daemonsets.apps fluentd-elasticsearch --namespace kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonset.apps </span><span class="token string" style="color:#e3116c">&quot;fluentd-elasticsearch&quot;</span><span class="token plain"> deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods --watch --namespace kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fluentd-elasticsearch-wvffx   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1   Terminating   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     14s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这部分的工作就都是由 Kubernetes 中的垃圾收集器完成的，读者可以阅读 <a href="https://draveness.me/kubernetes-garbage-collector" target="_blank" rel="noopener noreferrer">垃圾收集器</a> 一文了解集群中的不同对象是如何进行关联的以及在删除单一对象时如何触发级联删除的原理。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="Direct link to heading">​</a></h2><p>DaemonSet 其实就是 Kubernetes 中的守护进程，它会在每一个节点上创建能够提供服务的副本，很多云服务商都会使用 DaemonSet 在所有的节点上内置一些用于提供日志收集、统计分析和安全策略的服务。</p><p>在研究 DaemonSet 的调度策略的过程中，我们其实能够通过一些历史的 issue 和 PR 了解到 DaemonSet 调度策略改动的原因，也能让我们对于 Kubernetes 的演进过程和设计决策有一个比较清楚的认识。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="referenece">Referenece<a class="hash-link" href="#referenece" title="Direct link to heading">​</a></h2><ul><li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/" target="_blank" rel="noopener noreferrer">DaemonSet · Kubernetes</a></li><li><a href="https://kubernetes.io/docs/tasks/manage-daemon/update-daemon-set/" target="_blank" rel="noopener noreferrer">Perform a Rolling Update on a DaemonSet</a></li><li><a href="https://kubernetes.io/docs/tasks/manage-daemon/rollback-daemon-set/" target="_blank" rel="noopener noreferrer">Perform a Rollback on a DaemonSet</a></li><li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/schedule-DS-pod-by-scheduler.md" target="_blank" rel="noopener noreferrer">Schedule DaemonSet Pods by default scheduler, not DaemonSet controller</a></li><li><a href="https://github.com/kubernetes/kubernetes/issues/46935" target="_blank" rel="noopener noreferrer">DaemonsetController can’t feel it when node has more resources, e.g. other Pod exits</a></li><li><a href="https://github.com/kubernetes/kubernetes/issues/45628" target="_blank" rel="noopener noreferrer">DaemonsetController can’t feel it when node recovered from outofdisk state</a></li><li><a href="https://github.com/kubernetes/kubernetes/issues/42002" target="_blank" rel="noopener noreferrer">DaemonSet pods should be scheduled by default scheduler, not DaemonSet controller</a></li><li><a href="https://github.com/kubernetes/kubernetes/issues/42001" target="_blank" rel="noopener noreferrer">NodeController should add NoSchedule taints and we should get rid of getNodeConditionPredicate()</a></li><li><a href="https://github.com/kubernetes/kubernetes/issues/29276" target="_blank" rel="noopener noreferrer">DaemonSet should respect Pod Affinity and Pod AntiAffinity</a></li><li><a href="https://github.com/kubernetes/kubernetes/pull/42028" target="_blank" rel="noopener noreferrer">Make DaemonSet respect critical pods annotation when scheduling</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Knowledge/容器技术/kubernetes对象详解/statefulSet"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">详解 Kubernetes StatefulSet 实现原理</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Knowledge/容器技术/kubernetes对象详解/job&amp;cronJob"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">详解 Kubernetes Job 和 CronJob 的实现原理</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一概述" class="table-of-contents__link toc-highlight">一、概述</a></li><li><a href="#二实现原理" class="table-of-contents__link toc-highlight">二、实现原理</a><ul><li><a href="#1同步" class="table-of-contents__link toc-highlight">1、同步</a></li><li><a href="#2调度" class="table-of-contents__link toc-highlight">2、调度</a></li><li><a href="#3滚动更新" class="table-of-contents__link toc-highlight">3、滚动更新</a></li><li><a href="#4删除" class="table-of-contents__link toc-highlight">4、删除</a></li></ul></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li><li><a href="#referenece" class="table-of-contents__link toc-highlight">Referenece</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Doongz Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.958a4673.js"></script>
<script src="/assets/js/main.715bfe53.js"></script>
</body>
</html>