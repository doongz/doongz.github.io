"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[57247],{3905:(e,n,t)=>{t.d(n,{Zo:()=>m,kt:()=>d});var r=t(67294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function _(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function a(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},s=Object.keys(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var c=r.createContext({}),l=function(e){var n=r.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):_(_({},n),e)),t},m=function(e){var n=l(e.components);return r.createElement(c.Provider,{value:n},e.children)},p="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},o=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,s=e.originalType,c=e.parentName,m=a(e,["components","mdxType","originalType","parentName"]),p=l(t),o=i,d=p["".concat(c,".").concat(o)]||p[o]||u[o]||s;return t?r.createElement(d,_(_({ref:n},m),{},{components:t})):r.createElement(d,_({ref:n},m))}));function d(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var s=t.length,_=new Array(s);_[0]=o;var a={};for(var c in n)hasOwnProperty.call(n,c)&&(a[c]=n[c]);a.originalType=e,a[p]="string"==typeof e?e:i,_[1]=a;for(var l=2;l<s;l++)_[l]=t[l];return r.createElement.apply(null,_)}return r.createElement.apply(null,t)}o.displayName="MDXCreateElement"},95734:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>_,default:()=>p,frontMatter:()=>s,metadata:()=>a,toc:()=>l});var r=t(87462),i=(t(67294),t(3905));const s={},_="CSR\u8bfb\u5199\u63a7\u5236",a={unversionedId:"Skill/ASM/RISC-V/CSR\u8bfb\u5199\u63a7\u5236",id:"Skill/ASM/RISC-V/CSR\u8bfb\u5199\u63a7\u5236",title:"CSR\u8bfb\u5199\u63a7\u5236",description:"\u6765\u6e90\uff1ahttps://www.icfedu.cn/?s=RISC-V+CSR%E8%AF%BB%E5%86%99%E6%8E%A7%E5%88%B6",source:"@site/docs/Skill/ASM/RISC-V/7-CSR\u8bfb\u5199\u63a7\u5236.md",sourceDirName:"Skill/ASM/RISC-V",slug:"/Skill/ASM/RISC-V/CSR\u8bfb\u5199\u63a7\u5236",permalink:"/docs/Skill/ASM/RISC-V/CSR\u8bfb\u5199\u63a7\u5236",draft:!1,tags:[],version:"current",sidebarPosition:7,frontMatter:{},sidebar:"skillSidebar",previous:{title:"LSU & SRAM & GPIO\u6a21\u5757",permalink:"/docs/Skill/ASM/RISC-V/LOAD&STORE-UNIT"},next:{title:"EXU\u6a21\u5757\u548cCPU\u8fd0\u884c",permalink:"/docs/Skill/ASM/RISC-V/EXU\u6a21\u5757\u548cCPU\u8fd0\u884c"}},c={},l=[{value:"\u4e00\u3001exu_csr\u6a21\u5757",id:"\u4e00exu_csr\u6a21\u5757",level:2},{value:"1\u3001\u8f93\u5165/\u8f93\u51fa",id:"1\u8f93\u5165\u8f93\u51fa",level:3},{value:"2\u3001\u6267\u884c",id:"2\u6267\u884c",level:3},{value:"3\u3001csr_reg\u5b9e\u4f8b",id:"3csr_reg\u5b9e\u4f8b",level:3},{value:"\u4e8c\u3001csr_reg\u6a21\u5757",id:"\u4e8ccsr_reg\u6a21\u5757",level:2},{value:"1\u3001\u8f93\u5165\u8f93\u51fa",id:"1\u8f93\u5165\u8f93\u51fa-1",level:3},{value:"2\u3001\u6267\u884c",id:"2\u6267\u884c-1",level:3},{value:"3\u3001CSR\u5bc4\u5b58\u5668\u5b9e\u4f8b",id:"3csr\u5bc4\u5b58\u5668\u5b9e\u4f8b",level:3},{value:"\u4e09\u3001CSR\u5bc4\u5b58\u5668\u5b9e\u73b0",id:"\u4e09csr\u5bc4\u5b58\u5668\u5b9e\u73b0",level:2},{value:"1\u3001\u5bc4\u5b58\u5668\u6a21\u5757",id:"1\u5bc4\u5b58\u5668\u6a21\u5757",level:3},{value:"csr_mtvec",id:"csr_mtvec",level:4},{value:"csr_msatus",id:"csr_msatus",level:4},{value:"csr_mtval",id:"csr_mtval",level:4},{value:"csr_mepc",id:"csr_mepc",level:4},{value:"csr_mcause",id:"csr_mcause",level:4},{value:"csr_mie",id:"csr_mie",level:4},{value:"csr_mip",id:"csr_mip",level:4},{value:"csr_misa",id:"csr_misa",level:4},{value:"csr_mcounteren",id:"csr_mcounteren",level:4},{value:"csr_mid",id:"csr_mid",level:4},{value:"csr_scratch",id:"csr_scratch",level:4},{value:"csr_mcycle",id:"csr_mcycle",level:4},{value:"csr_minstret",id:"csr_minstret",level:4}],m={toc:l};function p(e){let{components:n,...s}=e;return(0,i.kt)("wrapper",(0,r.Z)({},m,s,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"csr\u8bfb\u5199\u63a7\u5236"},"CSR\u8bfb\u5199\u63a7\u5236"),(0,i.kt)("p",null,"\u6765\u6e90\uff1a",(0,i.kt)("a",{parentName:"p",href:"https://www.icfedu.cn/?s=RISC-V+CSR%E8%AF%BB%E5%86%99%E6%8E%A7%E5%88%B6"},"https://www.icfedu.cn/?s=RISC-V+CSR%E8%AF%BB%E5%86%99%E6%8E%A7%E5%88%B6")),(0,i.kt)("h2",{id:"\u4e00exu_csr\u6a21\u5757"},"\u4e00\u3001exu_csr\u6a21\u5757"),(0,i.kt)("p",null,"\u672c\u6587\u4f7f\u7528\u7684\u4ee3\u7801\u662f\u57fa\u4e8eFII RISC-V V2.01(\u6ca1\u6709JTAG\u548c\u603b\u7ebf)\u3002\u6709\u5173CSR\u516d\u6761\u6307\u4ee4\u7684\u590d\u4e60\u89c1\u6587\u7ae0",(0,i.kt)("a",{parentName:"p",href:"https://www.icfedu.cn/archives/6238"},"RISC-V CSR\u5bc4\u5b58\u5668\uff081\uff09CSR\u7b80\u4ecb\u548cCSR\u6307\u4ee4"),"\uff0c\u672c\u6587\u5c06\u4eceexu_csr\u6a21\u5757\u5f00\u59cb\u4ecb\u7ecdRISC-V CPU\u4e2d\u5982\u4f55\u63a7\u5236CSR\u7684\u8bfb\u5199\u3002"),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(65168).Z,width:"1822",height:"1234"})),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"103",src:t(45798).Z,width:"1890",height:"1114"})),(0,i.kt)("h3",{id:"1\u8f93\u5165\u8f93\u51fa"},"1\u3001\u8f93\u5165/\u8f93\u51fa"),(0,i.kt)("p",null,"\u4e0b\u9762\u662f\u6bd4\u8f83\u91cd\u8981\u7684\u8f93\u5165\u8f93\u51fa\u4fe1\u53f7\uff0c\u76f8\u5e94\u7684\u89e3\u91ca\u6807\u5728\u4e86\u4ee3\u7801\u6bb5\u4e2d\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"    input  sys_clk,              //\u7cfb\u7edf\u65f6\u949f\n    input  i_SYSTEM,             //CSR\u6307\u4ee4\u7684opcode\n    \n    input  [ 31: 0 ] i_rs1_val,  //rs1\u7684\u503c\n    input  [ 4: 0 ]  i_rd_idx,   //rd\u7684\u7d22\u5f15\n    input  [ 5: 0 ]  i_csr_instr,//csr\u7684\u6307\u4ee4(6\u6761\u4e4b\u4e00)\n\n    input  [ 11: 0 ] i_csr_addr, //\u7d22\u5f15CSR\u5bc4\u5b58\u5668\u768412\u4f4d\u5730\u5740\n    input  [ 31: 0 ] i_csr_imm,  //\u96f6\u6269\u5c55\u540e\u7684\u7acb\u5373\u6570\n\n    input  i_ext_irq,            //\u5916\u90e8\u4e2d\u65ad\u8bf7\u6c42\n    input  i_sft_irq,            //\u8f6f\u4ef6\u4e2d\u65ad\u8bf7\u6c42\n    input  i_tmr_irq,            //\u8ba1\u65f6\u5668\u4e2d\u65ad\u8bf7\u6c42\n    \n    input  i_irq_src,            //\u4e2d\u65ad\u6e90\n    input  i_exp_src,            //\u5f02\u5e38\u6e90\n    input  [ 31: 0 ] i_exe_pc,   //\u6267\u884c\u7684\u7a0b\u5e8f\u8ba1\u6570\u5668\n    input  [ 31: 0 ] i_ir,       //\u6307\u4ee4\u5bc4\u5b58\u5668\n\n    output [ 31: 0 ]   o_irq_pc, //\u4e2d\u65ad\u5165\u53e3\u5730\u5740\n    output [ 31: 0 ]   o_mepc,   //\u4e2d\u65ad\u8fd4\u56de\u540e\u9700\u8981\u6267\u884c\u7684PC\n    \n    input  i_mret_ena,           //\u4e2d\u65ad\u8fd4\u56de\u4f7f\u80fd\n    \n//------------------------------\u7701\u7565\u4e0e\u8c03\u8bd5\u76f8\u5173\u7684\u4fe1\u53f7-----------------------------------\n\n    input  i_EXE_vld,            //\u6267\u884c\u6709\u6548\n\n\n    output [ 31: 0 ] o_wr_csr_nxt,//\u5199\u5165CSR\u5bc4\u5b58\u5668\u7684\u503c\n\n\n    output o_rd_wen,             //CSR\u5bc4\u5b58\u5668\u8bfb\u4f7f\u80fd\uff0c\u7528\u4e8e\u56de\u5199\n    output [ 4: 0 ] o_wb_rd_idx, //\u56de\u5199\u7d22\u5f15\n    output [ 31: 0 ] o_wb_data,  //\u56de\u5199\u6570\u636e\n\n    output o_meie,               //\u5916\u90e8\u4e2d\u65ad\u4f7f\u80fd\n    output o_msie,               //\u8f6f\u4ef6\u4e2d\u65ad\u4f7f\u80fd\n    output o_mtie,               //\u8ba1\u65f6\u5668\u4e2d\u65ad\u4f7f\u80fd\n    output o_glb_irq,            //\u5168\u5c40\u4e2d\u65ad\u4f7f\u80fd\n\n    input  rst_n                 //\u590d\u4f4d\n")),(0,i.kt)("p",null,"\u53ef\u4ee5\u770b\u51fa\uff0c\u4ee5\u4e0a\u4e3b\u8981\u53ef\u4ee5\u5206\u4e3a\u4e2d\u65ad\u76f8\u5173\u4fe1\u53f7\u548cCSR\u6307\u4ee4\u6267\u884c\u76f8\u5173\u4fe1\u53f7\u3002\u548cexu_alu\u6a21\u5757\u7c7b\u4f3c\uff0ccsr\u6307\u4ee4\u7684\u6267\u884c\u4e5f\u9700\u8981\u5bc4\u5b58\u5668\u76f8\u5173\u7684\u7d22\u5f15\u548c\u503c\u3002\u4e2d\u65ad\u76f8\u5173\u7684\u4fe1\u53f7\u4e3b\u8981\u6709\u9ad8\u5c42\u6a21\u5757\u8f93\u5165\u7684\u4e2d\u65ad/\u5f02\u5e38\u8bf7\u6c42\u4fe1\u53f7\uff0c\u548c\u5e95\u90e8\u6a21\u5757\u8f93\u51fa\u7684\u4e2d\u65ad\u4f7f\u80fd\uff0cPC\u4fe1\u53f7\u3002"),(0,i.kt)("h3",{id:"2\u6267\u884c"},"2\u3001\u6267\u884c"),(0,i.kt)("p",null,"\u4ee3\u7801\u4e3b\u4f53\u90e8\u5206\u662fCSR\u76846\u6761\u6307\u4ee4\uff0c\u4ee3\u7801\u7684\u89e3\u91ca\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"//--------------------\u7701\u7565\u90e8\u5206\u4fe1\u53f7\u7684\u58f0\u660e\u548c\u8d4b\u503c-------------------------\n// CSR\u6307\u4ee4\u6309\u7167\u5982\u4e0b\u6392\u5217\n// i_csr_instr = {rv32i_csrrci, rv32i_csrrsi, rv32i_csrrwi,\n//                rv32i_csrrc,  rv32i_csrrs,  rv32i_csrrw};\n\n// \u5199\u5165\u5bc4\u5b58\u5668\u7684\u503c\nalways @ ( * )\nbegin\n    reg_csr_val <= 32'b0;//\u521d\u59cb\u5316\n    \n    if ( i_SYSTEM & csr_wen )\n    begin\n       \n        case ( i_csr_instr )\n            6'h01:            //rv32i_csrrw\n            begin\n                reg_csr_val <= i_rs1_val;              \n            end\n            6'h02:            //rv32i_csrrs\n            begin\n                reg_csr_val <= i_rs1_val | w_csr_val;  \n            end\n            6'h04:            //rv32i_csrrc\n            begin\n                reg_csr_val <= ( ~i_rs1_val ) & w_csr_val; \n            end\n            6'h08:            //rv32i_csrrwi\n            begin\n                reg_csr_val <= i_csr_imm; \n            end\n            6'h10:            //rv32i_csrrsi\n            begin\n                reg_csr_val <= i_csr_imm | w_csr_val;  \n            end\n            6'h20:            //rv32i_csrrci\n            begin\n                reg_csr_val <= ( ~i_csr_imm ) & w_csr_val; \n            end\n            default: ;\n        endcase\n    end\n\nend\n\n\n//CSR[11:10]/\u673a\u5668\u7801\u7684bit 30-31\u5982\u679c\u4e0d\u4e3a2\u2018b11\uff0c\u5373\u4e3a\u53ef\u8bfb\u53ef\u5199\u7684\u5c5e\u6027\nwire csr_wen  = i_EXE_vld & i_SYSTEM & (i_csr_addr[11:10] != 2'b11);\nwire csr_rden = i_EXE_vld & i_SYSTEM;\n")),(0,i.kt)("p",null,"\u4ee5\u4e0a\u7684\u4ee3\u7801\u7528case\u9009\u62e9\uff0c\u5c06CSR\u7684\u6307\u4ee4\u8fdb\u884c\u533a\u5206\u4ee5\u53ca\u5199\u5bc4\u5b58\u5668\u7684\u5b9e\u73b0\u3002\u7528\u4ee5\u4e0b\u4ee3\u7801\u4e3e\u4f8b"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"6\u2019h02:\n\nbegin\n    reg_csr_val <= i_rs1_val | w_csr_val; //rv32i_csrrs\nend\n")),(0,i.kt)("p",null,"i_csr_instr\u7684bit 2\u5bf9\u5e94\u7684CSR\u6307\u4ee4\u662fCSRRS rd\uff0ccsr\uff0crs1\u3002t = CSRs","[csr]","; CSRs","[csr]"," = t | x","[rs1]","; x","[rd]"," = t"),(0,i.kt)("p",null,"\u8be5\u6307\u4ee4\u662f\u628aCSR\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u8bfb\u51fa\u5e76\u8d4b\u503c\u5230rd\u5bc4\u5b58\u5668\u4e2d\uff0c\u4e14\u5c06CSR\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u548c\u5bc4\u5b58\u5668rs1\u4e2d\u7684\u503c\u6309\u4f4d\u6216(bitwise OR)\u7684\u7ed3\u679c\u5199\u5165CSR\u5bc4\u5b58\u5668\u3002"),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(27441).Z,width:"1730",height:"678"})),(0,i.kt)("p",null,"\u5176\u6307\u4ee4\u7684\u673a\u5668\u7801\u5982\u56fe1\u6240\u793a\u3002\u8fd9\u91cc\u7684\u5b9e\u73b0CSR\u7f6e\u4f4d\u7684\u529f\u80fd\u662f",(0,i.kt)("em",{parentName:"p"},"reg_csr_val <= i_rs1_val | w_csr_val;")," "),(0,i.kt)("p",null,"\u53e6\u5916\u4e00\u90e8\u5206CSR\u8bfb\u5bc4\u5b58\u5668\u7684\u529f\u80fd\u4f1a\u5728csr_reg\u6a21\u5757\u91cc\u5b9e\u73b0\uff0c\u4e4b\u540e\u8bb2\u5230\u8be5\u6a21\u5757\u65f6\u518d\u8fdb\u884c\u89e3\u91ca\u3002"),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(27365).Z,width:"819",height:"75"})),(0,i.kt)("p",null,"\u6240\u6709\u7684CSR\u6307\u4ee4\u90fd\u662f\u6bcf\u6b21\u53ea\u80fd\u5bf9\u4e00\u4e2aCSR\u5bc4\u5b58\u5668\u64cd\u4f5c\uff0c\u5176\u673a\u5668\u7801\u5982\u56fe1\u6240\u793a\u3002\u53ef\u4ee5\u770b\u5230CSR\u6307\u4ee4\u7c7b\u4f3c\u4e8eI-type\u6307\u4ee4\u3002\u867d\u7136\u4e5f\u670912\u4f4d\u7684\u7acb\u5373\u6570\u57df\uff0c\u4f46\u662f\u5b9e\u9645\u4e0a",(0,i.kt)("strong",{parentName:"p"},"\u673a\u5668\u7801\u7684bit 20-31\u662f\u7528\u6765 \u7d22\u5f15\u76f8\u5e94CSR\u5bc4\u5b58\u5668\u7684\u5730\u5740"),"\u3002\u6240\u4ee5\u7406\u8bba\u4e0a\uff0c\u4e00\u5171\u53ef\u4ee5\u5b9e\u73b02^12 = 4096\u4f4dCSR\u5bc4\u5b58\u5668\u3002"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"\u6309\u7167\u60ef\u4f8b\uff0cCSR\u5730\u5740\u7684\u9ad8\u4f4d(CSR","[11:8]","/\u673a\u5668\u7801\u7684bit 28-31)\u7528\u4e8e\u6839\u636e\u6743\u9650\u7ea7\u522b\u5bf9CSR\u7684\u8bfb\u5199\u53ef\u8bbf\u95ee\u6027\u8fdb\u884c\u7f16\u7801\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"//CSR\u5bc4\u5b58\u5668bit 10-11\u5982\u679c\u4e0d\u4e3a2\u2018b11\u5373\u4e3a\u53ef\u8bfb\u53ef\u5199\u7684\u5c5e\u6027 \nwire csr_wen = i_EXE_vld & i_SYSTEM & (i_csr_addr[11:10] != 2'b11); \nwire csr_rden = i_EXE_vld & i_SYSTEM;\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"\u524d\u4e24\u4f4d(CSR","[11:10]","/\u673a\u5668\u7801\u7684bit 30-31)\u6307\u793a\u8be5CSR\u5bc4\u5b58\u5668\u662f\u53ef\u8bfb\u53ef\u5199(00\uff0c01\u621610)\u8fd8\u662f\u53ea\u8bfb(11)\u3002"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"\u63a5\u4e0b\u6765\u4e24\u4f4d(CSR","[9:8]","/\u673a\u5668\u7801\u7684bit 28-29)\u7f16\u7801\u8868\u660e\u53ef\u4ee5\u8bbf\u95ee\u8be5CSR\u5bc4\u5b58\u5668\u7684\u6700\u4f4e\u7279\u6743\u7ea7\u522b ","[2]","\u3002")))),(0,i.kt)("p",null,"\u8fd9\u91cc\uff0c\u901a\u8fc7wire csr_wen\u548cwire csr_rden \u4fe1\u53f7\u7684\u5b9e\u73b0\uff0c\u5bf9\u76f8\u5e94\u7684CSR\u5bc4\u5b58\u5668\u8fdb\u884c\u53ef\u8bfb\u53ef\u5199\u5c5e\u6027\u7684\u533a\u5206\u3002"),(0,i.kt)("h3",{id:"3csr_reg\u5b9e\u4f8b"},"3\u3001csr_reg\u5b9e\u4f8b"),(0,i.kt)("p",null,"exu_csr\u6a21\u5757\u4e0b\u7531csr_reg\u6a21\u5757\u7684\u4f8b\u5316\uff0c\u5f88\u591aexu_csr\u7684\u8f93\u51fa\u4fe1\u53f7\u7531csr_reg\u6a21\u5757\u4f20\u9012\u4e0a\u6765\uff0c\u540c\u6837\uff0c\u4e00\u4e9bexu_csr\u7684\u8f93\u5165\u4fe1\u53f7\uff0c\u4e5f\u7ee7\u7eed\u5f80\u4e0b\u4f20\u9012\u5230\u4e86csr_reg\u6a21\u5757\u3002\u8be6\u7ec6\u4ee3\u7801\u89c1\u4e0b\u56fe\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"csr_reg csr_reg_U\n(\n    .sys_clk        ( sys_clk ),//\u7cfb\u7edf\u65f6\u949f\n \n    .i_mret_ena     ( i_mret_ena ),//\u4e2d\u65ad\u8fd4\u56de\u4f7f\u80fd\n \n    .i_EXE_vld      ( i_EXE_vld ),//\u6267\u884c\u6709\u6548\n//\u4e2d\u65ad\u8bf7\u6c42\u548c\u4e2d\u65ad\u6e90\n    .i_ext_irq      ( i_ext_irq ),\n    .i_sft_irq      ( i_sft_irq ),\n    .i_tmr_irq      ( i_tmr_irq ),\n    .i_irq_src      ( i_irq_src & o_glb_irq),\n  \n//\u5f02\u5e38\u6e90\uff0c\u5f02\u5e38PC\u548c\u5f02\u5e38\u6307\u4ee4  \n    .i_exp_src      ( i_exp_src ),\n    .i_exe_pc       ( i_exe_pc ),\n    .i_ir           ( i_ir ),\n//\u4e2d\u65adPC\u548c\u4e2d\u65ad\u5165\u53e3\u5730\u5740\n    .o_irq_pc       ( o_irq_pc ),\n    .o_mepc         ( o_mepc ),\n     \n//------------------------------\u7701\u7565\u4e0e\u8c03\u8bd5\u76f8\u5173\u7684\u4fe1\u53f7-----------------------------------\n \n//CSR\u6307\u4ee4\u76f8\u5173\u4fe1\u53f7    \n    .i_csr_rden     ( csr_rden ),\n    .i_csr_addr     ( i_csr_addr ),\n    .i_csr_val      ( reg_csr_val ),\n    .i_csr_wen      ( csr_wen ),\n    .o_csr_val      ( w_csr_val ),\n \n//\u7531mie\uff0cmstatus\u5bc4\u5b58\u5668\u8f93\u51fa\u7684\u4e2d\u65ad\u4f7f\u80fd\u4fe1\u53f7\n    .o_meie         ( o_meie ),\n    .o_msie         ( o_msie ),\n    .o_mtie         ( o_mtie ),\n    .o_glb_irq      ( o_glb_irq ),\n \n    .rst_n          ( rst_n )//\u590d\u4f4d\n);\n\n")),(0,i.kt)("h2",{id:"\u4e8ccsr_reg\u6a21\u5757"},"\u4e8c\u3001csr_reg\u6a21\u5757"),(0,i.kt)("p",null,"\u672c\u6587\u4f7f\u7528\u7684\u4ee3\u7801\u662f\u57fa\u4e8eFII RISC-V V2.01(\u6ca1\u6709JTAG\u548c\u603b\u7ebf)\u3002csr_reg\u7684\u4e0a\u5c42\u6a21\u5757\u89c1",(0,i.kt)("a",{parentName:"p",href:"https://www.icfedu.cn/archives/7006"},"RISC-V CSR\u8bfb\u5199\u63a7\u5236\uff081\uff09exu_csr\u6a21\u5757"),"\uff0c\u8fd9\u91cc\u5c06\u4e3b\u8981\u4ecb\u7ecdcsr_reg\u6a21\u5757\uff0c\u7ee7\u7eedCSR\u8bfb\u5199\u63a7\u5236\u7684\u5b66\u4e60\u3002"),(0,i.kt)("h3",{id:"1\u8f93\u5165\u8f93\u51fa-1"},"1\u3001\u8f93\u5165\u8f93\u51fa"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"    input sys_clk,             //\u7cfb\u7edf\u65f6\u949f\n\n\n//---------------\u8fd9\u91cc\u540c\u6837\u7701\u7565\u8c03\u8bd5\u6709\u5173\u4fe1\u53f7--------------\n  \n    input i_EXE_vld,           //\u6267\u884c\u6709\u6548\n\n    input i_ext_irq,           //\u5916\u90e8\u4e2d\u65ad\u8bf7\u6c42\n    input i_sft_irq,           //\u8f6f\u4ef6\u4e2d\u65ad\u8bf7\u6c42\n    input i_tmr_irq,           //\u8ba1\u65f6\u5668\u4e2d\u65ad\u8bf7\u6c42\n\n    input i_irq_src,           //\u4e2d\u65ad\u6e90\n    input i_exp_src,           //\u5f02\u5e38\u6e90\n    input [ 31: 0 ] i_exe_pc,  //\u6267\u884c\u7684\u7a0b\u5e8f\u8ba1\u6570\u5668\n    input [ 31: 0 ] i_ir,      //\u6307\u4ee4\u5bc4\u5b58\u5668\n\n    output [ 31: 0 ] o_mepc,   //\u4e2d\u65ad\u8fd4\u56de\u540e\u9700\u8981\u6267\u884c\u7684PC\n    output [ 31: 0 ] o_irq_pc, //\u4e2d\u65ad\u5165\u53e3\u5730\u5740\n\n    input i_csr_rden,          //CSR\u5bc4\u5b58\u5668\u53ef\u8bfb\n    input [ 11: 0 ] i_csr_addr,//csr\u7684\u6307\u4ee4(6\u6761\u4e4b\u4e00)\n    input [ 31: 0 ] i_csr_val, //CSR\u6307\u4ee4\u5199\u5230CSR\u5bc4\u5b58\u5668\u7684\u503c\n    input i_csr_wen,           //CSR\u5bc4\u5b58\u5668\u53ef\u5199\n    output [ 31: 0 ] o_csr_val,//CSR\u5bc4\u5b58\u5668\u8bfb\u51fa\u6765\u7684\u503c\n\n    output o_meie,             //\u5916\u90e8\u4e2d\u65ad\u4f7f\u80fd\n    output o_msie,             //\u8f6f\u4ef6\u4e2d\u65ad\u4f7f\u80fd\n    output o_mtie,             //\u8ba1\u65f6\u5668\u4e2d\u65ad\u4f7f\u80fd\n    output o_glb_irq,          //\u5168\u5c40\u4e2d\u65ad\u4f7f\u80fd\n\n    input rst_n                //\u590d\u4f4d\n\n")),(0,i.kt)("h3",{id:"2\u6267\u884c-1"},"2\u3001\u6267\u884c"),(0,i.kt)("p",null,"\u4ee3\u7801\u4e3b\u4f53\u4e2d\u9664\u4e86\u4e00\u4e9b\u4fe1\u53f7\u7684\u58f0\u660e\u548c\u4f20\u9012\uff0c\u8fd8\u6709\u5bf9CSR\u5bc4\u5b58\u5668\u7684\u8bfb\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"assign o_csr_val = csr_reh_sel;  //CSR\u5bc4\u5b58\u5668\u8bfb\u51fa\u6765\u7684\u503c\n\nalways@( * )   //CSR \u8bfb\u53d6\n\ncase ( i_csr_addr & { 12{ i_csr_rden } } )\n    12'h300: csr_reh_sel = w_mstatus;\n    12'h301: csr_reh_sel = w_misa;\n    12'h304: csr_reh_sel = w_mie;\n    12'h305: csr_reh_sel = w_mtvec;\n    12'h306: csr_reh_sel = w_mcounteren;\n    12'hf11: csr_reh_sel = w_mvendorid;\n    12'hf12: csr_reh_sel = w_marchid;\n    12'hf13: csr_reh_sel = w_mimpid;\n    12'hf14: csr_reh_sel = w_mhartid;\n    12'h340: csr_reh_sel = w_mscratch;\n    12'h341: csr_reh_sel = o_mepc;\n    12'h342: csr_reh_sel = w_mcause;\n    12'h343: csr_reh_sel = w_mtval;\n    12'h344: csr_reh_sel = w_mip;\n    12'hb00: csr_reh_sel = w_mcycle_l;\n    12'hb80: csr_reh_sel = w_mcycle_h;\n    12'hb02: csr_reh_sel = w_minstret_l;\n    12'hb82: csr_reh_sel = w_minstret_h;\n    12'h7b0: csr_reh_sel = i_dcsr;\n    12'h7b1: csr_reh_sel = i_dpc;\n    12'h7b2: csr_reh_sel = i_dscratch;\n    default: csr_reh_sel = 32'b0;\nendcase\n")),(0,i.kt)("p",null,"\u53ef\u4ee5\u770b\u5230\uff0c\u901a\u8fc7\u5bf9CSR\u5730\u5740\u7684\u7d22\u5f15\u548cCSR\u53ef\u8bfb\u5c5e\u6027\u7684\u5224\u65ad\uff0c\u5728\u4e0d\u540c\u7684case\u4e0b\uff0c\u5c06\u4e0d\u540cCSR\u5bc4\u5b58\u5668\u7684\u503c\u8bfb\u51fa\u6765\u3002"),(0,i.kt)("p",null,"\u6ce8\u610f\uff1a\u8fd9\u91cc\u7684case\u9009\u62e9\uff0c\u867d\u7136\u5217\u51fa\u4e8621\u6761\uff0c\u4f46\u662f\u5728\u6bcf\u4e00\u6b21\u7684CSR\u6307\u4ee4\u8bfb\u53d6\u4e2d\uff0c\u53ea\u4f1a\u6709\u4e00\u4e2a\u786e\u5207\u7684CSR\u5bc4\u5b58\u5668\u88ab\u8bfb\u53d6\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e00\u6761CSR\u6307\u4ee4\u53ea\u4f1a\u6839\u636e\u9700\u8981\u7684\u5730\u5740",(0,i.kt)("strong",{parentName:"p"},"\u6bcf\u6b21\u53ea\u6267\u884c\u4e00\u6761"),"case\u3002"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"case ( i_csr_addr & { 12{ i_csr_rden } } )")),(0,i.kt)("p",null,"\u8fd9\u4e2a\u5199\u6cd5\u4e2d ",(0,i.kt)("em",{parentName:"p"},"{ 12{ i_csr_rden } }"),"\u7684",(0,i.kt)("em",{parentName:"p"},"i_csr_rden"),"\u539f\u672c\u662f1bit\u7684\u4fe1\u53f7\uff0c\u8fd9\u91cc\u628a\u5b83\u6269\u5c55\u621012\u4f4d\uff0c\u662f\u4e3a\u4e86\u4fbf\u4e8e\u548cCSR\u5730\u5740\u8fd0\u7b97\u3002\u4f8b\u5982\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u5982\u679c\u8be5CSR\u5bc4\u5b58\u5668\u53ef\u8bfb\uff0c",(0,i.kt)("em",{parentName:"li"},"i_csr_rden"),"\u4e3a1\uff0c",(0,i.kt)("em",{parentName:"li"},"{ 12{ i_csr_rden } }"),"\u5373\u4e3a12\u2018b1111_1111_1111\uff0c\u4e0e ",(0,i.kt)("em",{parentName:"li"},"i_csr_addr"),"\u76f8\u4e0e\u5f97\u5230\u7684\u503c\uff0c\u662f ",(0,i.kt)("em",{parentName:"li"},"i_csr_addr"),"\u672c\u8eab\uff0c\u5f00\u59cbcase\u9009\u62e9\uff1b"),(0,i.kt)("li",{parentName:"ul"},"\u5982\u679c\u8be5CSR\u5bc4\u5b58\u5668\u4e0d\u53ef\u8bfb\uff0c",(0,i.kt)("em",{parentName:"li"},"i_csr_rden"),"\u4e3a0\uff0c",(0,i.kt)("em",{parentName:"li"},"{ 12{ i_csr_rden } }"),"\u5373\u4e3a12\u2018b00000_0000_0000\uff0c\u4e0e",(0,i.kt)("em",{parentName:"li"},"i_csr_addr"),"\u76f8\u4e0e\u5f97\u5230\u7684\u503c\u4e3a0\uff0c\u4efb\u4f55case\u90fd\u4e0d\u6ee1\u8db3\uff0c\u8df3\u5230default\u8bed\u53e5\uff0c\u4e5f\u5c31\u662f\uff0c\u5c06CSR\u5bc4\u5b58\u5668\u8bfb\u51fa\u7684\u503c\u8d4b0\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"assign o_glb_irq = w_mstatus[3];  //\u5168\u5c40\u4e2d\u65ad\u4f7f\u80fd\n\nwire [ 31: 0 ] vect_pc = {w_mtvec[ 31: 2 ], 2'b00} + {w_mcause[ 3: 0 ], 2'b00};  // Mode1\uff0c\u5411\u91cf\u5730\u5740 = base + 4 X cause\n\nassign o_irq_pc = ( w_mtvec[ 1: 0 ] == 0 ) ? {w_mtvec[ 31: 2 ], 2'b00}://\u9009\u62e9\u4e2d\u65ad\u5165\u53e3\u5730\u5740\n                  ( w_mtvec[ 1 :0 ] == 1 ) ? vect_pc : o_irq_pc;\n\nwire status_ena = w_mstatus[3] & ( o_meie | o_mtie | o_msie ) & i_irq_src;//\u53d1\u751f\u4e2d\u65ad\n")),(0,i.kt)("p",null,"\u4e0a\u9762\u7684\u4ee3\u7801\u662f\u5173\u4e8e\u8f93\u51fa\u5168\u5c40\u4e2d\u65ad\u4f7f\u80fd",(0,i.kt)("em",{parentName:"p"},"o_glb_irq"),"\uff0c\u4f20\u9012",(0,i.kt)("em",{parentName:"p"},"ststus_ena"),"\u4e2d\u65ad\u53d1\u751f\u4fe1\u53f7\u7ed9mstatus\u5bc4\u5b58\u5668\uff0c\u7528\u4e8eMPIE\u548cMIE\u4f4d\u7684\u5224\u65ad\u3002"),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"o_irq_pc"),"\u662f\u4e2d\u65ad\u7684\u5165\u53e3\u5730\u5740\uff0c\u7531",(0,i.kt)("em",{parentName:"p"},"w_mtvec"),"\u7684bit 0-1\u51b3\u5b9a\u8f93\u51fa\u7684Mode"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Mode\u4e3a1\u65f6\uff0c\u4e2d\u65ad\u5165\u53e3\u5730\u5740\u662f\u5411\u91cf\u5730\u5740\uff0c\u7531base\u57fa\u5730\u5740 + 4 X cause(\u7531mcause\u5bc4\u5b58\u5668\u51b3\u5b9a)\u7ec4\u6210"),(0,i.kt)("li",{parentName:"ul"},"Mode\u4e3a0\u65f6\uff0c\u4e2d\u65ad\u5165\u53e3\u76f4\u63a5\u88ab\u8d4b\u503c\u6210base\u57fa\u5730\u5740"),(0,i.kt)("li",{parentName:"ul"},"\u5982\u679cMode\u7b49\u4e8e2\u6216\u80053\uff0c\u4fdd\u7559\u503c\uff0c\u76ee\u524d\u6ca1\u6709\u5b9a\u4e49")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"\u6ce8\u610f\uff1amtvec\u5bc4\u5b58\u5668\u4e2d bit 2-31\u4e2d\u53ea\u670930\u4f4d\u7684base\u57fa\u5730\u5740\uff0c\u56e0\u4e3a\u9ed8\u8ba4\u4e2d\u65ad\u8df3\u8f6c\u7684\u5730\u5740\u90fd\u662f4\u5b57\u8282\u5bf9\u9f50 ","[1]","\u3002"),"\u6240\u4ee5\u771f\u6b63\u7684\u4e2d\u65ad\u5165\u53e3\u5730\u5740\uff0c\u8fd8\u9700\u8981\u5de6\u79fb2\u4f4d\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u4ee3\u7801\u4e2d\u7684",(0,i.kt)("em",{parentName:"p"},"{w_mtvec","[ 31: 2 ]",", 2\u2019b00}"),"\u3002"),(0,i.kt)("h3",{id:"3csr\u5bc4\u5b58\u5668\u5b9e\u4f8b"},"3\u3001CSR\u5bc4\u5b58\u5668\u5b9e\u4f8b"),(0,i.kt)("p",null,"csr_reg\u6a21\u5757\u4e0b\u7684\u5b9e\u4f8b\u7531\u6240\u6709\u5b9e\u73b0\u7684CSR\u5bc4\u5b58\u5668\u6784\u6210\uff0c\u6709\u4ee5\u4e0b\u5bc4\u5b58\u5668\u6a21\u5757\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"csr_mtvec"),(0,i.kt)("li",{parentName:"ul"},"csr_mstatus"),(0,i.kt)("li",{parentName:"ul"},"csr_mtval"),(0,i.kt)("li",{parentName:"ul"},"csr_mepc"),(0,i.kt)("li",{parentName:"ul"},"csr_mcause"),(0,i.kt)("li",{parentName:"ul"},"csr_mie"),(0,i.kt)("li",{parentName:"ul"},"csr_mip"),(0,i.kt)("li",{parentName:"ul"},"csr_misa"),(0,i.kt)("li",{parentName:"ul"},"csr_mcounteren"),(0,i.kt)("li",{parentName:"ul"},"csr_mid\uff1a\u5305\u62ecmvendorid\uff0cmarchid\uff0cmimpid\u548cmhartid"),(0,i.kt)("li",{parentName:"ul"},"csr_scratch\uff1amscratch\u5bc4\u5b58\u5668"),(0,i.kt)("li",{parentName:"ul"},"csr_mcycle\uff1a\u5305\u62ec\u4f4e\u4f4d\u548c\u9ad8\u4f4d\u768432\u4f4d\u5bc4\u5b58\u5668\uff0c\u5171\u7ec4\u621064\u4f4d"),(0,i.kt)("li",{parentName:"ul"},"csr_minstret\uff1a\u5305\u62ec\u4f4e\u4f4d\u548c\u9ad8\u4f4d\u768432\u4f4d\u5bc4\u5b58\u5668\uff0c\u5171\u7ec4\u621064\u4f4d"),(0,i.kt)("li",{parentName:"ul"},"dug_csr\uff1a\u5305\u62ec\u4e00\u4e9b\u548c\u8c03\u8bd5\u6709\u5173\u7684\u4fe1\u53f7")),(0,i.kt)("h2",{id:"\u4e09csr\u5bc4\u5b58\u5668\u5b9e\u73b0"},"\u4e09\u3001CSR\u5bc4\u5b58\u5668\u5b9e\u73b0"),(0,i.kt)("h3",{id:"1\u5bc4\u5b58\u5668\u6a21\u5757"},"1\u3001\u5bc4\u5b58\u5668\u6a21\u5757"),(0,i.kt)("p",null,"\u8981\u4ecb\u7ecd\u7684\u5bc4\u5b58\u5668\u6a21\u5757\u4e3b\u8981\u5305\u62ec\u4ee5\u4e0b(\u5176\u4e2d\u7684\u6709\u4e9bCSR\u5bc4\u5b58\u5668\u6ca1\u6709\u5b8c\u5168\u5b9e\u73b0)\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"csr_mtvec"),(0,i.kt)("li",{parentName:"ul"},"csr_mstatus"),(0,i.kt)("li",{parentName:"ul"},"csr_mtval"),(0,i.kt)("li",{parentName:"ul"},"csr_mepc"),(0,i.kt)("li",{parentName:"ul"},"csr_mcause"),(0,i.kt)("li",{parentName:"ul"},"csr_mie"),(0,i.kt)("li",{parentName:"ul"},"csr_mip"),(0,i.kt)("li",{parentName:"ul"},"csr_misa"),(0,i.kt)("li",{parentName:"ul"},"csr_mcounteren"),(0,i.kt)("li",{parentName:"ul"},"csr_mid\uff1a\u5305\u62ecmvendorid\uff0cmarchid\uff0cmimpid\u548cmhartid"),(0,i.kt)("li",{parentName:"ul"},"csr_scratch\uff1amscratch\u5bc4\u5b58\u5668"),(0,i.kt)("li",{parentName:"ul"},"csr_mcycle\uff1a\u5305\u62ec\u4f4e\u4f4d\u548c\u9ad8\u4f4d\u768432\u4f4d\u5bc4\u5b58\u5668\uff0c\u5171\u7ec4\u621064\u4f4d"),(0,i.kt)("li",{parentName:"ul"},"csr_minstret\uff1a\u5305\u62ec\u4f4e\u4f4d\u548c\u9ad8\u4f4d\u768432\u4f4d\u5bc4\u5b58\u5668\uff0c\u5171\u7ec4\u621064\u4f4d")),(0,i.kt)("h4",{id:"csr_mtvec"},"csr_mtvec"),(0,i.kt)("p",null,"mtvec\u662f\u4e00\u4e2a\u53ef\u8bfb\u53ef\u5199\u5bc4\u5b58\u5668\u3002\u867d\u7136mtvec\u6709\u4e24\u79cd\u6a21\u5f0f\uff0c\u4f46\u8fd9\u91cc\u53ea\u5b9e\u73b0\u4e86MODE 0\uff0c \u4e5f\u5c31\u662f\u8bf4\uff0c\u6240\u6709\u7684\u4e2d\u65ad\u5165\u53e3\u5730\u5740\u90fd\u662f\u57fa\u5730\u5740\u3002\u5b9e\u73b0mtvec\u7684\u5bc4\u5b58\u5668\u7684\u90e8\u5206\u91cd\u8981\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"input [ 11: 0 ] i_csr_addr, //\u7d22\u5f15\u5bc4\u5b58\u5668\u7684\u5730\u5740\ninput [ 31: 0 ] i_csr_val,  //CSR\u6307\u4ee4\u5199\u5230\u5bc4\u5b58\u5668\u4e0a\u7684\u503c\ninput i_csr_wen,            //csr\u53ef\u5199\u7684\u5c5e\u6027\n\noutput [ 31: 0 ] o_mtvec,   //\u8f93\u51famtvec\n\n\n\nwire wbck_csr_wen = i_csr_wen; //\u786e\u5b9a\u8be5\u5bc4\u5b58\u5668\u53ef\u5199\nwire sel_mtvec = ( i_csr_addr == 12'h305 );     //\u901a\u8fc7\u5730\u5740\u7d22\u5f15\u786e\u8ba4\u5bc4\u5b58\u5668\n\nwire wr_mtvec = sel_mtvec & i_csr_wen;          //\u786e\u8ba4\u8be5\u5bc4\u5b58\u5668\u65e2\u53ef\u5199\uff0c\u53c8\u7684\u786e\u662fmtvec\nwire mtvec_ena = ( wr_mtvec & wbck_csr_wen );   //\u786e\u8ba4mtvec\u5bc4\u5b58\u5668\u53ef\u5199\nwire [ 31: 0 ] mtvec_r;\nwire [ 31: 0 ] mtvec_nxt = { i_csr_val[ 31: 2 ] , 2'b00 }; //\u4e2d\u65ad\u5165\u53e3\u5730\u5740\u90fd\u662f\u57fa\u5730\u5740\uff0c MODE == 2'b00\n\nfii_dfflr #( 32 ) mtvec_dfflr ( mtvec_ena, mtvec_nxt, mtvec_r, sys_clk, rst_n ); //\u9501\u5b58\n\nassign o_mtvec = mtvec_r; //\u8f93\u51fa\n")),(0,i.kt)("h4",{id:"csr_msatus"},"csr_msatus"),(0,i.kt)("p",null,"mstatus\u662f\u4e00\u4e2a\u53ef\u8bfb\u53ef\u5199\u5bc4\u5b58\u5668\u3002",(0,i.kt)("strong",{parentName:"p"},"mstatus\u63a7\u5236\u5168\u5c40\u4e2d\u65ad\u7684\u4f7f\u80fd"),"\u3002\u5b9e\u73b0msatus\u7684\u5bc4\u5b58\u5668\u7684\u90e8\u5206\u91cd\u8981\u4ee3\u7801\u5982\u4e0b(\u4e0e\u4e0a\u6587\u91cd\u590d\u7684\u4ee3\u7801\u7701\u7565)\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"input i_mret_ena,        //\u4e2d\u65ad\u8fd4\u56de\ninput i_status_ena,      //\u7531\u5168\u5c40\u4e2d\u65ad&\u4e2d\u65ad\u4f7f\u80fd(\u5305\u62ec\u8ba1\u65f6\u5668/\u5916\u90e8/\u8f6f\u4ef6)&\u4e2d\u65ad\u6e90\u7ec4\u6210\n\noutput [31:0] o_mstatus, //\u8f93\u51famstatus\n\n\nwire sel_mstatus = (i_csr_addr == 12'h300);   //\u901a\u8fc7\u5730\u5740\u7d22\u5f15\u786e\u8ba4\u5bc4\u5b58\u5668\n\nwire wr_mstatus = sel_mstatus & wbck_csr_wen; //\u786e\u8ba4\u8be5\u5bc4\u5b58\u5668\u65e2\u53ef\u5199\uff0c\u53c8\u7684\u786e\u662fmstatus\nwire status_mpie_r;\nwire status_mie_r;\n// \u5728\u4ee5\u4e0b\u60c5\u51b5\u66f4\u65b0MPIE\u4f4d\nwire status_mpie_ena = \n                      // CSR\u6307\u4ee4\u5199\u5165\n                      wr_mstatus |\n                      // \u4e2d\u65ad\u8fd4\u56de\n                      i_mret_ena |\n                      // \u4e2d\u65ad\u5230\u6765\n                      i_status_ena;\n\nwire status_mpie_nxt = \n                      //\u4e2d\u65ad\u6765\u65f6\uff0cMPIE\u4f4d\u66f4\u65b0\u4e3aMIE\u4f4d\n                      i_status_ena ? status_mie_r :\n                      // \u4e2d\u65ad\u8fd4\u56de\u65f6\uff0cMPIE\u8bbe\u7f6e\u62101\n                      i_mret_ena ? 1'b1 :\n                      // CSR\u6307\u4ee4\u5199\u5165\n                      wr_mstatus ? i_csr_val[7] : // MPIE\u662fmstatus\u5bc4\u5b58\u5668\u7684bit 7\n                      status_mpie_r; // \u5982\u679c\u4ee5\u4e0a\u6761\u4ef6\u90fd\u4e0d\u6ee1\u8db3\uff0cMPIE\u4e0d\u53d8\n\nfii_dfflr #(1) status_mpie_dfflr (status_mpie_ena, status_mpie_nxt, status_mpie_r, sys_clk, rst_n);//\u9501\u5b58\n\n// MIE\u7684\u5b9e\u73b0\u4e0eMPIE\u7c7b\u4f3c\nwire status_mie_ena = status_mpie_ena; \nwire status_mie_nxt = \n                     // \u4e2d\u65ad\u6765\u4e34\u65f6\uff0cMIE\u5c06\u503c\u7ed9MPIE\uff0c\u7136\u540e\u81ea\u5df1\u6e05\u96f6\n                     i_status_ena ? 1'b0 :\n                     // \u4e2d\u65ad\u8fd4\u56de\u65f6\uff0cMIE\u5f97\u5230\u5b58\u50a8\u5728MPIE\u4e2d\u7684\u503c\n                     i_mret_ena ? status_mpie_r :\n                     // CSR\u6307\u4ee4\u5199\u5165\n                     wr_mstatus ? i_csr_val[3] : // MIE\u662fmstatus\u5bc4\u5b58\u5668\u7684bit 3\n                     status_mie_r; // \u5982\u679c\u4ee5\u4e0a\u6761\u4ef6\u90fd\u4e0d\u6ee1\u8db3\uff0cMIE\u4e0d\u53d8\n\nfii_dfflr #(1) status_mie_dfflr (status_mie_ena, status_mie_nxt, status_mie_r, sys_clk, rst_n);//\u9501\u5b58\n\n\n//\u5206\u522b\u5bf9mstatus\u7684\u6bcf\u4e00bit\u5206\u5f00\u8d4b\u503c\nwire [31:0] status_tmp;\nassign status_tmp[31]    = status_sd_r; // SD\nassign status_tmp[30:23] = 8'b0; // \u4fdd\u7559\nassign status_tmp[22:17] = 6'b0; // TSR--MPRV\nassign status_tmp[16:15] = status_xs_r; // XS\nassign status_tmp[14:13] = status_fs_r; // FS\nassign status_tmp[12:11] = 2'b11; // MPP \nassign status_tmp[10:9]  = 2'b0; // \u4fdd\u7559\nassign status_tmp[8]     = 1'b0; // SPP\nassign status_tmp[7]     = status_mpie_r; // MPIE\nassign status_tmp[6]     = 1'b0; // \u4fdd\u7559\nassign status_tmp[5]     = 1'b0; // SPIE \nassign status_tmp[4]     = 1'b0; // UPIE \nassign status_tmp[3]     = status_mie_r; // MIE\nassign status_tmp[2]     = 1'b0; // \u4fdd\u7559\nassign status_tmp[1]     = 1'b0; // SIE \nassign status_tmp[0]     = 1'b0; // UIE\n\n\nassign o_mstatus = status_tmp;//\u8f93\u51fa\n\n")),(0,i.kt)("h4",{id:"csr_mtval"},"csr_mtval"),(0,i.kt)("p",null,"mtval\u4e5f\u662f\u53ef\u8bfb\u53ef\u5199\u7684\u5bc4\u5b58\u5668\uff0c",(0,i.kt)("strong",{parentName:"p"},"\u7528\u6765\u5b58\u50a8\u5f15\u53d1\u5f02\u5e38\u7684\u539f\u56e0"),"\uff0c\u6bd4\u5982\u975e\u6cd5\u6307\u4ee4\uff0c\u5f02\u5e38\u6709\u5173\u7684\u4fe1\u606f\u7b49\u7528\u6765\u5e2e\u52a9\u8f6f\u4ef6\u5904\u7406\uff0c\u8fd9\u91cc\u6ca1\u6709\u5b8c\u5168\u5b9e\u73b0\uff0c\u53ea\u6709\u57fa\u672c\u7684\u8bfb\u5199\u3002\u5728\u4e4b\u524d\u7684\u5b9a\u4e49\u4e2d\uff0c\u662fmbadaddr\u3002\u76f8\u5173\u7684\u4ee3\u7801\u5982\u4e0b(\u4e0e\u4e0a\u6587\u91cd\u590d\u7684\u4ee3\u7801\u7701\u7565)\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"input i_irq_src,          //\u4e2d\u65ad\u6e90\ninput i_exp_src,          //\u5f02\u5e38\u6e90\ninput [ 31: 0 ] i_exe_pc, //\u5f53\u524d\u7684PC\ninput [ 31: 0 ] i_ir,     //\u5f53\u524d\u7684\u6307\u4ee4\n\noutput [ 31: 0 ] o_mtval, //\u8f93\u51famtval\n\n\nwire sel_mtval = ( i_csr_addr == 12'h343 ); //\u901a\u8fc7\u5730\u5740\u7d22\u5f15\u786e\u8ba4\u5bc4\u5b58\u5668\nwire mtval_ena;\nwire [ 31: 0 ] mtval_r;\nwire [ 31: 0 ] mtval_nxt;\nassign mtval_nxt = trap_mtval_ena ? i_trap_mtval_val : i_csr_val;//\u5982\u679c\u662f\u4e2d\u65ad/\u5f02\u5e38\uff0c\u5b58\u50a8\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u4e0d\u7136\u7531CSR\u6307\u4ee4\u5199\u5165\nfii_dfflr #( 32 ) mtval_dfflr ( mtval_ena, mtval_nxt, mtval_r, sys_clk, rst_n );//\u9501\u5b58\n\nassign o_mtval = mtval_r;//\u8f93\u51fa\n\nendmodule\n")),(0,i.kt)("h4",{id:"csr_mepc"},"csr_mepc"),(0,i.kt)("p",null,"mepc\u5bc4\u5b58\u5668\u4e2d\u5b58\u50a8\u5728\u4e2d\u65ad\u6216\u5f02\u5e38\u53d1\u751f\u65f6\u7684",(0,i.kt)("strong",{parentName:"p"},"\u51c6\u5907\u6267\u884c\u6307\u4ee4"),"\u7684PC\u503c\uff0c\u5c06\u5728\u5f02\u5e38\u5b50\u7a0b\u5e8f\u4e2d\u4f5c\u4e3a\u8fd4\u56de\u5730\u5740\uff0c\u662f\u4e00\u4e2a\u53ef\u8bfb\u53ef\u5199\u7684\u5bc4\u5b58\u5668\u3002\u5b9e\u73b0mepc\u5bc4\u5b58\u5668\u7684\u90e8\u5206\u91cd\u8981\u4ee3\u7801\u5982\u4e0b(\u4e0e\u524d\u9762\u6a21\u5757\u4e2d\u91cd\u590d\u7684\u4ee3\u7801\u7701\u7565)\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"input i_irq_src,//\u4e2d\u65ad\u6e90\ninput i_exp_src,//\u5f02\u5e38\u6e90\ninput [ 31: 0 ] i_exe_pc,//\u5f53\u524d\u7684PC\n\noutput [ 31: 0 ] o_mepc,//\u8f93\u51famepc\n\n\nwire [ 31: 0 ] i_mepc;\nwire [ 31: 0 ] mepc_r;\n\n\nwire mepc_valid = (i_irq_src | i_exp_src) ? 1'b1 : 1'b0;//\u4e2d\u65ad\u6216\u8005\u5f02\u5e38\u5230\u6765\nassign i_mepc = mepc_valid ? i_exe_pc : mepc_r;//\u5982\u679c\u6709\u4e2d\u65ad/\u5f02\u5e38\u5230\u6765\uff0c\u628aPC\u8bbe\u7f6e\u6210\u5f53\u524dPC\uff0c\u5426\u5219\u7528\u4e4b\u524d\u5b58\u50a8\u7684mepc\n\n\nwire sel_mepc = ( i_csr_addr == 12'h341 );//\u901a\u8fc7\u5730\u5740\u7d22\u5f15\u786e\u8ba4\u5bc4\u5b58\u5668\nwire wr_mepc = sel_mepc & i_csr_wen;// mepc\u5bc4\u5b58\u5668\u53ef\u5199\nwire mepc_ena = wr_mepc | mepc_valid;//\u4f7f\u80fd\u7531CSR\u6307\u4ee4\u5199\u5165\u6216\u8005\u4e2d\u65ad/\u5f02\u5e38\u7f6e\u8d77\u6765\n\nwire [ 31: 0 ] mepc_nxt;\nassign mepc_nxt[ 31: 1 ] = mepc_valid ? i_mepc[ 31 : 1 ] : i_csr_val[ 31 : 1 ];//\u5982\u679c\u6709\u4e2d\u65ad\uff0c\u5199\u5165\u4e2d\u65ad\u7684\u8fd4\u56de\u5730\u5740\uff0c\u4e0d\u7136\u7531CSR\u6307\u4ee4\u5199\u5165\nassign mepc_nxt[ 0 ] = 1'b0; // mepc\u7684\u5730\u5740\u81f3\u5c11\u8981\u4ee52\u5b57\u8282\u5bf9\u9f50\uff0c\u4e0d\u7136\u53ef\u80fd\u4f1a\u751f\u6210\u5730\u5740\u9519\u4f4d\u5f02\u5e38\n\nfii_dfflr #( 32 ) epc_dfflr ( mepc_ena, mepc_nxt, mepc_r, sys_clk, rst_n );//\u9501\u5b58\nassign o_mepc = mepc_r;//\u8f93\u51fa\n\n")),(0,i.kt)("h4",{id:"csr_mcause"},"csr_mcause"),(0,i.kt)("p",null,"mcause\u662f\u4e00\u4e2a\u53ef\u8bfb\u53ef\u5199\u7684\u5bc4\u5b58\u5668\uff0c\u8bb0\u5f55\u6700\u8fd1\u4e00\u6b21\u8fdb\u5165\u5f02\u5e38\u6216\u8005\u4e2d\u65ad\u65f6\u95f4\u7684\u539f\u56e0\uff0c\u4ee5\u8bb0\u5f55\u53f7(\u5f02\u5e38\u4ee3\u7801)\u7684\u65b9\u5f0f\u670d\u52a1\u4e8e\u4e2d\u65ad\u6216\u5f02\u5e38\u5b50\u7a0b\u5e8f\u3002\u5176\u5177\u4f53\u503c\u7684\u5b9a\u4e49\u53ef\u53c2\u89c1",(0,i.kt)("a",{parentName:"p",href:"https://www.icfedu.cn/archives/6318"},"RISC-V CSR\u5bc4\u5b58\u5668\uff082\uff09CSR\u5bc4\u5b58\u5668"),"\u4e2d\u7684\u56fe8\u3002"),(0,i.kt)("p",null,"mcause\u4e5f\u4f1a\u4e0emtvec\u914d\u5408\u4f7f\u7528\uff0c\u5982\u679cmtvec\u7684MODE\u4e3a1\uff0c \u90a3\u4e48\u4e2d\u65ad\u7684\u5165\u53e3\u5730\u5740\u5c31\u4f1a\u53d8\u6210BASE + 4 X cause\uff0c\u8fd9\u91cc\u7684cause\u5c31\u662f\u4e2d\u65ad\u7684\u5f02\u5e38\u4ee3\u7801(",(0,i.kt)("strong",{parentName:"p"},"\u5f02\u5e38\u53d1\u751f\u65f6\uff0c\u4e2d\u65ad\u5165\u53e3\u5730\u5740\u4f9d\u7136\u662f\u57fa\u5730\u5740"),")\u3002\u5b9e\u73b0mcause\u5bc4\u5b58\u5668\u7684\u90e8\u5206\u91cd\u8981\u4ee3\u7801\u5982\u4e0b(\u4e0e\u524d\u9762\u6a21\u5757\u4e2d\u91cd\u590d\u7684\u4ee3\u7801\u7701\u7565)\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"input i_irq_src,//\u4e2d\u65ad\u6e90\ninput i_mie,//\u4e2d\u65ad\u5168\u5c40\u4f7f\u80fd\n\ninput i_meie,//\u673a\u5668\u6a21\u5f0f\u4e0b\u5916\u90e8\u4e2d\u65ad\u4f7f\u80fd\ninput i_mtie,//\u673a\u5668\u6a21\u5f0f\u4e0b\u8ba1\u65f6\u5668\u4e2d\u65ad\u4f7f\u80fd\ninput i_msie,//\u673a\u5668\u6a21\u5f0f\u4e0b\u8f6f\u4ef6\u4e2d\u65ad\u4f7f\u80fd\n\ninput i_sft_irq,//\u8f6f\u4ef6\u4e2d\u65ad\u8bf7\u6c42\ninput i_tmr_irq,//\u8ba1\u65f6\u5668\u4e2d\u65ad\u8bf7\u6c42\ninput i_ext_irq,//\u5916\u90e8\u4e2d\u65ad\u8bf7\u6c42\n\ninput i_EXE_vld,//\u662f\u5426\u4e3a\u6267\u884c\u9636\u6bb5\n\ninput i_exp_src,//\u5f02\u5e38\u6e90\n//\u4e0b\u9762\u662f\u4e00\u4e9b\u5f02\u5e38\uff0c\u76ee\u524d\u6ca1\u6709\u5b9e\u73b0\uff0c\u5728\u5916\u5c42csr_reg\u6a21\u5757\u4e2d\u786c\u8fde\u7ebf\u52300\u3002\ninput i_iam_exp,\ninput i_iaf_exp,\ninput i_illi_exp,\ninput i_bp_exp,\ninput i_mti_exp,\ninput i_lam_exp,\ninput i_laf_exp,\ninput i_saam_exp,\ninput i_saaf_exp,\n\noutput [ 31: 0 ] o_mcause,//\u8f93\u51famcause\n\n\n\nwire m_is = i_mie & i_msie & i_sft_irq;//\u8f6f\u4ef6\u4e2d\u65ad\nwire m_it = i_mie & i_mtie & i_tmr_irq;//\u8ba1\u65f6\u5668\u4e2d\u65ad\nwire m_ie = i_mie & i_meie & i_ext_irq;//\u5916\u90e8\u4e2d\u65ad\n\n//=============================\u5f02\u5e38\u548c\u4e2d\u65ad==================================================\nwire [31:0] exp_mcause;\n//\u53d1\u751f\u5f02\u5e38\u65f6\uff0cmcause\u6700\u9ad8\u4f4d\u662f0\nassign exp_mcause[31:5] = 27'b0;\n//\u6839\u636e\u5f02\u5e38\u7684\u79cd\u7c7b\uff0c\u7f6e\u76f8\u5e94\u7684\u4f4d\nassign exp_mcause[4:0] = \n                         i_iam_exp  ? 5'd0 //Instruction address misaligned\n                       : i_iaf_exp  ? 5'd1 //Instruction access fault\n                       : i_illi_exp ? 5'd2 //Illegal instruction\n                       : i_bp_exp   ? 5'd3 //Breakpoint\n                       : i_lam_exp  ? 5'd4 //load address misalign\n                       : i_laf_exp  ? 5'd5 //load access fault\n                       : i_saam_exp ? 5'd6 //Store/AMO address misalign\n                       : i_saaf_exp ? 5'd7 //Store/AMO access fault\n                       : 5'h1F; //Otherwise a reserved value\n\n\nwire [31:0] irq_mcause;\n//\u53d1\u751f\u4e2d\u65ad\u65f6\uff0cmcause\u6700\u9ad8\u4f4d\u662f1\nassign irq_mcause[31] = 1'b1;\nassign irq_mcause[30:4] = 27'b0;\n//\u6839\u636e\u4e2d\u65ad\u7684\u79cd\u7c7b\uff0c\u7f6e\u76f8\u5e94\u7684\u4f4d\nassign irq_mcause[3:0] = m_is ? 4'd3 : // 3 Machine software interrupt\n                         m_it ? 4'd7 : // 7 Machine timer interrupt\n                         m_ie ? 4'd11 : // 11 Machine external interrupt\n                         4'b0;\n\nwire [31:0] mcause_val = i_irq_src ? irq_mcause : exp_mcause;//\u5224\u65ad\u4e2d\u65ad\u8fd8\u662f\u5f02\u5e38\n//===============================================================================\nwire mcause_valid = (i_irq_src | i_exp_src) ? 1'b1 : 1'b0;//\u4e2d\u65ad/\u5f02\u5e38\u662f\u5426\u53d1\u751f\n\nwire sel_mcause = (i_csr_addr == 12'h342);//\u901a\u8fc7\u5730\u5740\u7d22\u5f15\u786e\u8ba4\u5bc4\u5b58\u5668\n\nwire [31:0] mcause_r;\nwire [31:0] mcause_nxt = mcause_valid ? mcause_val : i_csr_val;//\u5982\u679c\u4e2d\u65ad/\u5f02\u5e38\u53d1\u751f\uff0c mcause\u88ab\u8d4b\u503c\u6210\u4e2d\u65ad/\u5f02\u5e38\u7684\u539f\u56e0\uff0c\u5426\u5219\u88abCSR\u6307\u4ee4\u5199\u5165\n\nfii_dfflr #(32) mcause_dfflr (mcause_ena, mcause_nxt, mcause_r, sys_clk, rst_n);//\u9501\u5b58\n\nassign o_mcause = mcause_r;//\u8f93\u51fa\n\n")),(0,i.kt)("h4",{id:"csr_mie"},"csr_mie"),(0,i.kt)("p",null,"mie\u5bc4\u5b58\u5668\u662f\u53ef\u8bfb\u53ef\u5199\u7684\uff0c\u7528\u4e8e\u8fdb\u4e00\u6b65\u5bf9\u4e0d\u540c\u4e2d\u65ad\u7684\u5206\u522b\u4f7f\u80fd\u63a7\u5236\uff0c\u6ce8\u610f\u5c06\u5176\u4e0emstatus\u7684\u4f4dMIE\u5206\u5f00\u3002\u5b9e\u73b0mie\u5bc4\u5b58\u5668\u7684\u90e8\u5206\u91cd\u8981\u4ee3\u7801\u5982\u4e0b(\u4e0e\u524d\u9762\u6a21\u5757\u4e2d\u91cd\u590d\u7684\u4ee3\u7801\u7701\u7565)\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"output [ 31: 0 ] o_mie,//\u8f93\u51famie\noutput o_meie,//\u8f93\u51fa\u673a\u5668\u6a21\u5f0f\u4e0b\u5916\u90e8\u4e2d\u65ad\u4f7f\u80fd\noutput o_msie,//\u8f93\u51fa\u673a\u5668\u6a21\u5f0f\u4e0b\u8f6f\u4ef6\u4e2d\u65ad\u4f7f\u80fd\noutput o_mtie,//\u8f93\u51fa\u673a\u5668\u6a21\u5f0f\u4e0b\u8ba1\u65f6\u5668\u4e2d\u65ad\u4f7f\u80fd\n\n\nwire sel_mie = ( i_csr_addr == 12'h304 );//\u901a\u8fc7\u5730\u5740\u7d22\u5f15\u786e\u8ba4\u5bc4\u5b58\u5668\n\nwire [ 31: 0 ] mie_r;\nwire [ 31: 0 ] mie_nxt;\n\nassign mie_nxt[ 31: 12 ] = 20'b0;//\u5c06\u5176\u4ed6\u7684\u4f4d\u786c\u8fde\u7ebf\u52300\nassign mie_nxt[ 11 ]     = i_csr_val[ 11 ]; //o_meie\nassign mie_nxt[ 10: 8 ]  = 3'b0;\nassign mie_nxt[ 7 ]      = i_csr_val[ 7 ]; //o_mtie\nassign mie_nxt[ 6: 4 ]   = 3'b0;\nassign mie_nxt[ 3 ]      = i_csr_val[ 3 ]; //o_msie\nassign mie_nxt[ 2: 0 ]   = 3'b0;\n\nfii_dfflr #( 32 ) mie_dfflr ( mie_ena, mie_nxt, mie_r, sys_clk, rst_n );//\u9501\u5b58\n\n\nassign o_mie = mie_r;//\u8f93\u51fa\n\n//\u5355\u72ec\u5c06\u91cd\u8981\u7684\u4e2d\u65ad\u4f7f\u80fd\u4f4d\u8f93\u51fa\nassign o_meie = o_mie[ 11 ];\nassign o_mtie = o_mie[ 7 ];\nassign o_msie = o_mie[ 3 ];\n\n")),(0,i.kt)("h4",{id:"csr_mip"},"csr_mip"),(0,i.kt)("p",null,"mip\u662f\u4e2d\u65ad\u60ac\u6302\u5bc4\u5b58\u5668\uff0c\u5f53\u4e2d\u65ad\u8bf7\u6c42\u5230\u6765\u65f6\uff0cmip\u76f8\u5e94\u7684\u4f4d\u5c31\u4f1a\u88ab\u7f6e\u9ad8\u3002"),(0,i.kt)("p",null,"mip\u5bc4\u5b58\u5668\u867d\u7136\u5b9a\u4e49\u4e0a\u662f\u53ef\u8bfb\u53ef\u5199\u7684\uff0c\u4f46\u5728\u8fd9\u91cc\u4f7f\u7528\u7684MEIP\uff0cMSIP\u548cMTIP\u90fd\u662f\u53ea\u8bfb\u7684\u3002\u5b9e\u73b0mip\u5bc4\u5b58\u5668\u7684\u90e8\u5206\u91cd\u8981\u4ee3\u7801\u5982\u4e0b(\u4e0e\u524d\u9762\u6a21\u5757\u4e2d\u91cd\u590d\u7684\u4ee3\u7801\u7701\u7565)\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"input i_sft_irq,//\u8f6f\u4ef6\u4e2d\u65ad\u8bf7\u6c42\ninput i_tmr_irq,//\u8ba1\u65f6\u5668\u4e2d\u65ad\u8bf7\u6c42\ninput i_ext_irq,//\u5916\u90e8\u4e2d\u65ad\u8bf7\u6c42\n\n\noutput [ 31: 0 ] o_mip,//\u8f93\u51famip\n\n\nwire sel_mip = ( i_csr_addr == 12'h344 );//\u901a\u8fc7\u5730\u5740\u7d22\u5f15\u786e\u8ba4\u5bc4\u5b58\u5668\n\n\nwire meip_r;\nwire msip_r;\nwire mtip_r;\n\n//\u53ea\u8981\u6709\u4e2d\u65ad\u8bf7\u6c42\uff0c\u76f8\u5e94\u7684\u4e2d\u65ad\u60ac\u6302\u4f4d\u5c31\u4f1a\u7f6e\u8d77\u6765\nassign meip_r = i_ext_irq;\nassign msip_r = i_sft_irq;\nassign mtip_r = i_tmr_irq;\n\n//\u5c06mip\u4e2d\u7684\u4f4d\u5206\u522b\u8d4b\u503c\u3002\nwire [ 31: 0 ] ip_r;\nassign ip_r[ 31: 12 ] = 20'b0;\nassign ip_r[ 11 ]     = meip_r;\nassign ip_r[ 10: 8 ]  = 3'b0;\nassign ip_r[ 7 ]      = mtip_r;\nassign ip_r[ 6: 4 ]   = 3'b0;\nassign ip_r[ 3 ]      = msip_r;\nassign ip_r[ 2: 0 ]   = 3'b0;\n\nassign o_mip = ip_r;//\u8f93\u51fa\n")),(0,i.kt)("h4",{id:"csr_misa"},"csr_misa"),(0,i.kt)("p",null,"misa\u5bc4\u5b58\u5668\u53ef\u8bfb\u53ef\u5199\uff0c\u5b58\u50a8RISC-V CPU\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\u67b6\u6784\u548c\u652f\u6301\u7684\u57fa\u672c/\u538b\u7f29\u6307\u4ee4\u96c6\u3002\u5b9e\u73b0misa\u5bc4\u5b58\u5668\u7684\u90e8\u5206\u91cd\u8981\u4ee3\u7801\u5982\u4e0b(\u4e0e\u4e0a\u6587\u91cd\u590d\u7684\u4ee3\u7801\u7701\u7565)\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"output [31:0] o_misa//\u8f93\u51famisa\u5bc4\u5b58\u5668\n\n\nassign o_misa = {\n2'b1 // \u6700\u9ad8\u4e24\u4f4d\u4e3a2b'01\u8868\u793a\u4e3a32\u4f4d\u67b6\u6784\n,4'b0 // WIRI\n,1'b0 // 25 Z Reserved\n,1'b0 // 24 Y Reserved\n,1'b0 // 23 X Non-standard extensions present\n,1'b0 // 22 W Reserved\n,1'b0 // 21 V Tentatively reserved for Vector extension 20 U User mode implemented\n,1'b0 // 20 U User mode implemented\n,1'b0 // 19 T Tentatively reserved for Transactional Memory extension\n,1'b0 // 18 S Supervisor mode implemented\n,1'b0 // 17 R Reserved\n,1'b0 // 16 Q Quad-precision floating-point extension\n,1'b0 // 15 P Tentatively reserved for Packed-SIMD extension\n,1'b0 // 14 O Reserved\n,1'b0 // 13 N User-level interrupts supported\n,1'b0 // 12 M Integer Multiply/Divide extension\n,1'b0 // 11 L Tentatively reserved for Decimal Floating-Point extension\n,1'b0 // 10 K Reserved\n,1'b0 // 9 J Reserved\n,1'b1 // <= 8 I RV32I/64I/128I base ISA//\u76ee\u524d\u5b9e\u73b0\u7684\u57fa\u672c\u6307\u4ee4\u96c6\u662fRV32I\uff0c32\u4f4d\u6574\u578b\u7684\u6307\u4ee4\u96c6\n,1'b0 // 7 H Hypervisor mode implemented\n,1'b0 // 6 G Additional standard extensions present\n,1'b0 // 5 F Single-precision floating-point extension\n,1'b0 // 4 E RV32E base ISA \n,1'b0 // 3 D Double-precision floating-point extension\n,1'b0 // 2 C Compressed extension\n,1'b0 // 1 B Tentatively reserved for Bit operations extension\n,1'b0 // 0 A Atomic extension\n};\n\n")),(0,i.kt)("h4",{id:"csr_mcounteren"},"csr_mcounteren"),(0,i.kt)("p",null,"mcounteren\u5bc4\u5b58\u5668\u662f\u53ef\u8bfb\u53ef\u5199\u7684\uff0c\u6bcf\u4e00\u4f4d\u5206\u522b\u5bf9\u5e94\u4e00\u7ec4\u8ba1\u6570\u5668\uff0c\u65e0\u8bbaCSR\u6307\u4ee4\u5199\u5165\u4ec0\u4e48\u503c\uff0c\u76f8\u5e94\u7684\u8ba1\u6570\u5668\u4e0d\u53d7\u5f71\u54cd\u3002mcounteren\u63a7\u5236\u7684\u662f\u4e0b\u4e00\u4e2a\u7279\u6743\u7ea7\u522b\u662f\u5426\u80fd\u8bfb\u51fa\u76f8\u5e94\u7684\u8ba1\u6570\u5668\uff0c\u5982\u679c\u76f8\u5e94\u7684\u4f4d\u4e3a0\uff0c\u5219\u5c1d\u8bd5\u8bfb\u51fa\u8ba1\u6570\u5668\u4f1a\u5f15\u8d77\u975e\u6cd5\u6307\u4ee4\u5f02\u5e38\u3002\u5982\u4e0b\u56fe\u6240\u793a\u3002"),(0,i.kt)("p",null,"\u56e0\u4e3a\u8fd9\u91cc\u53ea\u5b9e\u73b0\u4e86\u673a\u5668\u6a21\u5f0f\uff0c\u6240\u4ee5\u6ca1\u6709\u7528mcounteren\u3002\u8fd9\u91cc\u53ea\u5b9e\u73b0\u4e86mcounteren\u7684\u8bfb\u5199\u3002\u5b9e\u73b0mcounteren\u5bc4\u5b58\u5668\u7684\u90e8\u5206\u91cd\u8981\u4ee3\u7801\u5982\u4e0b(\u4e0e\u4e0a\u6587\u91cd\u590d\u7684\u4ee3\u7801\u7701\u7565)\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"output [ 31: 0 ] o_mcounteren,//\u8f93\u51famcounteren\n\n\nwire mcounteren_ena = (i_csr_wen & (i_csr_addr == 12'h306));//\u901a\u8fc7\u5730\u5740\u7d22\u5f15\u786e\u8ba4\u5bc4\u5b58\u5668\nwire [31:0] mcounteren_r;\nwire [31:0] mcounteren_nxt = i_csr_val;\n\nfii_dfflr #(32) mtvec_dfflr (mcounteren_ena, mcounteren_nxt, mcounteren_r, sys_clk, rst_n);//\u9501\u5b58\n\nassign o_mcounteren = mcounteren_r;//\u8f93\u51fa\n\n")),(0,i.kt)("h4",{id:"csr_mid"},"csr_mid"),(0,i.kt)("p",null,"csr_mid\u6a21\u5757\u4e2d\u7ec4\u5408\u4e86\u5f88\u591a\u548cID\u76f8\u5173\u7684\u5bc4\u5b58\u5668\uff0c\u6709mvendorid\uff0cmarchid\uff0cmimpid\u548cmhartid\u3002\u8fd9\u56db\u4e2a\u5bc4\u5b58\u5668\u90fd\u662f\u53ea\u8bfb\u7684\u3002\u5bc4\u5b58\u5668\u7684\u5177\u4f53\u542b\u4e49\u53c2\u8003",(0,i.kt)("a",{parentName:"p",href:"https://www.icfedu.cn/archives/6318"},"RISC-V CSR\u5bc4\u5b58\u5668\uff082\uff09CSR\u5bc4\u5b58\u5668"),"\u4e2d\u7684",(0,i.kt)("strong",{parentName:"p"},"1.7-1.10"),"\u3002\u5bc4\u5b58\u5668\u5b9e\u73b0\u7684\u90e8\u5206\u91cd\u8981\u4ee3\u7801\u5982\u4e0b(\u4e0e\u4e0a\u6587\u91cd\u590d\u7684\u4ee3\u7801\u7701\u7565)\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"output [31:0] o_mvendorid, //\u8f93\u51famvendorid\noutput [31:0] o_marchid,   //\u8f93\u51famarchid\noutput [31:0] o_mimpid,    //\u8f93\u51famimpid\noutput [31:0] o_mhartid    //\u8f93\u51famhartid\n\n//\u4ee5\u4e0b\u7684\u4e09\u4e2aID\u6ca1\u6709\u5b8c\u5168\u5b9e\u73b0\nassign o_mvendorid = 32'b0;\nassign o_marchid   = 32'b0;\nassign o_mimpid    = 32'b0;\nassign o_mhartid   = 32'b0;//hart ID\u4e3a0\u8868\u793aCPU\u662f\u5355\u6838\n")),(0,i.kt)("h4",{id:"csr_scratch"},"csr_scratch"),(0,i.kt)("p",null,"mscratch\u5bc4\u5b58\u5668\u662f\u673a\u5668\u6a21\u5f0f\u4e0b\u53ef\u8bfb\u53ef\u5199\uff0c\u6ca1\u6709\u6307\u5b9a\u7684\u7528\u6cd5\u3002\u5b9e\u73b0mscratch\u5bc4\u5b58\u5668\u7684\u90e8\u5206\u91cd\u8981\u4ee3\u7801\u5982\u4e0b(\u4e0e\u4e0a\u6587\u91cd\u590d\u7684\u4ee3\u7801\u7701\u7565)\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"output [ 31: 0 ] o_mscratch, //\u8f93\u51famscratch\n\nwire mscratch_ena = (i_csr_wen & (i_csr_addr == 12'h340)); //\u901a\u8fc7\u5730\u5740\u7d22\u5f15\u786e\u8ba4\u5bc4\u5b58\u5668\nwire [31:0] mscratch_r;\nwire [31:0] mscratch_nxt = i_csr_val;\n\nfii_dfflr #(32) mtvec_dfflr (mscratch_ena, mscratch_nxt, mscratch_r, sys_clk, rst_n);//\u9501\u5b58\n\nassign o_mscratch = mscratch_r;//\u8f93\u51fa\n")),(0,i.kt)("h4",{id:"csr_mcycle"},"csr_mcycle"),(0,i.kt)("p",null,"csr_mcylce\u6a21\u5757\u5305\u62ecmcycle\u548cmcycleh\u4e24\u4e2a\u5bc4\u5b58\u5668\uff0c\u7528\u4e8e\u8ba1\u6570\u8fc7\u4e86\u591a\u5c11\u4e2a\u65f6\u949f\u5468\u671f\u3002\u4e24\u4e2a32\u4f4d\u8ba1\u6570\u5668\u7ec4\u6210\u4e00\u4e2a64\u4f4d\u7684\u8ba1\u6570\u5668\u3002\u5b9e\u73b0\u8ba1\u6570\u5668\u7684\u90e8\u5206\u91cd\u8981\u4ee3\u7801\u5982\u4e0b(\u4e0e\u4e0a\u6587\u91cd\u590d\u7684\u4ee3\u7801\u7701\u7565)\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"//\u8c03\u8bd5\u76f8\u5173\u4fe1\u53f7\ninput i_dbg_mode,\ninput i_dbg_stpcyl,\n\n\noutput reg [ 31: 0 ] o_mcycle_l,//\u8f93\u51famcycle\u5bc4\u5b58\u5668\uff0c\u4f4e32\u4f4d\noutput reg [ 31: 0 ] o_mcycle_h,//\u8f93\u51famcycleh\u5bc4\u5b58\u5668\uff0c\u9ad832\u4f4d\n\n\nwire dbg_stop = i_dbg_mode & i_dbg_stpcyl;//\u8c03\u8bd5\u5f00\u59cb\n\nalways@( posedge sys_clk or negedge rst_n )\nif ( !rst_n )//\u5982\u679c\u6ca1\u6709\u590d\u4f4d\nbegin\n    o_mcycle_l <= 32'b0;\n    o_mcycle_h <= 32'b0;\nend\nelse if ( i_csr_wen )//CSR\u5bc4\u5b58\u5668\u53ef\u5199\nbegin\n    case ( i_csr_addr )//CSR\u6307\u4ee4\u5199\u5165\uff0c\u6839\u636e\u5730\u5740\u7d22\u5f15\u5230\u4f4e\u4f4d/\u9ad8\u4f4d\u5bc4\u5b58\u5668\n    12'hb00: o_mcycle_l <= i_csr_val;\n    12'hb80: o_mcycle_h <= i_csr_val;\n    default: ;\n    endcase\nend\nelse\nbegin\n    if ( !dbg_stop )//\u5982\u679c\u4e0d\u5904\u4e8e\u8c03\u8bd5\n    begin\n        if ( o_mcycle_l == 32'hffff_ffff )//\u5982\u679c\u4f4e32\u4f4d\u5bc4\u5b58\u5668\u5df2\u6ee1\n        begin\n            o_mcycle_h <= o_mcycle_h + 1;//\u9ad8\u4f4d\u8fdb\u4f4d\n            o_mcycle_l <= 0;\n        end\n        else\n            o_mcycle_l <= o_mcycle_l + 1;//\u4f4e32\u4f4d\u7684\u5bc4\u5b58\u5668\u52a01\n    end\nend\n\n")),(0,i.kt)("h4",{id:"csr_minstret"},"csr_minstret"),(0,i.kt)("p",null,"csr_minstret\u6a21\u5757\u4e0e\u4e0a\u9762\u7684csr_mcycle\u6a21\u5757\u7c7b\u4f3c\uff0c\u5305\u62ecminstret\u548cminstreth\u4e24\u4e2a32\u4f4d\u5bc4\u5b58\u5668\uff0c\u7528\u6765\u7ec4\u6210\u4e00\u4e2a64\u4f4d\u5bc4\u5b58\u5668\u3002minstret\u548cminstreth\u4e3b\u8981\u7528\u6765\u8ba1\u6570\u5df2\u7ecf\u6267\u884c\u8fc7\u7684\u6307\u4ee4\u3002\u5b9e\u73b0\u5bc4\u5b58\u5668\u7684\u90e8\u5206\u91cd\u8981\u4ee3\u7801\u5982\u4e0b(\u4e0e\u4e0a\u6587\u91cd\u590d\u7684\u4ee3\u7801\u7701\u7565)\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-verilog"},"input i_EXE_vld,//\u5224\u65ad\u662f\u5426\u5904\u5728\u6267\u884c\u9636\u6bb5\n\n//\u8c03\u8bd5\u76f8\u5173\u4fe1\u53f7\ninput i_dbg_mode,\ninput i_dbg_stpcyl,\n\n\noutput reg [ 31: 0 ] o_minstret_l,//\u8f93\u51famintret\u5bc4\u5b58\u5668\uff0c\u4f4e32\u4f4d\noutput reg [ 31: 0 ] o_minstret_h,//\u8f93\u51faminstreth\u5bc4\u5b58\u5668\uff0c\u9ad832\u4f4d\n\n\nwire dbg_stop = i_dbg_mode & i_dbg_stpcyl;//\u8c03\u8bd5\u5f00\u59cb\nalways@( posedge sys_clk or negedge rst_n )\nif ( !rst_n )//\u5982\u679c\u6ca1\u6709\u590d\u4f4d\nbegin\n    o_minstret_l <= 32'b0;\n    o_minstret_h <= 32'b0;\nend\nelse if ( i_csr_wen )//CSR\u5bc4\u5b58\u5668\u53ef\u5199\nbegin\n    case ( i_csr_addr )//CSR\u6307\u4ee4\u5199\u5165\uff0c\u6839\u636e\u5730\u5740\u7d22\u5f15\u5230\u4f4e\u4f4d/\u9ad8\u4f4d\u5bc4\u5b58\u5668\n    12'hb02: o_minstret_l <= i_csr_val;\n    12'hb82: o_minstret_h <= i_csr_val;\n    default: ;\n    endcase\nend\nelse if ( ( i_EXE_vld ) && ( dbg_stop == 1'b0 ) )//\u5982\u679c\u4e0d\u5904\u4e8e\u8c03\u8bd5\uff0c\u4e14\u5728\u6267\u884c\u9636\u6bb5\nbegin\n    if ( o_minstret_l == 32'hffff_ffff )//\u5982\u679c\u4f4e32\u4f4d\u5bc4\u5b58\u5668\u5df2\u6ee1\n    begin\n        o_minstret_l <= 0;\n        o_minstret_h <= o_minstret_h + 1;//\u9ad8\u4f4d\u8fdb\u4f4d\n    end\n    else\n        o_minstret_l <= o_minstret_l + 1;//\u4f4e32\u4f4d\u7684\u5bc4\u5b58\u5668\u52a01\nend\n\n")))}p.isMDXComponent=!0},65168:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/102-a95c64cc7f84adfce4a14e07c038942e.jpeg"},45798:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/103-46f9777eb1f237a8f3476b6173fe2af3.jpeg"},27441:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/104-db77e24c6ec9244f044a26a42806c94a.jpeg"},27365:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/105-a3e889301591cbcafef304999d9b4abc.jpeg"}}]);